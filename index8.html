<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Pelatih Membaca (JP)</title>
    <meta name="description" content="Latih kemampuan membaca hiragana, katakana, dan kanji dengan filter subset kana." />
    <meta name="theme-color" content="#1a1a1a">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* CSS Variabel (konsisten dengan index7.html) */
        :root {
            --bg: #1a1a1a;
            --panel: #2a2a2a;
            --text: #e0e0e0;
            --muted: #a0a0a0;
            --border: rgba(255, 255, 255, 0.1);
            --primary: #6b8bff;
            --secondary: #3dd8b5;
            --success: #2fb875;
            --warning: #ff7b7b;
            --radius: 12px;
            --space: 12px;
            --maxw: 760px; /* Target HP 720p */
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
            --transition-duration: 0.2s;
        }

        /* Base Styles (konsisten dengan index7.html) */
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease;
        }

        .container {
            width: 100%;
            max-width: var(--maxw);
            margin-inline: auto;
            padding: clamp(var(--space), 4vw, 24px);
            display: flex;
            flex-direction: column;
            gap: var(--space);
        }

        @media (min-width: 860px) {
            .container {
                max-width: 1100px; /* Lebar lebih besar untuk desktop */
            }
        }

        .card {
            background: var(--panel);
            border-radius: var(--radius);
            padding: clamp(var(--space), 3vw, 20px);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: background-color var(--transition-duration) ease, border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
        }

        h1 {
            font-size: clamp(24px, 6vw, 32px);
            margin: 0 0 8px;
            text-align: center;
        }

        .subtitle {
            font-size: clamp(14px, 3vw, 16px);
            color: var(--muted);
            text-align: center;
            margin-bottom: var(--space);
        }

        .btn {
            min-height: 48px; /* Ramah jempol */
            padding: 0 16px;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: 500;
            transition: all var(--transition-duration) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            flex-grow: 1;
        }
        .btn.primary {
            background: var(--primary);
            color: #fff;
        }
        .btn.secondary {
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn:hover:not(:disabled) {
            opacity: 0.9;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }
        .text-center {
            text-align: center;
        }
        .spacer {
            height: var(--space);
        }

        /* Toast Message (konsisten dengan index7.html) */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            max-width: calc(100% - 40px);
            text-align: center;
        }
        .toast.show {
            opacity: 1;
        }
        .toast.warn {
            background-color: var(--warning);
            color: #333;
        }

        /* === Sidebar === (konsisten dengan index7.html) */
        .sidebar{
            position:fixed; top:0; left:-300px; width:280px; height:100%;
            background:var(--panel); box-shadow:var(--shadow); z-index:1000;
            transition:left .3s ease-in-out; padding:20px; padding-top:calc(20px + env(safe-area-inset-top));
            display:flex; flex-direction:column; gap:10px; overflow-y:auto; border-right:1px solid var(--border);
        }
        .sidebar.is-open{ left:0; }
        .sidebar .menu{ list-style:none; margin:0; padding:0; }
        .sidebar .menu li a{ display:flex; gap:.5rem; align-items:center; padding:.75rem 1rem; border-radius:12px; color:var(--text); text-decoration:none; }
        .sidebar .menu li a:hover{ background: rgba(255, 255, 255, 0.08); }
        .sidebar .menu li a.active{ background:rgba(107,139,255,.18); font-weight:600; }
        .sidebar-toggle-btn{
            position:fixed; top:16px; left:16px; z-index:1001; background:var(--panel); border:1px solid var(--border);
            border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow);
        }
        .sidebar-toggle-btn i{ color:var(--text); font-size:20px; }
        @media (min-width:768px){ body.sidebar-open{ padding-left:280px; } }
        @media (max-width:640px){ .sidebar{ width:84vw; max-width:320px; } }
        /* Biar header gak ketutup tombol */
        header .brand{ position:relative; z-index:1002; padding-left:60px; }
        @media (max-width:767px){
            header .brand{ padding-left:0; }
            .sidebar-toggle-btn{ top:calc(16px + env(safe-area-inset-top)); }
        }

        /* --- Reading Trainer Specific Styles (rdg-) --- */
        .rdg-control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: var(--space);
        }

        .rdg-control-group label {
            font-size: clamp(14px, 3.5vw, 16px);
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rdg-control-group input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
            transition: background 0.2s ease;
        }
        .rdg-control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(107, 139, 255, 0.2);
        }
        .rdg-control-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(107, 139, 255, 0.2);
        }
        .rdg-control-group input[type="number"] {
            width: 60px;
            height: 36px;
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: clamp(14px, 3.5vw, 16px);
            text-align: center;
            -moz-appearance: textfield;
        }
        .rdg-control-group input[type="number"]::-webkit-outer-spin-button,
        .rdg-control-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .rdg-output-area {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            min-height: 200px;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: clamp(16px, 4vw, 20px);
            line-height: 1.8;
            word-break: break-word;
            white-space: pre-wrap;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Script Selector */
        .rdg-script-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: var(--space);
        }
        .rdg-script-selector button {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--panel);
            color: var(--text);
            cursor: pointer;
            transition: all var(--transition-duration) ease;
        }
        .rdg-script-selector button.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }
        .rdg-script-selector button:hover {
            opacity: 0.9;
        }

        /* Subset Checkboxes */
        .rdg-subset-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: var(--space);
        }
        .rdg-subset-controls .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        .rdg-subset-controls input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg);
            appearance: none;
            -webkit-appearance: none;
            display: grid;
            place-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .rdg-subset-controls input[type="checkbox"]::before {
            content: "\f00c"; /* Font Awesome check icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 14px;
            color: #fff;
            transform: scale(0);
            transition: transform 0.1s ease-in-out;
        }
        .rdg-subset-controls input[type="checkbox"]:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        .rdg-subset-controls input[type="checkbox"]:checked::before {
            transform: scale(1);
        }
        .rdg-subset-controls input[type="checkbox"]:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .rdg-slider-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            color: var(--muted);
            font-size: clamp(12px, 3vw, 14px);
        }
        .rdg-slider-control span {
            min-width: 30px; /* Lebar minimum untuk persentase */
            text-align: right;
        }

        /* Tooltip */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-icon {
            color: var(--muted);
            font-size: 0.9em;
            margin-left: 4px;
            cursor: help;
        }
        .tooltip-text {
            visibility: hidden;
            background-color: rgba(0,0,0,0.85);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Atas elemen */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            font-size: 0.8em;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0,0,0,0.85) transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .rdg-action-buttons {
            display: flex;
            gap: var(--space);
            margin-top: var(--space);
            flex-wrap: wrap;
        }

        /* Preset Buttons */
        .rdg-preset-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: var(--space);
            flex-wrap: wrap;
        }
        .rdg-preset-buttons .btn {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <!-- Toggle Button -->
    <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle Sidebar">
      <i class="fa-solid fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h3 style="margin:0;">Navigasi</h3>
        <button class="btn secondary" id="closeSidebar" aria-label="Tutup Sidebar">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <hr style="border:none;border-top:1px solid var(--border);width:100%;">
      <ul class="menu">
        <li><a href="index.html">ÔøΩ Latihan</a></li>
        <li><a href="index2.html">üóÇÔ∏è Flashcard</a></li>
        <li><a href="index3.html">üßÆ Tabel Kana</a></li>
        <li><a href="index4.html">üóíÔ∏è Kosakata</a></li>
        <li><a href="index5.html">üí¨ Ungkapan</a></li>
        <li><a href="index7.html">üß† Tebak Arti</a></li>
        <li><a href="index6.html">‚úçÔ∏è Menulis</a></li>
        <li><a href="index8.html" class="active">üìö Pelatih Membaca</a></li> <!-- New: Reading Trainer -->
      </ul>
    </nav>

    <div class="container">
        <header class="card">
            <h1>Pelatih Membaca Bahasa Jepang</h1>
            <p class="subtitle">Hasilkan teks Hiragana, Katakana, atau Kanji dengan filter karakter.</p>
        </header>

        <section class="card">
            <h2>Pengaturan Teks</h2>

            <div class="rdg-control-group">
                <h3>Preset Cepat</h3>
                <div class="rdg-preset-buttons">
                    <button class="btn secondary" data-preset="beginner">Pemula</button>
                    <button class="btn secondary" data-preset="intermediate">Menengah</button>
                    <button class="btn secondary" data-preset="advanced">Lanjutan</button>
                </div>
            </div>
            
            <div class="rdg-control-group">
                <label for="rdg-script-select">Pilih Skrip:</label>
                <div id="rdg-script-selector" class="rdg-script-selector">
                    <button data-script="hiragana">Hiragana</button>
                    <button data-script="katakana">Katakana</button>
                    <button data-script="mixed">Campuran</button>
                    <button data-script="furigana">Kanji + Furigana</button>
                </div>
            </div>

            <div class="rdg-control-group">
                <h3>Filter Subset Kana</h3>
                <div class="rdg-subset-controls">
                    <label class="checkbox-item tooltip-container">
                        <input type="checkbox" id="rdg-subset-gojuon" checked data-subset="gojuon">
                        Dasar (goj≈´on)
                        <i class="fa-solid fa-circle-question tooltip-icon"></i>
                        <span class="tooltip-text">Hiragana/Katakana dasar (a, ka, sa, ta, na, ha, ma, ya, ra, wa, n).</span>
                    </label>
                    <label class="checkbox-item tooltip-container">
                        <input type="checkbox" id="rdg-subset-dakuon" data-subset="dakuon">
                        Dakuon („Åå/„Åñ/„Å†/„Å∞)
                        <i class="fa-solid fa-circle-question tooltip-icon"></i>
                        <span class="tooltip-text">Karakter dengan tanda "dakuten" (ga, za, da, ba, pa, dll.).</span>
                    </label>
                    <label class="checkbox-item tooltip-container">
                        <input type="checkbox" id="rdg-subset-handakuon" data-subset="handakuon">
                        Handakuon („Å±Ë°å)
                        <i class="fa-solid fa-circle-question tooltip-icon"></i>
                        <span class="tooltip-text">Karakter dengan tanda "handakuten" (pa, pi, pu, pe, po).</span>
                    </label>
                    <label class="checkbox-item tooltip-container">
                        <input type="checkbox" id="rdg-subset-youon" data-subset="youon">
                        Youon („Åç„ÇÉ/„Åó„ÇÉ/‚Ä¶)
                        <i class="fa-solid fa-circle-question tooltip-icon"></i>
                        <span class="tooltip-text">Kombinasi karakter (kya, shu, cho, nya, hya, mya, rya, gya, ja, bya, pya, dll.).</span>
                    </label>
                </div>
            </div>

            <div class="rdg-control-group">
                <h3>Pengaturan Lanjutan</h3>
                <div class="rdg-slider-control tooltip-container">
                    <label for="rdg-sokuon-slider">Sokuon „Å£ (frekuensi):</label>
                    <input type="range" id="rdg-sokuon-slider" min="0" max="40" step="5" value="10">
                    <span id="rdg-sokuon-display">10%</span>
                    <i class="fa-solid fa-circle-question tooltip-icon"></i>
                    <span class="tooltip-text">Frekuensi injeksi karakter "„Å£" (tsu kecil) untuk suara ganda.</span>
                </div>
                <div class="rdg-slider-control tooltip-container">
                    <label for="rdg-choon-slider">Ch≈çon „Éº (frekuensi):</label>
                    <input type="range" id="rdg-choon-slider" min="0" max="60" step="5" value="20" disabled>
                    <span id="rdg-choon-display">20%</span>
                    <i class="fa-solid fa-circle-question tooltip-icon"></i>
                    <span class="tooltip-text">Frekuensi injeksi karakter "„Éº" (garis panjang) untuk vokal panjang (khusus Katakana).</span>
                </div>
            </div>

            <div class="rdg-control-group">
                <label for="rdg-paragraph-count">Jumlah Paragraf:</label>
                <input type="number" id="rdg-paragraph-count" min="1" max="10" value="3">
            </div>
            <div class="rdg-control-group">
                <label for="rdg-sentence-per-paragraph">Kalimat per Paragraf:</label>
                <input type="number" id="rdg-sentence-per-paragraph" min="2" max="10" value="4">
            </div>
            <div class="rdg-control-group">
                <label for="rdg-target-length">Panjang Target Kata (per kalimat):</label>
                <input type="number" id="rdg-target-length" min="5" max="20" value="10">
            </div>

            <div class="rdg-action-buttons">
                <button class="btn primary" id="rdg-generate-btn"><i class="fa-solid fa-sync-alt"></i> Hasilkan Teks</button>
                <button class="btn secondary" id="rdg-copy-btn"><i class="fa-solid fa-copy"></i> Salin</button>
                <button class="btn secondary" id="rdg-speak-btn"><i class="fa-solid fa-volume-up"></i> Bicara</button>
            </div>
        </section>

        <section class="card">
            <h2>Hasil Teks</h2>
            <div id="rdg-output" class="rdg-output-area" contenteditable="true">
                <!-- Hasil teks akan muncul di sini -->
                <p>Klik "Hasilkan Teks" untuk memulai!</p>
            </div>
        </section>
    </div>

    <div id="toastMessage" class="toast"></div>

    <script>
        // --- CONSTANTS & DATA ---
        const DICTIONARY = [
            // Contoh kata (N5-ish). Idealnya ini bank kata yang lebih besar dan terstruktur.
            // Format: { j: 'Kanji', k: 'kana' }
            { j: 'Â≠¶Ê†°', k: '„Åå„Å£„Åì„ÅÜ' }, { j: 'ÂÖàÁîü', k: '„Åõ„Çì„Åõ„ÅÑ' }, { j: 'Â≠¶Áîü', k: '„Åå„Åè„Åõ„ÅÑ' },
            { j: 'Êó•Êú¨', k: '„Å´„Åª„Çì' }, { j: 'Êó•Êú¨Ë™û', k: '„Å´„Åª„Çì„Åî' }, { j: 'ÁßÅ', k: '„Çè„Åü„Åó' },
            { j: '„ÅÇ„Å™„Åü', k: '„ÅÇ„Å™„Åü' }, { j: 'È£ü„Åπ„Çã', k: '„Åü„Åπ„Çã' }, { j: 'È£≤„ÇÄ', k: '„ÅÆ„ÇÄ' },
            { j: 'Ë°å„Åè', k: '„ÅÑ„Åè' }, { j: 'Êù•„Çã', k: '„Åè„Çã' }, { j: 'Ë™≠„ÇÄ', k: '„Çà„ÇÄ' },
            { j: 'Êõ∏„Åè', k: '„Åã„Åè' }, { j: 'ËÅû„Åè', k: '„Åç„Åè' }, { j: 'Ë©±„Åô', k: '„ÅØ„Å™„Åô' },
            { j: 'Ë¶ã„Çã', k: '„Åø„Çã' }, { j: 'Ë≤∑„ÅÜ', k: '„Åã„ÅÜ' }, { j: 'Â∞è„Åï„ÅÑ', k: '„Å°„ÅÑ„Åï„ÅÑ' },
            { j: 'Â§ß„Åç„ÅÑ', k: '„Åä„Åä„Åç„ÅÑ' }, { j: 'È´ò„ÅÑ', k: '„Åü„Åã„ÅÑ' }, { j: 'ÂÆâ„ÅÑ', k: '„ÇÑ„Åô„ÅÑ' },
            { j: 'Êñ∞„Åó„ÅÑ', k: '„ÅÇ„Åü„Çâ„Åó„ÅÑ' }, { j: 'Âè§„ÅÑ', k: '„Åµ„Çã„ÅÑ' }, { j: 'Áå´', k: '„Å≠„Åì' },
            { j: 'Áä¨', k: '„ÅÑ„Å¨' }, { j: 'È≠ö', k: '„Åï„Åã„Å™' }, { j: 'È≥•', k: '„Å®„Çä' },
            { j: 'Êú®', k: '„Åç' }, { j: 'Ëä±', k: '„ÅØ„Å™' }, { j: 'Ê∞¥', k: '„Åø„Åö' },
            { j: '„ÅäËå∂', k: '„Åä„Å°„ÇÉ' }, { j: '„ÅîÈ£Ø', k: '„Åî„ÅØ„Çì' }, { j: '„Éë„É≥', k: '„Éë„É≥' },
            { j: 'ÈßÖ', k: '„Åà„Åç' }, { j: 'ÈõªËªä', k: '„Åß„Çì„Åó„ÇÉ' }, { j: 'Ëªä', k: '„Åè„Çã„Åæ' },
            { j: '‰ªä', k: '„ÅÑ„Åæ' }, { j: 'ÊôÇÈñì', k: '„Åò„Åã„Çì' }, { j: 'ÂèãÈÅî', k: '„Å®„ÇÇ„Å†„Å°' },
            { j: 'ÂÆ∂Êóè', k: '„Åã„Åû„Åè' }, { j: 'Áà∂', k: '„Å°„Å°' }, { j: 'ÊØç', k: '„ÅØ„ÅØ' },
            { j: 'ÂÖÑ', k: '„ÅÇ„Å´' }, { j: 'Âßâ', k: '„ÅÇ„Å≠' }, { j: 'Âºü', k: '„Åä„Å®„ÅÜ„Å®' },
            { j: 'Â¶π', k: '„ÅÑ„ÇÇ„ÅÜ„Å®' }, { j: 'Áî∑„ÅÆÂ≠ê', k: '„Åä„Å®„Åì„ÅÆ„Åì' }, { j: 'Â•≥„ÅÆÂ≠ê', k: '„Åä„Çì„Å™„ÅÆ„Åì' },
            { j: 'Êú¨', k: '„Åª„Çì' }, { j: '„Éö„É≥', k: '„Éö„É≥' }, { j: 'ÈâõÁ≠Ü', k: '„Åà„Çì„Å¥„Å§' },
            { j: 'Ê∂à„Åó„Ç¥„É†', k: '„Åë„Åó„Ç¥„É†' }, { j: '„Éé„Éº„Éà', k: '„Éé„Éº„Éà' }, { j: 'Êú∫', k: '„Å§„Åè„Åà' },
            { j: 'Ê§ÖÂ≠ê', k: '„ÅÑ„Åô' }, { j: 'ÊôÇË®à', k: '„Å®„Åë„ÅÑ' }, { j: 'ÈõªË©±', k: '„Åß„Çì„Çè' },
            { j: 'Á™ì', k: '„Åæ„Å©' }, { j: '„Éâ„Ç¢', k: '„Éâ„Ç¢' }, { j: 'ÂÇò', k: '„Åã„Åï' },
            { j: 'Èù¥', k: '„Åè„Å§' }, { j: 'Êúç', k: '„Åµ„Åè' }, { j: 'Â∏ΩÂ≠ê', k: '„Åº„ÅÜ„Åó' },
            { j: 'ÁúºÈè°', k: '„ÇÅ„Åå„Å≠' }, { j: 'Êâã', k: '„Å¶' }, { j: 'Ë∂≥', k: '„ÅÇ„Åó' },
            { j: 'ÁõÆ', k: '„ÇÅ' }, { j: 'ËÄ≥', k: '„Åø„Åø' }, { j: 'Âè£', k: '„Åè„Å°' },
            { j: 'Èºª', k: '„ÅØ„Å™' }, { j: 'È†≠', k: '„ÅÇ„Åü„Åæ' }, { j: 'È´™', k: '„Åã„Åø' },
            { j: 'È°î', k: '„Åã„Åä' }, { j: '‰Ωì', k: '„Åã„Çâ„Å†' }, { j: 'ÂøÉ', k: '„Åì„Åì„Çç' },
            { j: 'ÂÆ∂', k: '„ÅÑ„Åà' }, { j: 'ÈÉ®Â±ã', k: '„Å∏„ÇÑ' }, { j: 'Êúù', k: '„ÅÇ„Åï' },
            { j: 'Êòº', k: '„Å≤„Çã' }, { j: 'Â§ú', k: '„Çà„Çã' }, { j: '‰ªäÊó•', k: '„Åç„Çá„ÅÜ' },
            { j: 'ÊòéÊó•', k: '„ÅÇ„Åó„Åü' }, { j: 'Êò®Êó•', k: '„Åç„ÅÆ„ÅÜ' }, { j: 'ÈÄ±', k: '„Åó„ÇÖ„ÅÜ' },
            { j: 'Êúà', k: '„Å§„Åç' }, { j: 'Âπ¥', k: '„Å®„Åó' }, { j: 'ÊØéÊó•', k: '„Åæ„ÅÑ„Å´„Å°' },
            { j: 'ÊØéÈÄ±', k: '„Åæ„ÅÑ„Åó„ÇÖ„ÅÜ' }, { j: 'ÊØéÊúà', k: '„Åæ„ÅÑ„Å§„Åç' }, { j: 'ÊØéÂπ¥', k: '„Åæ„ÅÑ„Å®„Åó' },
            { j: '‰Ωï', k: '„Å™„Å´' }, { j: '„Å©„Åì', k: '„Å©„Åì' }, { j: '„ÅÑ„Å§', k: '„ÅÑ„Å§' },
            { j: 'Ë™∞', k: '„Å†„Çå' }, { j: '„Å™„Åú', k: '„Å™„Åú' }, { j: '„Å©„ÅÜ', k: '„Å©„ÅÜ' },
            { j: '„ÅÑ„Åè„Çâ', k: '„ÅÑ„Åè„Çâ' }, { j: '‰∏Ä', k: '„ÅÑ„Å°' }, { j: '‰∫å', k: '„Å´' },
            { j: '‰∏â', k: '„Åï„Çì' }, { j: 'Âõõ', k: '„Çà„Çì' }, { j: '‰∫î', k: '„Åî' },
            { j: 'ÂÖ≠', k: '„Çç„Åè' }, { j: '‰∏É', k: '„Å™„Å™' }, { j: 'ÂÖ´', k: '„ÅØ„Å°' },
            { j: '‰πù', k: '„Åç„ÇÖ„ÅÜ' }, { j: 'ÂçÅ', k: '„Åò„ÇÖ„ÅÜ' }, { j: 'Áôæ', k: '„Å≤„ÇÉ„Åè' },
            { j: 'ÂçÉ', k: '„Åõ„Çì' }, { j: '‰∏á', k: '„Åæ„Çì' }, { j: 'ÂÜÜ', k: '„Åà„Çì' },
            { j: '„ÅØ„ÅÑ', k: '„ÅØ„ÅÑ' }, { j: '„ÅÑ„ÅÑ„Åà', k: '„ÅÑ„ÅÑ„Åà' }, { j: '„Åä„ÅØ„Çà„ÅÜ', k: '„Åä„ÅØ„Çà„ÅÜ' },
            { j: '„Åì„Çì„Å´„Å°„ÅØ', k: '„Åì„Çì„Å´„Å°„ÅØ' }, { j: '„Åì„Çì„Å∞„Çì„ÅØ', k: '„Åì„Çì„Å∞„Çì„ÅØ' },
            { j: '„ÅÇ„Çä„Åå„Å®„ÅÜ', k: '„ÅÇ„Çä„Åå„Å®„ÅÜ' }, { j: '„Åô„Åø„Åæ„Åõ„Çì', k: '„Åô„Åø„Åæ„Åõ„Çì' },
            { j: '„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ', k: '„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ' }, { j: '„Åä„ÇÑ„Åô„Åø', k: '„Åä„ÇÑ„Åô„Åø' },
            { j: '„Åï„Çà„ÅÜ„Å™„Çâ', k: '„Åï„Çà„ÅÜ„Å™„Çâ' }, { j: 'Â§ß‰∏àÂ§´', k: '„Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂' },
            { j: 'Á∂∫È∫ó', k: '„Åç„Çå„ÅÑ' }, { j: 'Èùô„Åã', k: '„Åó„Åö„Åã' }, { j: '‰æøÂà©', k: '„Åπ„Çì„Çä' },
            { j: 'Á∞°Âçò', k: '„Åã„Çì„Åü„Çì' }, { j: 'Â§ßÂ•Ω„Åç', k: '„Å†„ÅÑ„Åô„Åç' }, { j: 'ÊúâÂêç', k: '„ÇÜ„ÅÜ„ÇÅ„ÅÑ' },
            { j: 'ÂÖÉÊ∞ó', k: '„Åí„Çì„Åç' }, { j: 'Â•Ω„Åç', k: '„Åô„Åç' }, { j: 'Â´å„ÅÑ', k: '„Åç„Çâ„ÅÑ' },
            { j: 'Èõ£„Åó„ÅÑ', k: '„ÇÄ„Åö„Åã„Åó„ÅÑ' }, { j: 'Ê•Ω„Åó„ÅÑ', k: '„Åü„ÅÆ„Åó„ÅÑ' }, { j: 'Âøô„Åó„ÅÑ', k: '„ÅÑ„Åù„Åå„Åó„ÅÑ' },
            { j: 'ÂØí„ÅÑ', k: '„Åï„ÇÄ„ÅÑ' }, { j: 'Êöë„ÅÑ', k: '„ÅÇ„Å§„ÅÑ' }, { j: 'Èù¢ÁôΩ„ÅÑ', k: '„Åä„ÇÇ„Åó„Çç„ÅÑ' },
            { j: 'ÁæéÂë≥„Åó„ÅÑ', k: '„Åä„ÅÑ„Åó„ÅÑ' }, { j: 'Áîò„ÅÑ', k: '„ÅÇ„Åæ„ÅÑ' }, { j: 'Ëæõ„ÅÑ', k: '„Åã„Çâ„ÅÑ' },
            { j: 'ÈÖ∏„Å£„Å±„ÅÑ', k: '„Åô„Å£„Å±„ÅÑ' }, { j: 'Ëã¶„ÅÑ', k: '„Å´„Åå„ÅÑ' }, { j: 'Èáç„ÅÑ', k: '„Åä„ÇÇ„ÅÑ' },
            { j: 'ËªΩ„ÅÑ', k: '„Åã„Çã„ÅÑ' }, { j: 'Áã≠„ÅÑ', k: '„Åõ„Åæ„ÅÑ' }, { j: 'Â∫É„ÅÑ', k: '„Å≤„Çç„ÅÑ' },
            { j: 'ÈÅ†„ÅÑ', k: '„Å®„Åä„ÅÑ' }, { j: 'Ëøë„ÅÑ', k: '„Å°„Åã„ÅÑ' }, { j: 'Êó©„ÅÑ', k: '„ÅØ„ÇÑ„ÅÑ' },
            { j: 'ÈÅÖ„ÅÑ', k: '„Åä„Åù„ÅÑ' }, { j: 'ÈÄü„ÅÑ', k: '„ÅØ„ÇÑ„ÅÑ' }, { j: 'ÈÅÖ„ÅÑ', k: '„Åä„Åù„ÅÑ' },
            { j: 'Âº∑„ÅÑ', k: '„Å§„Çà„ÅÑ' }, { j: 'Âº±„ÅÑ', k: '„Çà„Çè„ÅÑ' }, { j: 'ËâØ„ÅÑ', k: '„Çà„ÅÑ' },
            { j: 'ÊÇ™„ÅÑ', k: '„Çè„Çã„ÅÑ' }, { j: 'Â§ö„ÅÑ', k: '„Åä„Åä„ÅÑ' }, { j: 'Â∞ë„Å™„ÅÑ', k: '„Åô„Åè„Å™„ÅÑ' },
            { j: '„Å™„Åå„ÅÑ', k: '„Å™„Åå„ÅÑ' }, { j: 'Áü≠„ÅÑ', k: '„Åø„Åò„Åã„ÅÑ' }, { j: 'Êñ∞„Åó„ÅÑ', k: '„ÅÇ„Åü„Çâ„Åó„ÅÑ' },
            { j: 'Âè§„ÅÑ', k: '„Åµ„Çã„ÅÑ' }, { j: 'Áæé„Åó„ÅÑ', k: '„ÅÜ„Å§„Åè„Åó„ÅÑ' }, { j: 'ÂèØÊÑõ„ÅÑ', k: '„Åã„Çè„ÅÑ„ÅÑ' },
            { j: 'ÊÄñ„ÅÑ', k: '„Åì„Çè„ÅÑ' }, { j: 'Áú†„ÅÑ', k: '„Å≠„ÇÄ„ÅÑ' }, { j: 'Âøô„Åó„ÅÑ', k: '„ÅÑ„Åù„Åå„Åó„ÅÑ' },
            { j: 'Êöá', k: '„Å≤„Åæ' }, { j: 'Â•Ω„Åç', k: '„Åô„Åç' }, { j: 'Â´å„ÅÑ', k: '„Åç„Çâ„ÅÑ' },
            { j: '‰∏äÊâã', k: '„Åò„Çá„ÅÜ„Åö' }, { j: '‰∏ãÊâã', k: '„Å∏„Åü' }, { j: '‰æøÂà©', k: '„Åπ„Çì„Çä' },
            { j: '‰∏ç‰æø', k: '„Åµ„Åπ„Çì' }, { j: 'ÁµêÊßã', k: '„Åë„Å£„Åì„ÅÜ' }, { j: 'ÁµêÊßã„Åß„Åô', k: '„Åë„Å£„Åì„ÅÜ„Åß„Åô' },
            { j: 'Â§ß‰∏àÂ§´', k: '„Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂' }, { j: 'ÂïèÈ°å', k: '„ÇÇ„Çì„Å†„ÅÑ' }, { j: 'Ë≥™Âïè', k: '„Åó„Å§„ÇÇ„Çì' },
            { j: 'Á≠î„Åà', k: '„Åì„Åü„Åà' }, { j: 'ÂàÜ„Åã„Çã', k: '„Çè„Åã„Çã' }, { j: 'ÂàÜ„Åã„Çã', k: '„Çè„Åã„Çã' },
            { j: '„Åß„Åç„Çã', k: '„Åß„Åç„Çã' }, { j: '„Åß„Åç„Å™„ÅÑ', k: '„Åß„Åç„Å™„ÅÑ' }, { j: '‰Ωø„ÅÜ', k: '„Å§„Åã„ÅÜ' },
            { j: '‰Ωú„Çã', k: '„Å§„Åè„Çã' }, { j: 'Â£≤„Çã', k: '„ÅÜ„Çã' }, { j: 'Ë≤∑„ÅÜ', k: '„Åã„ÅÜ' },
            { j: 'ÂãâÂº∑', k: '„Åπ„Çì„Åç„Çá„ÅÜ' }, { j: 'ÈÅãÂãï', k: '„ÅÜ„Çì„Å©„ÅÜ' }, { j: '‰ªï‰∫ã', k: '„Åó„Åî„Å®' },
            { j: '‰ºë„Åø', k: '„ÇÑ„Åô„Åø' }, { j: 'ÊóÖË°å', k: '„Çä„Çá„Åì„ÅÜ' }, { j: 'Èü≥Ê•Ω', k: '„Åä„Çì„Åå„Åè' },
            { j: 'Êò†Áîª', k: '„Åà„ÅÑ„Åå' }, { j: '„ÉÜ„É¨„Éì', k: '„ÉÜ„É¨„Éì' }, { j: '„É©„Ç∏„Ç™', k: '„É©„Ç∏„Ç™' },
            { j: 'Êñ∞ËÅû', k: '„Åó„Çì„Å∂„Çì' }, { j: 'ÈõëË™å', k: '„Åñ„Å£„Åó' }, { j: 'Êº´Áîª', k: '„Åæ„Çì„Åå' },
            { j: '„Ç≤„Éº„É†', k: '„Ç≤„Éº„É†' }, { j: '„Çπ„Éù„Éº„ÉÑ', k: '„Çπ„Éù„Éº„ÉÑ' }, { j: 'ÊñôÁêÜ', k: '„Çä„Çá„ÅÜ„Çä' },
            { j: 'È£ü„Åπ„Çã', k: '„Åü„Åπ„Çã' }, { j: 'È£≤„ÇÄ', k: '„ÅÆ„ÇÄ' }, { j: 'Ë°å„Åè', k: '„ÅÑ„Åè' },
            { j: 'Êù•„Çã', k: '„Åè„Çã' }, { j: 'Â∏∞„Çã', k: '„Åã„Åà„Çã' }, { j: 'ÂØù„Çã', k: '„Å≠„Çã' },
            { j: 'Ëµ∑„Åç„Çã', k: '„Åä„Åç„Çã' }, { j: 'Â∫ß„Çã', k: '„Åô„Çè„Çã' }, { j: 'Á´ã„Å§', k: '„Åü„Å§' },
            { j: 'Ê≠©„Åè', k: '„ÅÇ„Çã„Åè' }, { j: 'Ëµ∞„Çã', k: '„ÅØ„Åó„Çã' }, { j: 'Ê≥≥„Åê', k: '„Åä„Çà„Åê' },
            { j: 'Ê≠å„ÅÜ', k: '„ÅÜ„Åü„ÅÜ' }, { j: 'Ë∏ä„Çã', k: '„Åä„Å©„Çã' }, { j: 'Êèè„Åè', k: '„Åã„Åè' },
            { j: 'Ë©±„Åô', k: '„ÅØ„Å™„Åô' }, { j: 'ËÅû„Åè', k: '„Åç„Åè' }, { j: 'Ë¶ã„Çã', k: '„Åø„Çã' },
            { j: 'Êõ∏„Åè', k: '„Åã„Åè' }, { j: 'Ë™≠„ÇÄ', k: '„Çà„ÇÄ' }, { j: 'Ë≤∑„ÅÜ', k: '„Åã„ÅÜ' },
            { j: 'Â£≤„Çã', k: '„ÅÜ„Çã' }, { j: 'Êïô„Åà„Çã', k: '„Åä„Åó„Åà„Çã' }, { j: 'Áøí„ÅÜ', k: '„Å™„Çâ„ÅÜ' },
            { j: 'Â≠¶„Å∂', k: '„Åæ„Å™„Å∂' }, { j: 'ÂÉç„Åè', k: '„ÅØ„Åü„Çâ„Åè' }, { j: 'ÈÅä„Å∂', k: '„ÅÇ„Åù„Å∂' },
            { j: 'Èñã„Åë„Çã', k: '„ÅÇ„Åë„Çã' }, { j: 'Èñâ„ÇÅ„Çã', k: '„Åó„ÇÅ„Çã' }, { j: 'Âá∫„Åô', k: '„Å†„Åô' },
            { j: 'ÂÖ•„Çå„Çã', k: '„ÅÑ„Çå„Çã' }, { j: 'Ë≤∏„Åô', k: '„Åã„Åô' }, { j: 'ÂÄü„Çä„Çã', k: '„Åã„Çä„Çã' },
            { j: 'ÈÄÅ„Çã', k: '„Åä„Åè„Çã' }, { j: '„ÇÇ„Çâ„ÅÜ', k: '„ÇÇ„Çâ„ÅÜ' }, { j: '„ÅÇ„Åí„Çã', k: '„ÅÇ„Åí„Çã' },
            { j: '„Åè„Çå„Çã', k: '„Åè„Çå„Çã' }, { j: 'ÂæÖ„Å§', k: '„Åæ„Å§' }, { j: 'ÊÄ•„Åê', k: '„ÅÑ„Åù„Åê' },
            { j: 'Ê≠ª„Å¨', k: '„Åó„Å¨' }, { j: 'Áîü„Åç„Çã', k: '„ÅÑ„Åç„Çã' }, { j: 'Âßã„Åæ„Çã', k: '„ÅØ„Åò„Åæ„Çã' },
            { j: 'ÁµÇ„Çè„Çã', k: '„Åä„Çè„Çã' }, { j: '„Å§„Åë„Çã', k: '„Å§„Åë„Çã' }, { j: 'Ê∂à„Åô', k: '„Åë„Åô' },
            { j: '‰Ωø„ÅÜ', k: '„Å§„Åã„ÅÜ' }, { j: 'Ê≠¢„Åæ„Çã', k: '„Å®„Åæ„Çã' }, { j: 'Ê≠¢„ÇÅ„Çã', k: '„Å®„ÇÅ„Çã' },
            { j: 'Èôç„Çã', k: '„Åµ„Çã' }, { j: 'Êô¥„Çå„Çã', k: '„ÅØ„Çå„Çã' }, { j: 'Êõá„Çã', k: '„Åè„ÇÇ„Çã' },
            { j: 'Âêπ„Åè', k: '„Åµ„Åè' }, { j: 'È≥¥„Åè', k: '„Å™„Åè' }, { j: 'Âí≤„Åè', k: '„Åï„Åè' },
            { j: 'ÊûØ„Çå„Çã', k: '„Åã„Çå„Çã' }, { j: 'Âí≤„Åè', k: '„Åï„Åè' }, { j: 'ÊûØ„Çå„Çã', k: '„Åã„Çå„Çã' },
            { j: 'Á´ã„Å§', k: '„Åü„Å§' }, { j: 'Â∫ß„Çã', k: '„Åô„Çè„Çã' }, { j: 'Ê≠©„Åè', k: '„ÅÇ„Çã„Åè' },
            { j: 'Ëµ∞„Çã', k: '„ÅØ„Åó„Çã' }, { j: 'Ê≥≥„Åê', k: '„Åä„Çà„Åê' }, { j: 'Ê≠å„ÅÜ', k: '„ÅÜ„Åü„ÅÜ' },
            { j: 'Ë∏ä„Çã', k: '„Åä„Å©„Çã' }, { j: 'Êèè„Åè', k: '„Åã„Åè' }, { j: 'Ë©±„Åô', k: '„ÅØ„Å™„Åô' },
            { j: 'ËÅû„Åè', k: '„Åç„Åè' }, { j: 'Ë¶ã„Çã', k: '„Åø„Çã' }, { j: 'Êõ∏„Åè', k: '„Åã„Åè' },
            { j: 'Ë™≠„ÇÄ', k: '„Çà„ÇÄ' }, { j: 'Ë≤∑„ÅÜ', k: '„Åã„ÅÜ' }, { j: 'Â£≤„Çã', k: '„ÅÜ„Çã' },
            { j: 'Êïô„Åà„Çã', k: '„Åä„Åó„Åà„Çã' }, { j: 'Áøí„ÅÜ', k: '„Å™„Çâ„ÅÜ' }, { j: 'Â≠¶„Å∂', k: '„Åæ„Å™„Å∂' },
            { j: 'ÂÉç„Åè', k: '„ÅØ„Åü„Çâ„Åè' }, { j: 'ÈÅä„Å∂', k: '„ÅÇ„Åù„Å∂' }, { j: 'Èñã„Åë„Çã', k: '„ÅÇ„Åë„Çã' },
            { j: 'Èñâ„ÇÅ„Çã', k: '„Åó„ÇÅ„Çã' }, { j: 'Âá∫„Åô', k: '„Å†„Åô' }, { j: 'ÂÖ•„Çå„Çã', k: '„ÅÑ„Çå„Çã' },
            { j: 'Ë≤∏„Åô', k: '„Åã„Åô' }, { j: 'ÂÄü„Çä„Çã', k: '„Åã„Çä„Çã' }, { j: 'ÈÄÅ„Çã', k: '„Åä„Åè„Çã' },
            { j: '„ÇÇ„Çâ„ÅÜ', k: '„ÇÇ„Çâ„ÅÜ' }, { j: '„ÅÇ„Åí„Çã', k: '„ÅÇ„Åí„Çã' }, { j: '„Åè„Çå„Çã', k: '„Åè„Çå„Çã' },
            { j: 'ÂæÖ„Å§', k: '„Åæ„Å§' }, { j: 'ÊÄ•„Åê', k: '„ÅÑ„Åù„Åê' }, { j: 'Ê≠ª„Å¨', k: '„Åó„Å¨' },
            { j: 'Áîü„Åç„Çã', k: '„ÅÑ„Åç„Çã' }, { j: 'Âßã„Åæ„Çã', k: '„ÅØ„Åò„Åæ„Çã' }, { j: 'ÁµÇ„Çè„Çã', k: '„Åä„Çè„Çã' },
            { j: '„Å§„Åë„Çã', k: '„Å§„Åë„Çã' }, { j: 'Ê∂à„Åô', k: '„Åë„Åô' }, { j: '‰Ωø„ÅÜ', k: '„Å§„Åã„ÅÜ' },
            { j: 'Ê≠¢„Åæ„Çã', k: '„Å®„Åæ„Çã' }, { j: 'Ê≠¢„ÇÅ„Çã', k: '„Å®„ÇÅ„Çã' }, { j: 'Èôç„Çã', k: '„Åµ„Çã' },
            { j: 'Êô¥„Çå„Çã', k: '„ÅØ„Çå„Çã' }, { j: 'Êõá„Çã', k: '„Åè„ÇÇ„Çã' }, { j: 'Âêπ„Åè', k: '„Åµ„Åè' },
            { j: 'È≥¥„Åè', k: '„Å™„Åè' }, { j: 'Âí≤„Åè', k: '„Åï„Åè' }, { j: 'ÊûØ„Çå„Çã', k: '„Åã„Çå„Çã' }
        ];

        // Kana character definitions
        const HIRA_BASE = '„ÅÇ„ÅÑ„ÅÜ„Åà„Åä„Åã„Åç„Åè„Åë„Åì„Åï„Åó„Åô„Åõ„Åù„Åü„Å°„Å§„Å¶„Å®„Å™„Å´„Å¨„Å≠„ÅÆ„ÅØ„Å≤„Åµ„Å∏„Åª„Åæ„Åø„ÇÄ„ÇÅ„ÇÇ„ÇÑ„ÇÜ„Çà„Çâ„Çä„Çã„Çå„Çç„Çè„Çí„Çì';
        const KATA_BASE = '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
        const HIRA_SMALL_VOWELS = '„ÅÅ„ÅÉ„ÅÖ„Åá„Åâ';
        const KATA_SMALL_VOWELS = '„Ç°„Ç£„Ç•„Çß„Ç©';
        const HIRA_SMALL_YO = '„ÇÉ„ÇÖ„Çá';
        const KATA_SMALL_YO = '„É£„É•„Éß';
        const HIRA_DAKUON = '„Åå„Åé„Åê„Åí„Åî„Åñ„Åò„Åö„Åú„Åû„Å†„Å¢„Å•„Åß„Å©„Å∞„Å≥„Å∂„Åπ„Åº';
        const KATA_DAKUON = '„Ç¨„ÇÆ„Ç∞„Ç≤„Ç¥„Ç∂„Ç∏„Ç∫„Çº„Çæ„ÉÄ„ÉÇ„ÉÖ„Éá„Éâ„Éê„Éì„Éñ„Éô„Éú';
        const HIRA_HANDAKUON = '„Å±„Å¥„Å∑„Å∫„ÅΩ';
        const KATA_HANDAKUON = '„Éë„Éî„Éó„Éö„Éù';
        const HIRA_SOKUON = '„Å£';
        const KATA_SOKUON = '„ÉÉ';
        const CHOON = '„Éº'; // Long vowel mark, Katakana only

        // Valid Sokuon preceding characters (k, s, t, p lines ONLY)
        const SOKUON_VALID_NEXT_HIRA_START = '„Åã„Åç„Åè„Åë„Åì„Åï„Åó„Åô„Åõ„Åù„Åü„Å°„Å§„Å¶„Å®„Å±„Å¥„Å∑„Å∫„ÅΩ';
        const SOKUON_VALID_NEXT_KATA_START = '„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éë„Éî„Éó„Éö„Éù';
        
        // Samakan definisi PUNCTUATION
        const PUNCTUATION = '„ÄÇ„ÄÅ„Äå„Äç„ÄÅ„ÉªÔºüÔºÅ'; // Punctuation always allowed

        // --- GLOBAL STATE ---
        const state = {
            script: localStorage.getItem('rdg.script') || 'hiragana',
            subset: JSON.parse(localStorage.getItem('rdg.subset') || '{"gojuon":true,"dakuon":false,"handakuon":false,"youon":false}'),
            sokuonProb: +(localStorage.getItem('rdg.sokuonProb') || 10), // 0-40%
            choonProb: +(localStorage.getItem('rdg.choonProb') || 20),   // 0-60%
            paragraphCount: +(localStorage.getItem('rdg.paragraphCount') || 3),
            sentencePerParagraph: +(localStorage.getItem('rdg.sentencePerParagraph') || 4),
            targetLength: +(localStorage.getItem('rdg.targetLength') || 10),
        };

        // --- DOM ELEMENTS ---
        const rdgScriptSelector = document.getElementById('rdg-script-selector');
        const rdgPresetButtons = document.querySelector('.rdg-preset-buttons'); // New
        const rdgSubsetControls = document.querySelector('.rdg-subset-controls');
        const rdgSubsetGojuon = document.getElementById('rdg-subset-gojuon');
        const rdgSubsetDakuon = document.getElementById('rdg-subset-dakuon');
        const rdgSubsetHandakuon = document.getElementById('rdg-subset-handakuon');
        const rdgSubsetYouon = document.getElementById('rdg-subset-youon');
        const rdgSokuonSlider = document.getElementById('rdg-sokuon-slider');
        const rdgSokuonDisplay = document.getElementById('rdg-sokuon-display');
        const rdgChoonSlider = document.getElementById('rdg-choon-slider');
        const rdgChoonDisplay = document.getElementById('rdg-choon-display');
        const rdgParagraphCount = document.getElementById('rdg-paragraph-count');
        const rdgSentencePerParagraph = document.getElementById('rdg-sentence-per-paragraph');
        const rdgTargetLength = document.getElementById('rdg-target-length');
        const rdgGenerateBtn = document.getElementById('rdg-generate-btn');
        const rdgCopyBtn = document.getElementById('rdg-copy-btn');
        const rdgSpeakBtn = document.getElementById('rdg-speak-btn');
        const rdgOutput = document.getElementById('rdg-output');
        const toastMessageEl = document.getElementById('toastMessage');

        // --- UTILITY FUNCTIONS ---

        /**
         * Mengacak elemen dalam array.
         * @param {Array} arr - Array yang akan diacak.
         */
        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        /**
         * Mengacak array dan mengembalikan array baru (tidak mengubah array asli).
         * @param {Array} arr - Array yang akan diacak.
         * @returns {Array} Array baru yang sudah diacak.
         */
        function shuffleReturn(arr) {
            const a = [...arr];
            shuffle(a);
            return a;
        }

        /**
         * Menampilkan pesan toast.
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {string} type - Tipe pesan ('info' atau 'warn').
         * @param {number} duration - Durasi pesan dalam ms.
         */
        let toastTimeout;
        function showToast(message, type = 'info', duration = 2500) {
            clearTimeout(toastTimeout);
            toastMessageEl.textContent = message;
            toastMessageEl.className = 'toast show';
            if (type === 'warn') {
                toastMessageEl.classList.add('warn');
            } else {
                toastMessageEl.classList.remove('warn');
            }

            toastTimeout = setTimeout(() => {
                toastMessageEl.classList.remove('show');
            }, duration);
        }

        /**
         * Mengubah karakter Hiragana menjadi Katakana.
         * @param {string} char - Karakter Hiragana.
         * @returns {string} Karakter Katakana yang sesuai.
         */
        function toKatakana(char) {
            const code = char.charCodeAt(0);
            if (code >= 0x3041 && code <= 0x3096) { // Hiragana range
                return String.fromCharCode(code + 0x60); // Offset ke Katakana
            }
            return char;
        }

        /**
         * Mengubah karakter Katakana menjadi Hiragana.
         * @param {string} char - Karakter Katakana.
         * @returns {string} Karakter Hiragana yang sesuai.
         */
        function toHiragana(char) {
            const code = char.charCodeAt(0);
            if (code >= 0x30A1 && code <= 0x30F6) { // Katakana range
                return String.fromCharCode(code - 0x60); // Offset ke Hiragana
            }
            return char;
        }

        /**
         * Mengecek apakah karakter adalah Hiragana.
         * @param {string} char - Karakter untuk dicek.
         * @returns {boolean} True jika Hiragana.
         */
        function isHiragana(char) {
            return char.charCodeAt(0) >= 0x3040 && char.charCodeAt(0) <= 0x309F;
        }

        /**
         * Mengecek apakah karakter adalah Katakana.
         * @param {string} char - Karakter untuk dicek.
         * @returns {boolean} True jika Katakana.
         */
        function isKatakana(char) {
            return char.charCodeAt(0) >= 0x30A0 && char.charCodeAt(0) <= 0x30FF;
        }

        /**
         * Mengecek apakah karakter adalah Kana (Hiragana atau Katakana).
         * @param {string} char - Karakter untuk dicek.
         * @returns {boolean} True jika Kana.
         */
        function isKana(char) {
            return isHiragana(char) || isKatakana(char);
        }

        /**
         * Mengecek apakah karakter adalah Kanji.
         * @param {string} char - Karakter untuk dicek.
         * @returns {boolean} True jika Kanji.
         */
        function isKanji(char) {
            return char.charCodeAt(0) >= 0x4E00 && char.charCodeAt(0) <= 0x9FFF;
        }

        /**
         * Mengecek apakah karakter adalah tanda baca Jepang.
         * @param {string} char - Karakter untuk dicek.
         * @returns {boolean} True jika tanda baca.
         */
        function isPunctuation(char) {
            return PUNCTUATION.includes(char) || char === ' ' || char === '\n';
        }

        /**
         * Mengecek apakah karakter adalah kana kecil („ÇÉ„ÇÖ„Çá„ÅÅ„ÅÉ„ÅÖ„Åá„Åâ).
         * @param {string} char - Karakter untuk dicek.
         * @returns {boolean} True jika kana kecil.
         */
        function isKanaSmall(char) {
            return HIRA_SMALL_YO.includes(char) || KATA_SMALL_YO.includes(char) ||
                   HIRA_SMALL_VOWELS.includes(char) || KATA_SMALL_VOWELS.includes(char);
        }

        // ---- SMART RANDOM HELPERS ----
        const VEND = /[„Çã„ÇÄ„Åè„Å∂„Åê„Åô„Å§„Å¨]$/;     // heuristik kata kerja (akhir kana godan/ichidan)
        const IADJ = /„ÅÑ$/;                       // heuristik i-keiyoushi
        const TIME_WORDS = ['„Åç„Çá„ÅÜ','„ÅÇ„Åó„Åü','„Åç„ÅÆ„ÅÜ','„Åæ„ÅÑ„Å´„Å°','„ÅÇ„Åï','„Å≤„Çã','„Çà„Çã'];
        const PLACES = ['„Åå„Å£„Åì„ÅÜ','„ÅÑ„Åà','„Å∏„ÇÑ','„Åà„Åç','„Åæ„Å°','„Åì„ÅÜ„Åà„Çì'];
        const PARTICLES = { topic:'„ÅØ', obj:'„Çí', loc:'„Åß', dir:'„Å∏', time:'„Å´' };

        function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

        // Ambil satu kata dari DICTIONARY yang lolos whitelist + cocok heuristik
        function pickWord(filterFn, allow, script){
          const pool = shuffleReturn(DICTIONARY).filter(it=>{
            const k = it.k;
            if (!wordAllowed(k, allow, script)) return false;
            return filterFn(k, it);
          });
          return pool.length ? pool[0] : null;
        }

        // Cek ada youon/dakuon/ch≈çon di suatu string (untuk satisfy slider/checkbox)
        const HAS_YOUON = /[„ÇÉ„ÇÖ„Çá„É£„É•„Éß„ÅÅ„ÅÉ„ÅÖ„Åá„Åâ„Ç°„Ç£„Ç•„Çß„Ç©]/;
        const HAS_DAKUON = /[„Åå„Åé„Åê„Åí„Åî„Åñ„Åò„Åö„Åú„Åû„Å†„Å¢„Å•„Åß„Å©„Å∞„Å≥„Å∂„Åπ„Åº„Ç¨„ÇÆ„Ç∞„Ç≤„Ç¥„Ç∂„Ç∏„Ç∫„Çº„Çæ„ÉÄ„ÉÇ„ÉÖ„Éá„Éâ„Éê„Éì„Éñ„Éô„Éú]/;
        const HAS_CHOON  = /„Éº/;

        // Bangun satu kalimat dengan pola acak
        function generateSmartSentence(allow, script){
          // kandidat isi kalimat
          const subj = pickWord((k)=>!VEND.test(k) && !IADJ.test(k), allow, script) || {k:'„Çè„Åü„Åó'};
          const obj  = pickWord((k)=>!VEND.test(k) && !IADJ.test(k), allow, script) || {k:'„Åª„Çì'};
          const verb = pickWord((k)=>VEND.test(k), allow, script) || {k:'„Çà„ÇÄ'};
          const place= pickWord((k)=>!VEND.test(k) && !IADJ.test(k), allow, script) || {k:'„ÅÑ„Åà'};
          const adj  = pickWord((k)=>IADJ.test(k), allow, script) || {k:'„Åü„ÅÆ„Åó„ÅÑ'};
          const time = randChoice(TIME_WORDS);

          const templates = [
            // T1: [Time]„Å´ [Subj]„ÅØ [Place]„Åß [Obj]„Çí [Verb]„ÄÇ
            () => `${time}${PARTICLES.time}${subj.k}${PARTICLES.topic}${place.k}${PARTICLES.loc}${obj.k}${PARTICLES.obj}${verb.k}`,
            // T2: [Subj]„ÅØ [Obj]„Çí [Verb]„ÄÇ
            () => `${subj.k}${PARTICLES.topic}${obj.k}${PARTICLES.obj}${verb.k}`,
            // T3: [Subj]„ÅØ [Place]„Å∏ [Verb]„ÄÇ
            () => `${subj.k}${PARTICLES.topic}${place.k}${PARTICLES.dir}${verb.k}`,
            // T4: [Subj]„ÅØ [Adj]„Åß„Åô„ÄÇ
            () => `${subj.k}${PARTICLES.topic}${adj.k}„Åß„Åô`
          ];
          let sentence = randChoice(templates)();

          // injeksi sokuon/choon sesuai slider (fungsi kamu yang ada)
          sentence = injectSokuon(sentence, state.sokuonProb/100, script);
          if (script !== 'hiragana') sentence = injectChoon(sentence, state.choonProb/100);

          return sentence; // Jangan tambahkan maru di sini, akan ditambahkan di composeSentence
        }

        // --- CORE LOGIC ---

        /**
         * Membangun daftar karakter yang diizinkan (whitelist) berdasarkan pengaturan subset.
         * @param {object} settings - Objek pengaturan subset dari state.
         * @returns {{setHira: Set<string>, setKata: Set<string>, allowYouon: boolean, allowSokuon: boolean, allowChoon: boolean}} Whitelist karakter dan flag izin.
         */
        function buildWhitelist(settings) {
            const setHira = new Set();
            const setKata = new Set();

            if (settings.gojuon) {
                HIRA_BASE.split('').forEach(c => setHira.add(c));
                KATA_BASE.split('').forEach(c => setKata.add(c));
            }
            if (settings.dakuon) {
                HIRA_DAKUON.split('').forEach(c => setHira.add(c));
                KATA_DAKUON.split('').forEach(c => setKata.add(c));
            }
            if (settings.handakuon) {
                HIRA_HANDAKUON.split('').forEach(c => setHira.add(c));
                KATA_HANDAKUON.split('').forEach(c => setKata.add(c));
            }
            if (settings.youon) {
                HIRA_SMALL_YO.split('').forEach(c => setHira.add(c));
                KATA_SMALL_YO.split('').forEach(c => setKata.add(c));
                HIRA_SMALL_VOWELS.split('').forEach(c => setHira.add(c)); // Untuk kasus seperti „Åµ„ÅÅ„ÄÅ„Å¶„ÅÉ
                KATA_SMALL_VOWELS.split('').forEach(c => setKata.add(c));
            }

            // Tanda baca selalu diizinkan
            PUNCTUATION.split('').forEach(c => { setHira.add(c); setKata.add(c); });

            return {
                setHira,
                setKata,
                allowYouon: settings.youon,
                allowSokuon: settings.sokuonProb > 0,
                allowChoon: settings.choonProb > 0
            };
        }

        /**
         * Memeriksa apakah sebuah kata (dalam kana) diizinkan berdasarkan whitelist.
         * Untuk Furigana, akan memeriksa bagian 'rt' (kana).
         * @param {string} wordKana - Kata dalam bentuk Kana (atau furigana 'rt').
         * @param {object} allow - Objek whitelist dari buildWhitelist.
         * @param {string} script - Skrip yang sedang aktif ('hiragana', 'katakana', 'mixed', 'furigana').
         * @returns {boolean} True jika kata diizinkan.
         */
        function wordAllowed(wordKana, allow, script) {
            for (let i = 0; i < wordKana.length; i++) {
                const char = wordKana[i];

                if (isKanji(char) || isPunctuation(char)) {
                    continue; // Kanji dan tanda baca selalu diizinkan
                }

                // Cek Youon
                if (isKanaSmall(char) && !allow.allowYouon) {
                    // Jika ini kana kecil dan youon tidak diizinkan, maka tolak.
                    return false;
                }

                // Cek Ch≈çon
                if (char === CHOON) {
                    if (isHiragana(char) || !allow.allowChoon) { 
                        return false; 
                    }
                    continue; 
                }

                // Cek kana lainnya
                if (isHiragana(char)) {
                    if (!allow.setHira.has(char)) return false;
                } else if (isKatakana(char)) {
                    if (!allow.setKata.has(char)) return false;
                } else {
                    // Karakter lain yang bukan kanji, kana, atau tanda baca (e.g., romaji, simbol tak dikenal)
                    // Untuk kesederhanaan, kita bisa mengabaikannya atau menolaknya.
                }
            }
            return true;
        }

        /**
         * Memfilter kamus berdasarkan whitelist yang diizinkan.
         * @param {Array<object>} dict - Kamus asli.
         * @param {object} allow - Objek whitelist dari buildWhitelist.
         * @param {string} script - Skrip yang sedang aktif.
         * @returns {Array<object>} Kamus yang sudah difilter.
         */
        function filterDictionary(dict, allow, script) {
            const filtered = dict.filter(item => {
                const kanaToCheck = item.k; // Selalu cek kana (furigana atau hiragana/katakana)

                // Jika script adalah Hiragana atau Katakana tunggal, pastikan item.k sesuai
                if (script === 'hiragana') {
                    for (const char of kanaToCheck) {
                        if (isKatakana(char) || (isKanji(char) && item.j !== item.k)) return false; // Tolak katakana atau kanji dengan furigana
                    }
                } else if (script === 'katakana') {
                    for (const char of kanaToCheck) {
                        if (isHiragana(char) || (isKanji(char) && item.j !== item.k)) return false; // Tolak hiragana atau kanji dengan furigana
                    }
                }
                // 'mixed' dan 'furigana' membolehkan campuran atau kanji.

                return wordAllowed(kanaToCheck, allow, script);
            });
            
            return filtered;
        }

        /**
         * Menginjeksikan Sokuon („Å£/„ÉÉ) ke dalam kalimat.
         * @param {string} sentence - Kalimat asli.
         * @param {number} probability - Probabilitas injeksi (0-1).
         * @param {string} scriptType - 'hiragana' atau 'katakana' atau 'mixed'.
         * @returns {string} Kalimat dengan Sokuon yang diinjeksikan.
         */
        function injectSokuon(sentence, probability, scriptType) {
            if (probability === 0) return sentence;

            let result = '';
            for (let i = 0; i < sentence.length; i++) {
                const char = sentence[i];
                result += char;

                // Jangan injeksi sokuon di awal kata, jika karakter saat ini bukan kana,
                // atau jika karakter berikutnya bukan kana
                if (i === sentence.length - 1 || !isKana(sentence[i]) || !isKana(sentence[i+1])) continue;

                const nextChar = sentence[i + 1];
                let isValidNextForSokuon = false;
                let sokuonChar = HIRA_SOKUON;

                if (isHiragana(nextChar) && SOKUON_VALID_NEXT_HIRA_START.includes(nextChar)) {
                    isValidNextForSokuon = true;
                    sokuonChar = HIRA_SOKUON;
                } else if (isKatakana(nextChar) && SOKUON_VALID_NEXT_KATA_START.includes(nextChar)) {
                    isValidNextForSokuon = true;
                    sokuonChar = KATA_SOKUON;
                }

                if (isValidNextForSokuon && Math.random() < probability) {
                    // Hindari duplikasi sokuon (e.g., „Åå„Å£„Å£„Åì„ÅÜ)
                    if (result.length > 0 && (result[result.length - 1] === HIRA_SOKUON || result[result.length - 1] === KATA_SOKUON)) {
                        continue;
                    }
                    result += sokuonChar;
                }
            }
            return result;
        }

        /**
         * Menginjeksikan Ch≈çon („Éº) ke dalam Katakana.
         * @param {string} sentence - Kalimat asli (diasumsikan Katakana).
         * @param {number} probability - Probabilitas injeksi (0-1).
         * @returns {string} Kalimat dengan Ch≈çon yang diinjeksikan.
         */
        function injectChoon(sentence, probability) {
            if (probability === 0) return sentence;

            let result = '';
            for (let i = 0; i < sentence.length; i++) {
                const char = sentence[i];
                result += char;

                // Hanya untuk Katakana dan jika bukan karakter terakhir
                if (isKatakana(char) && i < sentence.length - 1) {
                    const nextChar = sentence[i+1];
                    
                    const isVowelKatakana = ['„Ç¢', '„Ç§', '„Ç¶', '„Ç®', '„Ç™', '„Ç°', '„Ç£', '„Ç•', '„Çß', '„Ç©'].includes(char);
                    const isNextCharVowelKatakana = ['„Ç¢', '„Ç§', '„Ç¶', '„Ç®', '„Ç™', '„Ç°', '„Ç£', '„Ç•', '„Çß', '„Ç©'].includes(nextChar);

                    if (isVowelKatakana && isNextCharVowelKatakana && Math.random() < probability) {
                        // Injeksi Ch≈çon jika karakter saat ini adalah vokal Katakana
                        // dan karakter berikutnya adalah vokal yang sama,
                        // atau kombinasi vokal umum yang membentuk vokal panjang.
                        if (char === nextChar) { // Contoh: „Ç´„Ç¢ -> „Ç´„Éº
                            result += CHOON;
                            i++; // Lompat karakter berikutnya karena sudah diganti dengan ch≈çon
                        } else if ((char === '„Ç®' && nextChar === '„Ç§') || (char === '„Ç™' && nextChar === '„Ç¶')) {
                            // Contoh umum: „Ç®„Ç§ -> „Ç®„Éº, „Ç™„Ç¶ -> „Ç™„Éº
                            result += CHOON;
                            i++;
                        }
                    }
                }
            }
            return result;
        }

        /**
         * Menggabungkan kata-kata menjadi sebuah kalimat, dengan menerapkan injeksi sokuon/choon.
         * @param {Array<object>} words - Array objek kata { j: 'Kanji', k: 'kana' }.
         * @param {object} allow - Objek whitelist dan flag izin.
         * @param {string} script - Skrip yang sedang aktif.
         * @returns {string} Kalimat yang sudah digenerate.
         */
        function composeSentence(words, allow, script) {
            let sentenceParts = [];
            for (const wordObj of words) {
                let currentWord = wordObj.k; // Default menggunakan kana

                if (script === 'furigana') {
                    // Render furigana jika ada kanji
                    if (wordObj.j && wordObj.j !== wordObj.k) {
                        currentWord = `<ruby>${wordObj.j}<rt>${wordObj.k}</rt></ruby>`;
                    } else {
                        currentWord = wordObj.k; // Jika tidak ada kanji, tampilkan kana saja
                    }
                } else if (script === 'hiragana') {
                    currentWord = wordObj.k.split('').map(toHiragana).join('');
                } else if (script === 'katakana') {
                    currentWord = wordObj.k.split('').map(toKatakana).join('');
                }
                // 'mixed' akan menggunakan apa adanya dari item.k (bisa hiragana/katakana)

                sentenceParts.push(currentWord);
            }

            let sentence = sentenceParts.join(''); // Tanpa spasi untuk bahasa Jepang

            // Terapkan injeksi sokuon dan ch≈çon
            if (allow.allowSokuon) {
                sentence = injectSokuon(sentence, state.sokuonProb / 100, script);
            }
            if (allow.allowChoon && (script === 'katakana' || script === 'mixed' || script === 'furigana')) {
                // Choon hanya untuk Katakana. Jika mixed/furigana, hanya bagian Katakana yang akan terpengaruh.
                // Untuk kesederhanaan, kita akan mencoba injeksi pada seluruh kalimat dan mengandalkan injectChoon
                // untuk hanya memodifikasi karakter Katakana.
                sentence = injectChoon(sentence, state.choonProb / 100);
            }

            return sentence + '„ÄÇ'; // Akhiri kalimat dengan maru
        }

        /**
         * Memastikan kalimat mengandung fitur tertentu jika diaktifkan.
         * @param {string} sentence - Kalimat yang akan dicek.
         * @param {boolean} needYouon - True jika Youon harus ada.
         * @param {boolean} needDakuon - True jika Dakuon/Handakuon harus ada.
         * @param {boolean} needChoon - True jika Ch≈çon harus ada.
         * @returns {boolean} True jika kalimat memenuhi syarat fitur yang dibutuhkan.
         */
        function mustHaveFeature(sentence, needYouon, needDakuon, needChoon){
            if (needYouon && !HAS_YOUON.test(sentence)) return false;
            if (needDakuon && !HAS_DAKUON.test(sentence)) return false;
            if (needChoon && !HAS_CHOON.test(sentence))  return false;
            return true;
        }

        /**
         * Fungsi utama untuk menghasilkan teks berdasarkan pengaturan saat ini.
         */
        function generateText() {
            const currentSettings = {
                gojuon: rdgSubsetGojuon.checked,
                dakuon: rdgSubsetDakuon.checked,
                handakuon: rdgSubsetHandakuon.checked,
                youon: rdgSubsetYouon.checked,
                sokuonProb: state.sokuonProb,
                choonProb: state.choonProb,
            };

            // Validasi: minimal satu kategori subset harus aktif
            const activeSubsets = Object.keys(currentSettings).filter(key => key !== 'sokuonProb' && key !== 'choonProb' && currentSettings[key]);
            if (activeSubsets.length === 0) {
                // Aktifkan Gojuon secara otomatis jika semua dimatikan
                rdgSubsetGojuon.checked = true;
                currentSettings.gojuon = true;
                state.subset.gojuon = true;
                localStorage.setItem('rdg.subset', JSON.stringify(state.subset));
                showToast("Subset terlalu sempit ‚Äî diaktifkan kembali 'Dasar (goj≈´on)'.", 'warn');
            }

            const allowedChars = buildWhitelist(currentSettings);
            const filteredDict = filterDictionary(DICTIONARY, allowedChars, state.script);

            // Optional: Default targetLength to a smaller value if hiragana only and dictionary is small
            if (state.script === 'hiragana' && filteredDict.length < state.targetLength && state.targetLength > 8) {
                state.targetLength = 8;
                rdgTargetLength.value = 8;
                localStorage.setItem('rdg.targetLength', 8);
                showToast("Panjang target kata disesuaikan menjadi 8 karena kamus terbatas untuk Hiragana.", 'info');
            }


            if (filteredDict.length < state.targetLength) {
                rdgOutput.innerHTML = `<p style="color:var(--muted); text-align:center;">
                    Kamus tidak cukup untuk subset ini, atau pengaturan filter terlalu ketat.<br>
                    Coba luaskan filter subset atau kurangi panjang target.
                </p>`;
                showToast("Kamus tidak cukup untuk subset ini. Coba luaskan filter.", 'warn');
                return;
            }

            let fullTextHtml = '';
            for (let p = 0; p < state.paragraphCount; p++) {
                let paragraphText = '';
                for (let s = 0; s < state.sentencePerParagraph; s++) {
                    let sent;
                    let attempts = 0;
                    const maxAttempts = 20; // Batasi percobaan untuk menghindari infinite loop

                    do {
                        sent = generateSmartSentence(allowedChars, state.script);
                        attempts++;
                        if (attempts > maxAttempts) {
                            console.warn("Max attempts reached for generating feature-rich sentence. Proceeding with current sentence.");
                            break; // Keluar dari loop jika terlalu banyak percobaan
                        }
                    } while(!mustHaveFeature(
                        sent,
                        state.subset.youon,
                        state.subset.dakuon || state.subset.handakuon, // Dakuon atau Handakuon
                        (state.script!=='hiragana' && state.choonProb>0)
                    ));
                    paragraphText += sent + '„ÄÇ'; // Tambahkan maru di sini
                }
                fullTextHtml += `<p>${paragraphText}</p>`;
            }

            rdgOutput.innerHTML = fullTextHtml;
        }

        /**
         * Menyalin teks hasil ke clipboard.
         */
        function copyText() {
            const textToCopy = rdgOutput.innerText; // Menggunakan innerText untuk mendapatkan teks tanpa tag ruby
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy'); // Fallback for some environments
            document.body.removeChild(tempTextArea);
            showToast('Teks berhasil disalin!', 'info');
        }

        /**
         * Memutar teks hasil menggunakan Speech Synthesis.
         */
        function speakText() {
            const textToSpeak = rdgOutput.innerText;
            if (!('speechSynthesis' in window)) {
                showToast('Maaf, browser Anda tidak mendukung fitur suara.', 'warn');
                return;
            }
            speechSynthesis.cancel(); // Hentikan pembicaraan sebelumnya
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }

        // --- UI UPDATE & EVENT HANDLERS ---

        /**
         * Memperbarui tampilan slider Sokuon dan Ch≈çon.
         */
        function updateSliderDisplays() {
            rdgSokuonDisplay.textContent = `${state.sokuonProb}%`;
            rdgChoonDisplay.textContent = `${state.choonProb}%`;
        }

        /**
         * Memperbarui status slider Ch≈çon (disabled jika Hiragana).
         */
        function updateChoonSliderState() {
            const isHiraganaScript = state.script === 'hiragana';
            rdgChoonSlider.disabled = isHiraganaScript;
            if (isHiraganaScript) {
                rdgChoonSlider.closest('.rdg-slider-control').style.opacity = '0.6';
                rdgChoonSlider.closest('.rdg-slider-control').style.cursor = 'not-allowed';
            } else {
                rdgChoonSlider.closest('.rdg-slider-control').style.opacity = '1';
                rdgChoonSlider.closest('.rdg-slider-control').style.cursor = 'default';
            }
        }

        /**
         * Menginisialisasi UI kontrol dari localStorage.
         */
        function initializeUI() {
            // Script Selector
            Array.from(rdgScriptSelector.children).forEach(btn => {
                if (btn.dataset.script === state.script) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Subset Checkboxes
            rdgSubsetGojuon.checked = state.subset.gojuon;
            rdgSubsetDakuon.checked = state.subset.dakuon;
            rdgSubsetHandakuon.checked = state.subset.handakuon;
            rdgSubsetYouon.checked = state.subset.youon;

            // Sliders
            rdgSokuonSlider.value = state.sokuonProb;
            rdgChoonSlider.value = state.choonProb;
            updateSliderDisplays();
            updateChoonSliderState();

            // Number inputs
            rdgParagraphCount.value = state.paragraphCount;
            rdgSentencePerParagraph.value = state.sentencePerParagraph;
            rdgTargetLength.value = state.targetLength;
        }

        /**
         * Mengikat semua event listener.
         */
        function bindEventListeners() {
            // Script selector
            rdgScriptSelector.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('button');
                if (targetBtn) {
                    Array.from(rdgScriptSelector.children).forEach(btn => btn.classList.remove('active'));
                    targetBtn.classList.add('active');
                    state.script = targetBtn.dataset.script;
                    localStorage.setItem('rdg.script', state.script);
                    updateChoonSliderState(); // Update ch≈çon slider state based on new script
                }
            });

            // Subset checkboxes
            rdgSubsetControls.addEventListener('change', (e) => {
                const targetCheckbox = e.target;
                if (targetCheckbox.type === 'checkbox' && targetCheckbox.dataset.subset) {
                    state.subset[targetCheckbox.dataset.subset] = targetCheckbox.checked;
                    localStorage.setItem('rdg.subset', JSON.stringify(state.subset));
                }
            });

            // Sliders
            rdgSokuonSlider.addEventListener('input', (e) => {
                state.sokuonProb = parseInt(e.target.value, 10);
                localStorage.setItem('rdg.sokuonProb', state.sokuonProb);
                updateSliderDisplays();
            });
            rdgChoonSlider.addEventListener('input', (e) => {
                state.choonProb = parseInt(e.target.value, 10);
                localStorage.setItem('rdg.choonProb', state.choonProb);
                updateSliderDisplays();
            });

            // Number inputs
            rdgParagraphCount.addEventListener('change', (e) => {
                state.paragraphCount = parseInt(e.target.value, 10);
                localStorage.setItem('rdg.paragraphCount', state.paragraphCount);
            });
            rdgSentencePerParagraph.addEventListener('change', (e) => {
                state.sentencePerParagraph = parseInt(e.target.value, 10);
                localStorage.setItem('rdg.sentencePerParagraph', state.sentencePerParagraph);
            });
            rdgTargetLength.addEventListener('change', (e) => {
                state.targetLength = parseInt(e.target.value, 10);
                localStorage.setItem('rdg.targetLength', state.targetLength);
            });

            // Preset buttons
            rdgPresetButtons.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('button');
                if (targetBtn && targetBtn.dataset.preset) {
                    applyPreset(targetBtn.dataset.preset);
                    generateText(); // Generate text immediately after applying preset
                }
            });

            // Action buttons
            rdgGenerateBtn.addEventListener('click', generateText);
            rdgCopyBtn.addEventListener('click', copyText);
            rdgSpeakBtn.addEventListener('click', speakText);
        }

        /**
         * Menerapkan preset pengaturan ke state dan UI.
         * @param {string} presetName - Nama preset ('beginner', 'intermediate', 'advanced').
         */
        function applyPreset(presetName) {
            let newScript, newSubset, newSokuonProb, newChoonProb, newTargetLength;

            switch (presetName) {
                case 'beginner':
                    newScript = 'hiragana';
                    newSubset = { gojuon: true, dakuon: false, handakuon: false, youon: false };
                    newSokuonProb = 0;
                    newChoonProb = 0;
                    newTargetLength = 6;
                    break;
                case 'intermediate':
                    newScript = 'mixed';
                    newSubset = { gojuon: true, dakuon: true, handakuon: false, youon: true };
                    newSokuonProb = 10;
                    newChoonProb = 10;
                    newTargetLength = 8;
                    break;
                case 'advanced':
                    newScript = 'furigana';
                    newSubset = { gojuon: true, dakuon: true, handakuon: true, youon: true };
                    newSokuonProb = 20;
                    newChoonProb = 30;
                    newTargetLength = 10;
                    break;
                default:
                    return;
            }

            // Update state
            state.script = newScript;
            state.subset = newSubset;
            state.sokuonProb = newSokuonProb;
            state.choonProb = newChoonProb;
            state.targetLength = newTargetLength;

            // Save to localStorage
            localStorage.setItem('rdg.script', state.script);
            localStorage.setItem('rdg.subset', JSON.stringify(state.subset));
            localStorage.setItem('rdg.sokuonProb', state.sokuonProb);
            localStorage.setItem('rdg.choonProb', state.choonProb);
            localStorage.setItem('rdg.targetLength', state.targetLength);

            // Update UI to reflect new state
            initializeUI();
        }

        // --- SIDEBAR JS (konsisten dengan index7.html) ---
        (() => {
            const sidebar  = document.getElementById('sidebar');
            const toggle   = document.getElementById('sidebarToggle');
            const closeBtn = document.getElementById('closeSidebar');

            function open(){ sidebar.classList.add('is-open'); document.body.classList.add('sidebar-open'); }
            function close(){ sidebar.classList.remove('is-open'); document.body.classList.remove('sidebar-open'); }

            toggle?.addEventListener('click', open);
            closeBtn?.addEventListener('click', close);

            document.addEventListener('click', (e)=>{
                if(!sidebar.classList.contains('is-open')) return;
                const hit = sidebar.contains(e.target) || toggle.contains(e.target);
                if(!hit) close();
            });
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

            document.querySelectorAll('#sidebar a').forEach(a=>{
                const href = a.getAttribute('href');
                if(href && location.pathname.endsWith(href)) {
                    a.classList.add('active');
                } else {
                    a.classList.remove('active');
                }
            });
        })();

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            bindEventListeners();
            // Generate initial text on load for a better first experience
            generateText(); 
        });
    </script>
</body>
</html>
