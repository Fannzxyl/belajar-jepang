<!DOCTYPE html>
<html lang="id" data-theme="pastel">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Pelatih Kana Jepang ‚Äî v9</title>
    <meta name="description" content="Pelajari Hiragana & Katakana lengkap (dasar, dakuon/handakuon, youon) dengan tes & review, audio, Pomodoro, progress, tema pastel/kontras, dan kanvas menulis." />
    <meta name="theme-color" content="#7a6cff">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <!-- Diperbarui: URL Github Pages asli -->
    <meta property="og:url" content="https://alfan.github.io/kana-trainer/"> 
    <meta property="og:title" content="Pelatih Kana Jepang ‚Äî v9">
    <meta property="og:description" content="Pelatih Kana Jepang v9 ‚Äî latihan interaktif, audio pelafalan, tes adaptif, Pomodoro, dan kanvas menulis. Progres tersimpan lokal. Mulai gratis sekarang.">
    <!-- Diperbarui: URL Github Pages asli -->
    <meta property="og:image" content="https://alfan.github.io/kana-trainer/kana-trainer-preview.png"> 

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <!-- Diperbarui: URL Github Pages asli -->
    <meta name="twitter:url" content="https://alfan.github.io/kana-trainer/"> 
    <meta name="twitter:title" content="Pelatih Kana Jepang ‚Äî v9">
    <!-- PATCH: Tag twitter:description pakai name, bukan property -->
    <meta name="twitter:description" content="Pelatih Kana Kana Jepang v9 ‚Äî latihan interaktif, audio pelafalan, tes adaptif, Pomodoro, dan kanvas menulis. Progres tersimpan lokal. Mulai gratis sekarang.">
    <!-- Diperbarui: URL Github Pages asli -->
    <meta name="twitter:image" content="https://alfan.github.io/kana-trainer/kana-trainer-preview.png"> 

    <!-- Diperbarui: URL Github Pages asli -->
    <link rel="canonical" href="https://alfan.github.io/kana-trainer/">

    <!-- Favicon -->
    <!-- Diperbarui: Path relatif untuk GitHub Pages -->
    <link rel="icon" href="favicon.ico">
    <!-- PATCH: Fallback SVG inline favicon -->
    <link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%237a6cff'/><stop offset='1' stop-color='%2316c6a1'/></linearGradient></defs><rect width='64' height='64' rx='14' fill='url(%23g)'/><text x='50%' y='54%' text-anchor='middle' font-family='Noto Sans JP,Arial' font-size='38' fill='white'>„ÅÇ</text></svg>">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root{
            --bg:#f8fbff; --panel:#ffffff; --soft:#f2f6ff; --ink:#132030; --muted:#76849c;
            --pri:#7a6cff; --sec:#16c6a1; --warn:#ff7b7b; --ok:#2fb875; --accent:#ffd166;
            --btn:#e9eefc; --btnText:#0b101a; --border:rgba(19,32,48,.10);
            --radius:18px; --shadow:0 6px 18px rgba(15,23,34,.08);
            --ring: 0 0 0 3px rgba(122,108,255,.28);
            --okBg:#dff4ea;
            --warnBg:#ffe5e5;
            --iconColor: var(--muted);
        }
        [data-theme="hc"]{
            --bg:#0a0f1a; --panel:#0f1626; --soft:#0c1220; --ink:#e6efff; --muted:#9fb0cc;
            --pri:#8fa8ff; --sec:#3dd8b5; --warn:#ff8c8c; --ok:#7be0b3; --accent:#ffd98a;
            --btn:#18243a;
            --btnText:#e6efff;
            --border:rgba(230,239,255,.12);
            --ring: 0 0 0 3px rgba(143,168,255,.35);
            --okBg:#1a3a2e;
            --warnBg:#3a1a1a;
            --iconColor: var(--ink);
        }
        *{box-sizing:border-box}
        html { height: auto; }
        body {
            min-height: 100svh;
            margin:0;font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:
            radial-gradient(900px 420px at -10% -20%, rgba(122,108,255,.10), transparent),
            radial-gradient(900px 420px at 110% -30%, rgba(22,198,161,.12), transparent),
            var(--bg);color:var(--ink)}
        .wrap{
            max-width: 720px;
            margin: auto;
            padding: 16px;
            padding-left: calc(16px + env(safe-area-inset-left));
            padding-right: calc(16px + env(safe-area-inset-right));
        }
        header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));backdrop-filter: blur(8px);border-bottom:1px solid var(--border); padding-top:env(safe-area-inset-top)}
        [data-theme="hc"] header{background:linear-gradient(180deg, rgba(15,22,38,.86), rgba(15,22,38,.66))}
        
        .brand{
            display:flex;
            align-items:center;
            gap:12px;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        header .header-controls-row {
            margin-left: 0;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-end;
            margin-top: 0;
            flex-basis: auto;
        }

        @media (max-width: 767px) {
            header { position: static; } 
            .brand {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            header .header-controls-row {
                width: 100%;
                justify-content: flex-start;
                margin-top: 12px;
            }
            header .header-controls-row .seg,
            header .header-controls-row label,
            header .header-controls-row button {
                flex-grow: 1;
                min-width: unset;
            }
        }

        .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--sec));box-shadow:var(--shadow)}
        h1{font-size:20px;margin:0}
        .grid{display:grid;gap:14px;margin-top:16px}
        
        @media(min-width:768px){
            .wrap{max-width: 960px;}
            .grid{grid-template-columns:repeat(12,1fr)}
        }
        @media(min-width:1024px){
            .wrap{max-width: 1200px;}
        }

        .card{grid-column:span 12;background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;border:1px solid var(--border)}
        .card h2{font-size:16px;margin:0 0 10px 0; display: flex; align-items: center; gap: 8px;}
        .card h2 .icon { color: var(--iconColor); }
        .muted{color:var(--muted);font-size:13px}

        input, textarea{
            width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--soft);color:var(--ink);
            transition: border-color 0.2s ease-out, background-color 0.2s ease-out, box-shadow 0.2s ease-out;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        select{
            width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--soft);color:var(--ink);
            transition: border-color 0.2s ease-out, background-color 0.2s ease-out, box-shadow 0.2s ease-out;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2376849c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 36px;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--pri);
            outline: none;
            box-shadow: var(--ring);
        }

        .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
        
        .row input[type="number"],
        .row select {
            flex: 1;
            min-width: 120px;
        }

        @media (max-width: 480px) {
            .row input[type="number"],
            .row select {
                width: 100%;
                flex: none;
            }
        }

        .spacer{height:10px}
        @media(min-width:768px){
            .spacer{height:16px}
        }

        .btn{
            min-height:52px;
            padding: 0 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease-out;
            color: var(--ink);
            background: var(--btn);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active{transform:translateY(1px)}
        .btn.primary{
            background:linear-gradient(135deg, var(--pri), var(--sec));
            color:var(--btnText);
        }
        .btn.ok{
            background:var(--okBg);
            color:var(--ink);
        }
        .btn.warn{
            background:var(--warnBg);
            color:var(--ink);
        }
        .btn.ghost{background:transparent;outline:1px solid var(--border); color: var(--ink);}
        .btn:focus-visible{outline:none; box-shadow:var(--ring); outline-offset: 3px;}

        .seg{display:flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
        .seg button{
            flex:1;
            background:var(--soft);
            border:none;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease-out;
            color: var(--ink);
        }
        .seg button.active{background:linear-gradient(135deg, rgba(122,108,255,.18), rgba(22,198,161,.18))}
        [data-theme="hc"] .seg button.active{background:linear-gradient(135deg, rgba(143,168,255,.15), rgba(61,216,181,.15))}

        .pillbox{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
        @media(min-width:480px){.pillbox{grid-template-columns:repeat(5,1fr)}}
        @media(min-width:680px){.pillbox{grid-template-columns:repeat(6,1fr)}}
        
        .kana{
            min-height:88px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--btn);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.15s ease-out;
            color: var(--ink);
        }
        .kana:active{transform:scale(.98)}
        .kana .jp{font-size:clamp(24px, 6vw, 30px);line-height:1}
        .kana .ro{
            font-size:12px;
            color:var(--muted);
        }
        .kana.mastered {
            background: linear-gradient(135deg, var(--okBg), rgba(47,184,117,.2));
            border-color: var(--ok);
            box-shadow: 0 0 0 2px var(--ok);
        }
        [data-theme="hc"] .kana.mastered {
            background: linear-gradient(135deg, var(--okBg), rgba(61,216,181,.1));
            box-shadow: 0 0 0 2px var(--ok);
        }

        .kana:focus-visible{outline:none; box-shadow:var(--ring)}

        .chips{
            display:flex;
            flex-wrap: wrap;
            gap:8px;
            padding-bottom: 0;
        }
        .chip{
            padding:8px 10px;
            border-radius:999px;
            background:var(--soft);
            border:1px solid var(--border);
            cursor:pointer;
            min-height:36px;
            white-space:nowrap; 
            transition: all 0.2s ease-out;
            color: var(--ink);
        }

        #subsetScroll { flex: 1; min-width: 100%; overflow: visible; white-space: normal; }
        .test-controls-row { display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end }
        .test-controls-row > div { flex-basis:100%; min-width:0 }
        @media (min-width: 768px) { .test-controls-row > div { flex-basis:auto } }

        .row #countChips { flex-wrap:wrap; flex:1; justify-content:flex-start }
        .row #testCount { flex-grow:0; flex-shrink:0 }
        @media (max-width: 767px) {
            .row #testCount { width: calc(50% - 4px) }
            .row .tag { width: calc(50% - 4px); text-align:center }
        }

        .center{text-align:center}
        .small{font-size:12px;color:var(--muted)}
        .tag{
            display:inline-block;padding:4px 8px;border-radius:999px;background:var(--soft);
            color:var(--ink);
            font-size:12px;border:1px solid var(--border);
        }

        .progress{height:10px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
        .bar{height:100%;width:0;background:linear-gradient(90deg,var(--pri),var(--sec),var(--accent));transition:width .25s ease}

        .modal{
            position:fixed; inset:0; display:none;
            align-items:center; justify-content:center;
            background: rgba(0,0,0,.45);
            z-index:999;
        }
        @supports (backdrop-filter: blur(6px)) {
            @media (min-width: 768px) {
                .modal{ background: rgba(0,0,0,.35); backdrop-filter: blur(6px); }
            }
        }

        .modal .box{background:var(--panel);padding:20px 18px;border-radius:18px;box-shadow:var(--shadow);text-align:center;max-width:620px;width:min(92vw,620px)}
        .burst{position:fixed;inset:0;pointer-events:none}
        .particle{position:absolute;width:8px;height:8px;border-radius:2px;opacity:.9;animation:pop 900ms ease forwards}
        @keyframes pop{from{transform:translate(0,0) scale(1)} to{transform:translate(var(--dx), var(--dy)) rotate(360deg) scale(0.8);opacity:0}}

        .optwrap{display:grid;gap:8px;grid-template-columns:repeat(2,1fr);max-width:520px;margin:0 auto}
        @media(min-width:560px){.optwrap{grid-template-columns:repeat(4,1fr)}}
        .optwrap .btn{font-size:16px}

        .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

        @media (max-width: 420px){ :root{ --radius:14px } .kana .jp{ font-size:24px } #qKana{ font-size:56px !important } }

        @keyframes correctPop { 0%{transform:scale(1);background-color:transparent} 50%{transform:scale(1.1);background-color:var(--ok)} 100%{transform:scale(1);background-color:transparent} }
        @keyframes wrongShake { 0%,100%{transform:translateX(0);background-color:transparent} 25%{transform:translateX(-5px);background-color:var(--warn)} 75%{transform:translateX(5px);background-color:var(--warn)} }

        #qKana.correct-answer { animation: correctPop 0.3s ease-out }
        #qKana.wrong-answer { animation: wrongShake 0.3s ease-out }

        #streakCounter { font-size:14px; font-weight:600; color:var(--sec); margin-left:10px; min-width:50px; text-align:right; transition: transform 0.1s ease-out }
        @keyframes streakGrow { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
        #streakCounter.grow { animation: streakGrow 0.2s ease-out }

        /* .spinner { display:none !important } */

        @media (prefers-reduced-motion: reduce){
            *{animation-duration:0.01ms !important; animation-iteration-count:1 !important; transition-duration:0.01ms !important; scroll-behavior:auto !important}
            #qKana.correct-answer, #qKana.wrong-answer, #streakCounter.grow { animation:none !important }
            .toast { transition: none !important; }
        }

        /* === Writer (Latihan Menulis) === */
        .writer-toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
        .writer-toolbar .slider { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted) }
        /* PATCH: Writer layering fix: pastikan kanvas di atas ghost */
        .writer-wrap { position: relative; width: 100%; border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); background: var(--soft); overflow: hidden; }
        #writerCanvas { position: relative; z-index: 1; background: transparent; width: 100%; height: auto; display:block; touch-action: none; }
        .writer-wrap.grid {
            background-image:
                repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent 24px),
                repeating-linear-gradient(90deg, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent 24px);
        }
        [data-theme="hc"] .writer-wrap.grid {
            background-image:
                repeating-linear-gradient(0deg, rgba(230,239,255,.15) 0, rgba(230,239,255,.15) 1px, transparent 1px, transparent 24px),
                repeating-linear-gradient(90deg, rgba(230,239,255,.15) 0, rgba(230,239,255,.15) 1px, transparent 1px, transparent 24px);
        }
        .writer-ghost {
            position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center;
            font-size: clamp(200px, 55vw, 380px);
            line-height:1; user-select:none;
            color: var(--muted);
            opacity: .12;
            filter: saturate(70%);
            /* PATCH: Writer layering fix */
            z-index: 0; 
            pointer-events: none;
        }
        .writer-ghost.hidden { display:none; }

        /* === Anti horizontal overflow global === */
        html, body {
            max-width: 100%;
            overflow-x: hidden; /* cegah scroll horizontal */
        }

        /* Pastikan kontainer utama tidak melebar */
        .wrap, main, header {
            width: 100%;
            max-width: 100%;
        }

        /* Grid aman: kolom tidak memaksa melebar */
        @media (min-width: 768px) {
            .grid { grid-template-columns: repeat(12, minmax(0, 1fr)); }
        }

        /* Pillbox aman di semua breakpoint */
        .pillbox { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        @media (min-width:480px){ .pillbox{ grid-template-columns: repeat(5, minmax(0,1fr)); } }
        @media (min-width:680px){ .pillbox{ grid-template-columns: repeat(6, minmax(0,1fr)); } }

        /* Flex children boleh menyusut (supaya gak mepet dan motong layout) */
        .row > * { min-width: 0; }

        /* Header controls: cegah item ngedorong lebar */
        .header-controls-row > * { min-width: 0; }

        /* Buttons/chips jangan punya min-width besar yang bikin overflow */
        .btn, .chip { max-width: 100%; }

        /* Form controls aman lebar */
        input, select, textarea { max-width: 100%; }

        /* Canvas & media responsif */
        img, video, svg { max-width: 100%; height: auto; display: block; }


        /* Writer wrap sudah overflow: hidden; tambahkan ini supaya tak ‚Äúmelar‚Äù */
        .writer-wrap { max-width: 100%; }

        /* Modal & toast selalu pakai viewport, bukan lebar dokumen yang overflow */
        .modal { inset: 0; }
        /* PATCH: Biar toast selalu center lebar-aman */
        .toast{
          left:50%;
          transform:translateX(-50%);
          max-width:calc(100vw - 24px);
        }

        /* Progress bar dan segmen tidak melebarkan kontainer */
        .progress, .seg { max-width: 100%; }

        /* Perbaiki select dengan background-icon agar tidak menambah lebar total */
        select { background-origin: content-box; }

        /* Pada layar kecil, pastikan kolom kontrol tes tidak memaksa melebar */
        .test-controls-row > div { min-width: 0; }
        .test-control-group { width: 100%; }

        /* PATCH: Desktop layout (‚â•1024px): Pomodoro & Tracker berdampingan */
        @media (min-width: 1024px) {
            main.wrap {
                display: grid;
                grid-template-columns: repeat(12, minmax(0, 1fr));
                gap: 14px;
            }
            /* Default: setiap section full-width */
            main.wrap > section { grid-column: span 12; }
            /* Khusus: Pomodoro & Tracker 50:50 */
            #pomoSection { grid-column: span 6; }
            #trackerSection { grid-column: span 6; }
        }

        /* PATCH: Center subjudul ‚ÄúHiragana ‚Ä¢ Katakana ‚Ä¶ Writer‚Äù */
        header .brand > div:nth-child(2){
          flex: 1 1 auto;
          text-align: center;
        }
        header .brand h1{ margin-bottom: 4px; }
        header .brand .small{ display:block; }

        /* ========== Subset chips: HP vertikal, Laptop horizontal scroll ========== */

        /* HP / default: vertikal satu per baris */
        #subsetChips{
          display: grid !important;          /* pastikan override dari .chips */
          grid-template-columns: 1fr;        /* satu kolom penuh */
          gap: 8px;
          align-items: stretch;
        }
        #subsetChips .chip{
          width: 100%;                       /* biar tombol melebar penuh di HP */
          text-align: center;
        }
        #subsetChips > .small{
          grid-column: 1 / -1;
          text-align: center;
          margin-bottom: 2px;
        }

        /* Laptop/desktop (>=1024px): horizontal, tidak membungkus, bisa di-scroll ke kanan */
        @media (min-width:1024px){
          #subsetChips{
            display: flex !important;
            flex-wrap: nowrap;               /* satu baris saja */
            overflow-x: auto;                /* scroll ke kanan */
            gap: 8px;
            padding-bottom: 6px;
            scroll-snap-type: x proximity;   /* scroll lebih halus */
            -webkit-overflow-scrolling: touch;
          }
          #subsetChips .chip{
            width: auto;                     /* lebar sesuai konten */
            flex: 0 0 auto;                  /* jangan melebar */
            white-space: nowrap;             /* tetap satu baris */
            scroll-snap-align: start;
          }
          /* Biar label "Pilih cepat:" tetap di atas, bukan ikut geser */
          #subsetChips > .small{
            flex: 0 0 100%;
            order: -1;
            margin-bottom: 4px;
            text-align: left;                /* opsional: kiri di desktop */
          }
        }

        /* (Opsional) sembunyikan scrollbar yang kasar di WebKit tanpa mematikan scroll */
        #subsetChips::-webkit-scrollbar{ height: 8px; }
        #subsetChips::-webkit-scrollbar-thumb{ background: var(--border); border-radius: 999px; }
    </style>
</head>
<body>
    <header>
        <div class="wrap">
            <div class="brand" style="gap:10px">
                <!-- PATCH: Ganti div.logo dengan SVG logo -->
                <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="36" height="36">
                    <defs>
                        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                            <stop stop-color="#7a6cff"/><stop offset="1" stop-color="#16c6a1"/>
                        </linearGradient>
                    </defs>
                    <rect width="64" height="64" rx="14" fill="url(#g)"/>
                    <!-- Naik ~2px: pakai dominant-baseline + dy negatif -->
                    <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
                          font-family="Noto Sans JP, 'Noto Serif JP', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"
                          font-size="38" fill="white" dy="-2">„ÅÇ</text>
                </svg>
                <div>
                    <h1>Pelatih Kana Jepang <span class="tag">v9</span></h1>
                    <div class="small">Dasar ‚Ä¢ Dakuon/Handakuon ‚Ä¢ Youon ‚Ä¢ Tes & Review ‚Ä¢ Pomodoro ‚Ä¢ Tema ‚Ä¢ Writer</div>
                </div>
                <div class="row header-controls-row" style="gap:6px">
                    <div class="seg" role="tablist" aria-label="Tema">
                        <button id="tPastel" class="btn" role="tab" aria-selected="true" type="button" title="Tema pastel">Pastel</button>
                        <button id="tHC" class="btn" role="tab" aria-selected="false" type="button" title="Tema high-contrast">Kontras Tinggi</button>
                    </div>
                    <label class="btn ghost" style="display:flex;align-items:center;gap:8px">
                        <input id="audToggle" type="checkbox" aria-label="Suara efek & pelafalan" /> Suara (efek & pelafalan)
                    </label>
                    <button id="exportBtn" class="btn ghost" type="button" title="Simpan progres ke file"><i class="fas fa-download"></i> Simpan Progres ke File</button>
                    <input type="file" id="importFile" accept=".json" style="display:none;" aria-label="Pulihkan progres dari file">
                    <button id="importBtn" class="btn ghost" type="button" title="Pulihkan progres dari file"><i class="fas fa-upload"></i> Pulihkan Progres dari File</button>
                    <button id="resetBtn" class="btn ghost" type="button" title="Atur ulang semua progres">Atur Ulang Semua</button>
                </div>
            </div>
        </div>
    </header>

    <main class="wrap" id="main" style="display: none;">
        <!-- LEARN MODE -->
        <section class="grid" aria-labelledby="learnTitle">
            <div class="card" style="grid-column: span 12;">
                <h2 id="learnTitle"><i class="fas fa-book icon"></i> Belajar (Pilih Rentang Kana)</h2>
                <div class="small">Pilih set (Hiragana/Katakana) dan rentang fleksibel. Ketuk tile untuk dengar pelafalan.</div>
                <div class="spacer"></div>
                <div class="row">
                    <select id="learnSet" aria-label="Pilih set belajar">
                        <option value="hira">Hiragana</option>
                        <option value="kata">Katakana</option>
                    </select>
                    <select id="fromGrp" aria-label="Dari kelompok"></select>
                    <select id="toGrp" aria-label="Sampai kelompok"></select>
                    <button class="btn primary" id="btnShowLearn" type="button"><i class="fas fa-eye"></i> Tampilkan</button>
                </div>
                <div class="spacer"></div>
                <div id="learnTiles" class="pillbox" aria-live="polite">
                    <!-- Empty state for Learn Mode -->
                    <div class="small" style="grid-column: span 4; text-align: center;">Pilih set & rentang dulu, lalu tekan Tampilkan.</div>
                </div>
            </div>
        </section>

        <!-- TEST MODE -->
        <section class="grid" aria-labelledby="testTitle">
            <div class="card" style="grid-column: span 12;">
                <!-- PATCH: Ganti heading & deskripsi bagian Tes jadi lebih pendek -->
                <h2 id="testTitle"><i class="fas fa-pencil-alt icon"></i> Tes</h2>
                <div class="small">
                  Pilih subset atau rentang. Tentukan tipe & mode, lalu jumlah soal.
                </div>
                <div class="spacer"></div>

                <div class="row test-controls-row" style="align-items:flex-end">
                    <div style="flex:1;"> <!-- PATCH: Menghapus width:100% dari inline style -->
                        <!-- PATCH: Hapus inline style display:flex di #subsetChips -->
                        <div class="chips" id="subsetChips">
                            <div class="small" style="margin-bottom: 4px;">Pilih cepat:</div>
                        </div>
                    </div>
                    <select id="testSet" aria-label="Pilih set tes">
                        <option value="hira">Hiragana</option>
                        <option value="kata">Katakana</option>
                    </select>
                    <select id="qType" title="Tipe Soal" aria-label="Tipe soal">
                        <option value="k2r">Kana ‚Üí Romaji</option>
                        <option value="r2k">Romaji ‚Üí Kana (Pilihan Ganda)</option>
                        <option value="seq">Rangkaian Romaji ‚Üí Kana</option>
                    </select>
                    <select id="answerMode" aria-label="Mode jawaban">
                        <option value="type">Mode Ketik</option>
                        <option value="mc">Pilihan Ganda (A‚ÄìD)</option>
                    </select>
                </div>

                <div class="spacer"></div>
                <div class="row test-control-group">
                    <div class="tag" style="align-self: center;">Jumlah soal:</div>
                    <input id="testCount" type="number" min="1" value="10" style="width:100px" aria-label="Jumlah soal" />
                    <div class="chips" id="countChips">
                        <button class="chip" data-count="10" type="button">10</button>
                        <button class="chip" data-count="25" type="button">25</button>
                        <button class="chip" data-count="50" type="button">50</button>
                        <button class="chip" data-count="100" type="button">100</button>
                    </div>
                </div>
                <div class="spacer"></div>
                <div class="row test-control-group">
                    <div class="tag">Atau rentang khusus:</div>
                    <select id="rangeMode" aria-label="Mode rentang">
                        <option value="range">Rentang</option>
                        <option value="single">Grup Tunggal</option>
                    </select>
                    <select id="testFrom" aria-label="Tes dari"></select>
                    <div id="testToWrap"><select id="testTo" aria-label="Tes sampai"></select></div>
                    <select id="testSingleGroup" aria-label="Pilih Grup" hidden></select>
                </div>
                <div class="spacer"></div>
                <div class="row" style="justify-content: center;">
                    <button class="btn primary" id="btnStart" type="button"><i class="fas fa-play"></i> Mulai Tes</button>
                    <button class="btn" id="btnSkip" type="button" title="Lewati soal (‚Üí)"><i class="fas fa-forward"></i> Lewati</button>
                    <button class="btn warn" id="btnEnd" type="button"><i class="fas fa-stop"></i> Selesai</button>
                </div>

                <div class="spacer"></div>
                <div class="progress" aria-label="Progress Tes" role="progressbar" aria-valuemin="0" aria-valuemax="100"><div id="bar" class="bar"></div></div>
                <div class="spacer"></div>
                <div id="testArea" class="center" hidden>
                    <div id="promptWrap" style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap">
                        <div id="qKana" style="font-size:64px;line-height:1.1;margin:6px 0">„ÅÇ</div>
                    </div>
                    <div id="typeWrap" style="max-width:520px;margin:0 auto">
                        <input id="ans" placeholder="Ketik jawaban kamu di sini‚Ä¶" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" inputmode="latin" aria-label="Jawaban" />
                        <div class="spacer"></div>
                        <button class="btn" id="btnCheck" type="button"><i class="fas fa-check"></i> Cek (Enter)</button>
                    </div>
                    <div id="mcWrap" class="optwrap" hidden>
                        <button class="btn opt" id="optA" aria-label="Pilihan A" type="button">A</button>
                        <button class="btn opt" id="optB" aria-label="Pilihan B" type="button">B</button>
                        <button class="btn opt" id="optC" aria-label="Pilihan C" type="button">C</button>
                        <button class="btn opt" id="optD" aria-label="Pilihan D" type="button">D</button>
                        <div class="small" style="grid-column: span 4; text-align: center; margin-top: 4px;">Ketuk atau tekan A/B/C/D</div>
                    </div>
                    <div class="spacer"></div>
                    <div class="small" id="testInfo" aria-live="polite">
                        <span id="testInfoText"></span>
                        <span id="streakCounter">Streak: 0</span>
                    </div>
                </div>
                <div id="testEmptyState" class="small" style="text-align: center; margin-top: 16px;">Setel tipe soal dan jumlah, lalu tekan Mulai Tes.</div>
            </div>
        </section>

        <!-- POMODORO -->
        <section class="grid" aria-labelledby="pomoTitle" id="pomoSection">
            <div class="card">
                <h2 id="pomoTitle"><i class="fas fa-clock icon"></i> Timer Pomodoro (Opsional)</h2>
                <div class="small">Default 25/5, bisa diubah. Status dan sisa waktu tersimpan otomatis.</div>
                <div class="row" role="group" aria-label="Kontrol Pomodoro">
                    <label>
                        <span class="sr-only">Menit fokus</span>
                        <input id="pomoWork" type="number" min="1" value="25" style="width:90px"> menit fokus
                    </label>
                    <label>
                        <span class="sr-only">Menit istirahat</span>
                        <input id="pomoBreak" type="number" min="1" value="5" style="width:90px"> menit istirahat
                    </label>
                    <button class="btn primary" id="pStart" type="button"><i class="fas fa-play"></i> Mulai</button>
                    <button class="btn" id="pPause" type="button"><i class="fas fa-pause"></i> Pause</button>
                    <button class="btn warn" id="pReset" type="button"><i class="fas fa-redo"></i> Reset</button>
                </div>
                <div class="spacer"></div>
                <div class="center">
                    <div id="pomoLabel" class="tag" aria-live="polite">Fokus</div>
                    <div id="pomoTime" style="font-size:32px;margin-top:6px">25:00</div>
                </div>
            </div>
        </section>

        <!-- TRACKER -->
        <section class="grid" aria-labelledby="trackTitle" id="trackerSection">
            <div class="card">
                <h2 id="trackTitle"><i class="fas fa-chart-line icon"></i> Tracker Kana</h2>
                <div class="small">Ketuk untuk tandai sudah hafal. Tahan (long-press) untuk batal.</div>
                <div class="spacer"></div>
                <div class="row">
                    <div style="flex:1;min-width:280px">
                        <div class="muted">Hiragana</div>
                        <div id="hiraBox" class="pillbox"></div>
                    </div>
                    <div style="flex:1;min-width:280px">
                        <div class="muted">Katakana</div>
                        <div id="kataBox" class="pillbox"></div>
                    </div>
                </div>
                <div class="spacer"></div>
                <div class="row">
                    <div class="tag" id="jpStats" aria-live="polite">0/104 hira ‚Ä¢ 0/104 kata</div>
                </div>
                <div class="spacer"></div>
                <div class="row" style="justify-content: center; font-size: 14px;">
                    <span id="totalPointsDisplay">Poin: 0</span>
                    <span style="margin: 0 10px;">‚Ä¢</span>
                    <span id="levelDisplay">Level: 1 (Pemula Kana)</span>
                </div>
            </div>
        </section>

        <!-- WRITER / LATIHAN MENULIS -->
        <section class="grid" aria-labelledby="writerTitle" id="writerSection">
            <div class="card" style="grid-column: span 12;">
                <h2 id="writerTitle"><i class="fas fa-pen-fancy icon"></i> Latihan Menulis (Hiragana/Katakana)</h2>
                <div class="small">Gambar huruf dengan jari/mouse. Nyalakan <b>Panduan</b> untuk meniru bentuk.</div>
                <div class="spacer"></div>

                <div class="row" style="align-items:flex-end">
                    <select id="writeSet" aria-label="Pilih set tulis">
                        <option value="hira">Hiragana</option>
                        <option value="kata">Katakana</option>
                    </select>
                    <select id="writeKana" aria-label="Pilih kana"></select>
                    <button class="btn" id="writePrev" type="button" title="Sebelumnya"><i class="fas fa-chevron-left"></i> Sebelumnya</button>
                    <button class="btn" id="writeNext" type="button" title="Berikutnya">Berikutnya <i class="fas fa-chevron-right"></i></button>
                    <button class="btn" id="writeRand" type="button" title="Acak"><i class="fas fa-shuffle"></i> Acak</button>
                    <button class="btn" id="writeSpeak" type="button" title="Dengar pelafalan kana"><i class="fas fa-volume-up"></i></button>
                </div>

                <div class="spacer"></div>

                <div class="writer-toolbar">
                    <button class="btn ok" id="penBtn" type="button"><i class="fas fa-pen"></i> Pena</button>
                    <button class="btn" id="eraserBtn" type="button"><i class="fas fa-eraser"></i> Penghapus</button>
                    <div class="slider">
                        <label for="penSize">Ukuran</label>
                        <input id="penSize" type="range" min="2" max="28" value="10" style="width:140px">
                    </div>
                    <label class="btn ghost" style="gap:8px">
                        <input id="gridToggle" type="checkbox"> Grid
                    </label>
                    <label class="btn ghost" style="gap:8px">
                        <input id="ghostToggle" type="checkbox"> Panduan
                    </label>
                    <label class="btn ghost" style="gap:8px">
                        <input id="autoSnapToggle" type="checkbox"> Auto-Snap
                    </label>
                    <div style="flex:1"></div>
                    <button class="btn" id="undoStroke" type="button" title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i> Undo</button>
                    <button class="btn warn" id="clearCanvas" type="button"><i class="fas fa-redo"></i> Bersihkan</button>
                    <button class="btn primary" id="savePNG" type="button"><i class="fas fa-download"></i> Simpan PNG</button>
                </div>

                <div class="spacer"></div>

                <div id="writerWrap" class="writer-wrap grid">
                    <canvas id="writerCanvas" width="900" height="900" aria-label="Kanvas menulis"></canvas>
                    <div id="writerGhost" class="writer-ghost" aria-hidden="true">„ÅÇ</div>
                </div>
                <div class="small center" style="margin-top: 8px;">Tips: Tarik cepat untuk garis tipis, pelan untuk lebih tebal.</div>
            </div>
        </section>

    </main>

    <!-- Celebration Modal / Review -->
    <div id="celebrate" class="modal" aria-modal="true" role="dialog" aria-labelledby="celebrateTitle" aria-describedby="celebrateMsg">
        <div class="box">
            <h3 id="celebrateTitle" style="margin:0 0 6px 0">Tes selesai! üéâ</h3>
            <div id="celebrateMsg" class="small">Skor: 0/0</div>
            <div class="spacer"></div>
            <div id="reviewWrap" style="text-align:left;max-height:40vh;overflow:auto;margin:8px 0" hidden></div>
            <div class="row" style="justify-content:center">
                <button class="btn" id="btnReviewWrong" hidden type="button"><i class="fas fa-redo-alt"></i> Belajar ulang yang salah</button>
                <button class="btn primary" id="btnCloseModal" type="button"><i class="fas fa-times"></i> Lanjut</button>
            </div>
        </div>
        <div id="burst" class="burst" aria-hidden="true"></div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="modal" aria-modal="true" role="dialog" aria-labelledby="onboardingTitle" aria-describedby="onboardingMsg" hidden>
        <div class="box">
            <h3 id="onboardingTitle" style="margin:0 0 6px 0">Selamat Datang di Pelatih Kana Jepang! üëã</h3>
            <div id="onboardingMsg" class="small">
                <p>Aplikasi ini akan membantumu menguasai Hiragana & Katakana.</p>
                <p><b>1. Belajar:</b> Pilih set & rentang, ketuk huruf buat dengar pelafalan.</p>
                <p><b>2. Tes:</b> Atur tipe soal (Kana ‚Üí Romaji, Romaji ‚Üí Kana, atau Rangkaian) & jumlah soal. Kamu bisa ketik atau pilih jawaban.</p>
                <p><b>3. Menulis:</b> Latih goresanmu di kanvas. Aktifkan "Panduan" untuk menjiplak, dan "Auto-Snap" kalau mau dibantu rapi.</p>
            </div>
            <div class="spacer"></div>
            <div class="row" style="justify-content:center">
                <button class="btn primary" id="btnStartLearningOnboarding" type="button">Mulai Belajar!</button>
            </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Escapes HTML entities in a string to prevent XSS.
         * @param {string} str - The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeHTML(str){
            return String(str)
                .replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;')
                .replaceAll('"','&quot;')
                .replaceAll("'",'&#39;');
        }

        // ---------- GLOBAL COPY / TEXTS ----------
        const copy = {
            nav_learn: 'Belajar',
            nav_test: 'Tes',
            nav_tracker: 'Tracker',
            nav_writer: 'Menulis',
            nav_timer: 'Timer',
            btn_show: 'Tampilkan',
            btn_start_test: 'Mulai Tes',
            btn_check: 'Cek Jawaban',
            btn_skip: 'Lewati',
            btn_end: 'Selesai',
            writer_hint: 'Tips: Tarik cepat untuk garis tipis, pelan untuk lebih tebal.',
            empty_learn: 'Pilih set & rentang dulu, lalu tekan Tampilkan.',
            empty_test: 'Setel tipe soal dan jumlah, lalu tekan Mulai Tes.',
            empty_review: 'Bersih! Nggak ada jawaban keliru. üëç',
            done_test_title: 'Tes selesai! üéâ',
            done_test_sub: (s,t)=>`Skor kamu ${s}/${t}. Bagus!`,
            wrong_tip_dzu: 'Ingat:„Å¢ = dji (ji), „Å• = dzu (zu).', // Specific tip for dji/dzu
            confirm_reset_title: 'Atur ulang semua progres?',
            confirm_reset_sub: 'Tindakan ini tidak bisa dibatalkan.',
            import_ok: 'Impor progres berhasil!',
            import_fail: 'Ups, file-nya nggak cocok. Pastikan kamu pilih file progres yang benar (JSON).',
            export_ok: 'Progres berhasil diekspor sebagai kana-progress.json!',
            level_up_title: (level)=>`Level Up! üéâ Level ${level}!`,
            level_up_msg: (name)=>`Kamu sekarang seorang ${name}! Terus semangat! üî•`,
            // PATCH: Perbaikan karakter di streak_title
            streak_title: 'Wii! Keren banget! ‚ú®',
            streak_msg: '10 jawaban benar berturut-turut. Lanjutkan momentummu! ‚ú®',
            pomo_focus: 'Fokus',
            pomo_break: 'Istirahat',
            pomo_start_focus: (time)=>`Fokus dimulai. ${time} ‚Äî semangat!`,
            pomo_time_break: 'Waktunya istirahat. Minum air dulu ü•§',
            test_info_text: (set, range, qType, total, target)=>`${set} ‚Ä¢ ${range} ‚Ä¢ ${qType} ‚Ä¢ Soal ${total}/${target}`,
            test_streak: (streak)=>`Streak: ${streak}`,
            test_mc_hint: 'Ketuk atau tekan A/B/C/D',
            learn_tile_tooltip: 'Ketuk untuk dengar, tahan untuk batal',
            writer_guide_hint: 'Tips: Tarik cepat untuk garis tipis, pelan untuk lebih tebal.',
            onboarding_title: 'Selamat Datang di Pelatih Kana Jepang! üëã',
            onboarding_step1: '<b>1. Belajar:</b> Pilih set & rentang, ketuk huruf buat dengar pelafalan.',
            onboarding_step2: '<b>2. Tes:</b> Atur tipe soal (Kana ‚Üí Romaji, Romaji ‚Üí Kana, atau Rangkaian) & jumlah soal. Kamu bisa ketik atau pilih jawaban.',
            onboarding_step3: '<b>3. Menulis:</b> Latih goresanmu di kanvas. Aktifkan "Panduan" untuk menjiplak, dan "Auto-Snap" kalau mau dibantu rapi.',
            onboarding_button_start: 'Mulai Belajar!',
            feedback_correct: (kana, romaji) => `Mantap! ${kana} = ${romaji} ‚úÖ`,
            feedback_wrong: (kana, romaji, user_input) => `Belum pas. ${kana} dibaca ${romaji}. Jawaban kamu: ${user_input}. Coba lagi ya.`,
            feedback_wrong_dji_dzu: (kana, romaji, user_input) => `Belum pas. ${kana} dibaca ${romaji} (boleh juga ji/zu). Jawaban kamu: ${user_input}. Coba lagi ya.`,
            feedback_skipped: 'Oke, kita lanjut dulu.',
            writer_snap_success: 'Rapi! Bentuknya sudah pas üëå',
            writer_snap_fail: 'Hampir! Coba garisnya sedikit lebih melengkung.',
        };

        const t = (key, ...args) => {
            let text = copy[key] || `MISSING_COPY_KEY: ${key}`;
            if (typeof text === 'function') {
                return text(...args);
            }
            return text;
        };

        // ---------- STATE ----------
        const KEY = 'kanaTrainer_v9';
        const initState = () => ({
            theme:'pastel',
            audio:false,
            hiraMastered:[], kataMastered:[],
            test:{
                subset:'aiueo', set:'hira', mode:'type', qType:'k2r',
                score:0, total:0, correctStreak:0, target:10, rangeMode:'range'
            },
            pomo:{mode:'work', work:25, break:5, remaining:25*60, running:false, last:0},
            totalPoints: 0,
            level: 1,
            writer: {
                set: 'hira',
                kana: 'a',
                penSize: 10,
                eraser: false,
                grid: true,
                ghost: true,
                ghostOpacity: 0.12,
                autoSnap: false,
                snapThreshold: 0.52,
            },
            hasSeenOnboarding: false
        });
        let state = load();
        let _saveTimer = null;
        function load(){
            try{
                const raw=localStorage.getItem(KEY);
                const loadedState = raw ? JSON.parse(raw) : initState();
                const mergedState = { ...initState(), ...loadedState };
                mergedState.test = deepMerge(initState().test, loadedState.test);
                mergedState.pomo = deepMerge(initState().pomo, loadedState.pomo);
                mergedState.writer = deepMerge(initState().writer, loadedState.writer);
                mergedState.hasSeenOnboarding = loadedState.hasSeenOnboarding !== undefined ? loadedState.hasSeenOnboarding : initState().hasSeenOnboarding;
                return mergedState;
            }catch(e){
                console.error("Error loading state from localStorage:", e);
                return initState();
            }
        }
        function save(){
            clearTimeout(_saveTimer);
            _saveTimer=setTimeout(()=>{
                try{ localStorage.setItem(KEY, JSON.stringify(state)); }
                catch(e){ console.error("Error saving state to localStorage:", e); }
            }, 150);
        }

        function deepMerge(target, source) {
            for (const key in source) {
                if (source.hasOwnProperty(key)) {
                    if (typeof source[key] === 'object' && source[key] !== null && !Array.isArray(source[key]) && typeof target[key] === 'object' && target[key] !== null && !Array.isArray(target[key])) {
                        target[key] = deepMerge(target[key] || {}, source[key]);
                    } else {
                        target[key] = source[key];
                    }
                }
            }
            return target;
        }

        // ---------- DATA ----------
        const BASE = ['a','i','u','e','o','ka','ki','ku','ke','ko','sa','shi','su','se','so','ta','chi','tsu','te','to','na','ni','nu','ne','no','ha','hi','fu','he','ho','ma','mi','mu','me','mo','ya','yu','yo','ra','ri','ru','re','ro','wa','wo','n'];
        const DAKUON = [
            'ga','gi','gu','ge','go',
            'za','ji','zu','ze','zo',
            'da','dji','dzu','de','do',
            'ba','bi','bu','be','bo','pa','pi','pu','pe','po'
        ];
        const YOUON = ['kya','kyu','kyo','sha','shu','sho','cha','chu','cho','nya','nyu','nyo','hya','hyu','hyo','mya','myu','myo','rya','ryu','ryo','gya','gyu','gyo','ja','ju','jo','bya','byu','byo','pya','pyu','pyo'];

        const HIRA_BASE = ['„ÅÇ','„ÅÑ','„ÅÜ','„Åà','„Åä','„Åã','„Åç','„Åè','„Åë','„Åì','„Åï','„Åó','„Åô','„Åõ','„Åù','„Åü','„Å°','„Å§','„Å¶','„Å®','„Å™','„Å´','„Å¨','„Å≠','„ÅÆ','„ÅØ','„Å≤','„Åµ','„Å∏','„Åª','„Åæ','„Åø','„ÇÄ','„ÇÅ','„ÇÇ','„ÇÑ','„ÇÜ','„Çà','„Çâ','„Çä','„Çã','„Çå','„Çç','„Çè','„Çí','„Çì'];
        const KATA_BASE = ['„Ç¢','„Ç§','„Ç¶','„Ç®','„Ç™','„Ç´','„Ç≠','„ÇØ','„Ç±','„Ç≥','„Çµ','„Ç∑','„Çπ','„Çª','„ÇΩ','„Çø','„ÉÅ','„ÉÑ','„ÉÜ','„Éà','„Éä','„Éã','„Éå','„Éç','„Éé','„Éè','„Éí','„Éï','„Éò','„Éõ','„Éû','„Éü','„É†','„É°','„É¢','„É§','„É¶','„É®','„É©','„É™','„É´','„É¨','„É≠','„ÉØ','„É≤','„É≥'];

        // FIX: Karakter Hiragana Dakuon dan Handakuten yang benar
        const HIRA_DAKU = ['„Åå','„Åé','„Åê','„Åí','„Åî','„Åñ','„Åò','„Åö','„Åú','„Åû','„Å†','„Å¢','„Å•','„Åß','„Å©','„Å∞','„Å≥','„Å∂','„Åπ','„Åº','„Å±','„Å¥','„Å∑','„Å∫','„ÅΩ'];
        const KATA_DAKU = ['„Ç¨','„ÇÆ','„Ç∞','„Ç≤','„Ç¥','„Ç∂','„Ç∏','„Ç∫','„Çº','„Çæ','„ÉÄ','„ÉÇ','„ÉÖ','„Éá','„Éâ','„Éê','„Éì','„Éñ','„Éô','„Éú','„Éë','„Éî','„Éó','„Éö','„Éù'];

        const HIRA_YOU = ['„Åç„ÇÉ','„Åç„ÇÖ','„Åç„Çá','„Åó„ÇÉ','„Åó„ÇÖ','„Åó„Çá','„Å°„ÇÉ','„Å°„ÇÖ','„Å°„Çá','„Å´„ÇÉ','„Å´„ÇÖ','„Å´„Çá','„Å≤„ÇÉ','„Å≤„ÇÖ','„Å≤„Çá','„Åø„ÇÉ','„Åø„ÇÖ','„Åø„Çá','„Çä„ÇÉ','„Çä„ÇÖ','„Çä„Çá','„Åé„ÇÉ','„Åé„ÇÖ','„Åé„Çá','„Åò„ÇÉ','„Åò„ÇÖ','„Åò„Çá','„Å≥„ÇÉ','„Å≥„ÇÖ','„Å≥„Çá','„Å¥„ÇÉ','„Å¥„ÇÖ','„Å¥„Çá'];
        const KATA_YOU = ['„Ç≠„É£','„Ç≠„É•','„Ç≠„Éß','„Ç∑„É£','„Ç∑„É•','„Ç∑„Éß','„ÉÅ„É£','„ÉÅ„É•','„ÉÅ„Éß','„Éã„É£','„Éã„É•','„Éã„Éß','„Éí„É£','„Éí„É•','„Éí„Éß','„Éü„É£','„Éü„É•','„Éü„Éß','„É™„É£','„É™„É•','„É™„Éß','„ÇÆ„É£','„ÇÆ„É•','„ÇÆ„Éß','„Ç∏„É£','„Ç∏„É•','„Ç∏„Éß','„Éì„É£','„Éì„É•','„Éì„Éß','„Éî„É£','„Éî„É•','„Éî„Éß'];

        const GROUPS = [
            {key:'aiueo', label:'a i u e o', list:BASE, idx:[0,1,2,3,4]},
            {key:'k', label:'ka ki ku ke ko', list:BASE, idx:[5,6,7,8,9]},
            {key:'s', label:'sa shi su se so', list:BASE, idx:[10,11,12,13,14]},
            {key:'t', label:'ta chi tsu te to', list:BASE, idx:[15,16,17,18,19]},
            {key:'n', label:'na ni nu ne no', list:BASE, idx:[20,21,22,23,24]},
            {key:'h', label:'ha hi fu he ho', list:BASE, idx:[25,26,27,28,29]},
            {key:'m', label:'ma mi mu me mo', list:BASE, idx:[30,31,32,33,34]},
            {key:'y', label:'ya yu yo', list:BASE, idx:[35,36,37]},
            {key:'r', label:'ra ri ru re ro', list:BASE, idx:[38,39,40,41,42]},
            {key:'w', label:'wa wo n', list:BASE, idx:[43,44,45]},
            {key:'g', label:'ga gi gu ge go', list:DAKUON, idx:[0,1,2,3,4]},
            {key:'z', label:'za ji zu ze zo', list:DAKUON, idx:[5,6,7,8,9]},
            {key:'d', label:'da dji dzu de do', list:DAKUON, idx:[10,11,12,13,14]},
            {key:'b', label:'ba bi bu be bo', list:DAKUON, idx:[15,16,17,18,19]},
            {key:'p', label:'pa pi pu pe po', list:DAKUON, idx:[20,21,22,23,24]},
            {key:'ky', label:'kya kyu kyo', list:YOUON, idx:[0,1,2]},
            {key:'sh', label:'sha shu sho', list:YOUON, idx:[3,4,5]},
            {key:'ch', label:'cha chu cho', list:YOUON, idx:[6,7,8]},
            {key:'ny', label:'nya nyu nyo', list:YOUON, idx:[9,10,11]},
            {key:'hy', label:'hya hyu hyo', list:YOUON, idx:[12,13,14]},
            {key:'my', label:'mya myu myo', list:YOUON, idx:[15,16,17]},
            {key:'ry', label:'rya ryu ryo', list:YOUON, idx:[18,19,20]},
            {key:'gy', label:'gya gyu gyo', list:YOUON, idx:[21,22,23]},
            {key:'j',  label:'ja ju jo', list:YOUON, idx:[24,25,26]},
            {key:'by', label:'bya byu byo', list:YOUON, idx:[27,28,29]},
            {key:'py', label:'pya pyu pyo', list:YOUON, idx:[30,31,32]},
        ];

        const HIRA_MAP = new Map();
        const KATA_MAP = new Map();
        BASE.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_BASE[i]);KATA_MAP.set(r,KATA_BASE[i])});
        DAKUON.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_DAKU[i]);KATA_MAP.set(r,KATA_DAKU[i])});
        YOUON.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_YOU[i]);KATA_MAP.set(r,KATA_YOU[i])});

        const ALL_ROMAJI = [...new Set([...BASE,...DAKUON,...YOUON])];
        const ROMAJI_SORTED = [...ALL_ROMAJI].sort((a,b)=>b.length-a.length);

        const CONFUSE_KATA = [
            ['„Ç∑','„ÉÑ'], ['„ÇΩ','„É≥'], ['„ÇØ','„Ç±'], ['„Éï','„ÉØ'], ['„ÉÇ','„Ç∏'], ['„ÉÖ','„Ç∫'],
            ['„Éé','„É°'], ['„Ç§','„É™'], ['„Ç®','„É±'], ['„Éç','„É¨'], ['„Ç¢','„Éû'], ['„É†','Âé∂']
        ];
        function similarChoicesKata(correct){
            for(const g of CONFUSE_KATA) {
                if(g.includes(correct)) {
                    return g.filter(x=>x!==correct);
                }
            }
            return [];
        }

        // ---------- UI HELPERS ----------
        const qs = (s,el=document)=>el.querySelector(s);
        const qsa = (s,el=document)=>[...el.querySelectorAll(s)];
        const df = ()=>document.createDocumentFragment();

        /**
         * Safely binds an event listener to an element.
         * Prevents errors if the element does not exist.
         * @param {string} selector - CSS selector for the element.
         * @param {string} eventType - The type of event (e.g., 'click', 'change', 'keydown').
         * @param {function} handler - The event handler function.
         * @param {object} [options] - Optional event listener options (e.g., { passive: true }).
         */
        function bind(selector, eventType, handler, options) {
            const element = qs(selector);
            if (element) {
                element.addEventListener(eventType, handler, options);
            } else {
                console.warn(`Element with selector "${selector}" not found for event binding.`);
            }
        }

        // ---------- TRACKER ----------
        function buildKana(boxId, set){
            const box = qs('#'+boxId); box.innerHTML='';
            const rom = ALL_ROMAJI; const map = set==='hira'? HIRA_MAP: KATA_MAP; const mastered = set==='hira'? state.hiraMastered: state.kataMastered;
            const frag=df();
            rom.forEach(r=>{
                const ch = map.get(r);
                const b = document.createElement('button'); b.type='button';
                b.className='kana' + (mastered.includes(r) ? ' mastered' : '');
                b.innerHTML=`<div class="jp">${escapeHTML(ch)}</div><div class="ro">${escapeHTML(r)}</div>`; // Escape kana/romaji
                b.title=t('learn_tile_tooltip');
                b.setAttribute('aria-pressed', mastered.includes(r));
                attachLongPress(b, ()=>toggleMaster(r,set), ()=>uncheck(r,set));
                frag.appendChild(b);
            });
            box.appendChild(frag);
        }
        function toggleMaster(label, set){
            const arr=(set==='hira'?state.hiraMastered:state.kataMastered);
            const i=arr.indexOf(label);
            if(i<0) {
                arr.push(label);
                state.totalPoints += 5;
                checkLevelUp();
            } else {
                state.totalPoints = Math.max(0, state.totalPoints - 5);
            }
            save();
            renderStats();
            buildKana(set==='hira'?'hiraBox':'kataBox', set);
            updatePointsAndLevelDisplay();
        }
        function uncheck(label,set){
            const arr=(set==='hira'?state.hiraMastered:state.kataMastered);
            const i=arr.indexOf(label);
            if(i>-1){
                arr.splice(i,1);
                state.totalPoints = Math.max(0, state.totalPoints - 5);
                save();
                renderStats();
                buildKana(set==='hira'?'hiraBox':'kataBox', set);
                updatePointsAndLevelDisplay();
            }
        }
        function renderStats(){ qs('#jpStats').textContent = `${state.hiraMastered.length}/${ALL_ROMAJI.length} hira ‚Ä¢ ${state.kataMastered.length}/${ALL_ROMAJI.length} kata`; }

        // Gamification: Leveling system
        const LEVEL_THRESHOLDS = [0, 100, 250, 500, 1000, 2000, 3500, 5000, 7500, 10000];
        const LEVEL_NAMES = ["Pemula Kana", "Pengenal Kana", "Penyelidik Kana", "Penjelajah Kana", "Master Kana", "Sensei Kana", "Grandmaster Kana", "Kana Legendaris", "Dewa Kana", "Kana Abadi"];

        function getLevelAndThreshold(points) {
            let level = 1;
            let threshold = LEVEL_THRESHOLDS[0];
            let nextThreshold = LEVEL_THRESHOLDS[1] || Infinity;

            for (let i = 0; i < LEVEL_THRESHOLDS.length; i++) {
                if (points >= LEVEL_THRESHOLDS[i]) {
                    level = i + 1;
                    threshold = LEVEL_THRESHOLDS[i];
                    nextThreshold = LEVEL_THRESHOLDS[i + 1] || Infinity;
                } else {
                    break;
                }
            }
            return { level, threshold, nextThreshold };
        }

        function checkLevelUp() {
            const { level: oldLevel } = getLevelAndThreshold(state.totalPoints - 1); 
            const { level: newLevel } = getLevelAndThreshold(state.totalPoints);

            if (newLevel > oldLevel) {
                state.level = newLevel;
                save();
                maybeCelebrate('levelUp', newLevel); 
            }
        }

        function updatePointsAndLevelDisplay() {
            const totalPointsDisplay = qs('#totalPointsDisplay');
            const levelDisplay = qs('#levelDisplay');
            if (totalPointsDisplay) totalPointsDisplay.textContent = `Poin: ${state.totalPoints}`;
            if (levelDisplay) {
                const { level, nextThreshold } = getLevelAndThreshold(state.totalPoints);
                const currentLevelName = LEVEL_NAMES[level - 1] || `Level ${level}`;
                let progressText = '';
                if (nextThreshold !== Infinity) {
                    const pointsCurrentLevel = state.totalPoints - (LEVEL_THRESHOLDS[level - 1] || 0);
                    const pointsNeededForNext = nextThreshold - (LEVEL_THRESHOLDS[level - 1] || 0);
                    if (pointsNeededForNext > 0) {
                        progressText = ` (${pointsCurrentLevel}/${pointsNeededForNext})`;
                    } else {
                        progressText = ``; 
                    }
                } else {
                    progressText = ` (MAX)`;
                }
                levelDisplay.textContent = `Level: ${level} ${currentLevelName}${progressText}`;
            }
        }

        // ---------- LEARN MODE ----------
        function fillLearnRange(){ const fromSel=qs('#fromGrp'), toSel=qs('#toGrp'); fromSel.innerHTML=''; toSel.innerHTML=''; GROUPS.forEach(g=>{ const o1=new Option(g.label,g.key); const o2=new Option(g.label,g.key); fromSel.add(o1); toSel.add(o2); }); fromSel.value='aiueo'; toSel.value='k'; }
        function startLearn(){
            const set=qs('#learnSet').value;
            const from=qs('#fromGrp').value, to=qs('#toGrp').value;
            const labels = rangeLabels(from,to);
            const map = set==='hira'?HIRA_MAP:KATA_MAP;
            // PATCH: Mendefinisikan 'mastered' di sini
            const mastered = set==='hira'? state.hiraMastered: state.kataMastered;
            const box=qs('#learnTiles');
            box.innerHTML='';
            if(!labels.length){
                box.innerHTML=`<div class="small" style="grid-column: span 4; text-align: center;">${t('empty_learn')}</div>`;
                return;
            }
            const frag=df();
            labels.forEach(r=>{
                const ch = map.get(r);
                const tile=document.createElement('button');
                tile.type='button';
                tile.className='kana' + (mastered.includes(r) ? ' mastered' : '');
                tile.innerHTML=`<div class="jp">${escapeHTML(ch)}</div><div class="ro">${escapeHTML(r)}</div>`; // Escape kana/romaji
                tile.title=t('learn_tile_tooltip');
                tile.onclick=()=> speak(ch); // Use escaped char for speak
                frag.appendChild(tile);
            });
            box.appendChild(frag);
        }

        // ---------- TEST MODE ----------
        let testPool=[], poolIdx=[], usingRange=false, qIndex=0, currentItem=null, mcMap={}, wrongList=[];
        function fillTestRange(){
            const tf=qs('#testFrom'), tt=qs('#testTo'), ts=qs('#testSingleGroup');
            tf.innerHTML=''; tt.innerHTML=''; ts.innerHTML='';
            GROUPS.forEach(g=>{
                tf.add(new Option(g.label,g.key));
                tt.add(new Option(g.label,g.key));
                ts.add(new Option(g.label,g.key));
            });
            tf.value='aiueo';
            tt.value='k';
            ts.value='aiueo';
            qs('#rangeMode').value = state.test.rangeMode;
            toggleRangeInputs();
        }

        function buildSubsetChips(){
            const box=qs('#subsetChips');
            const existingText = box.querySelector('.small');
            box.innerHTML='';
            if (existingText) {
                box.appendChild(existingText);
            } else {
                const hint = document.createElement('div');
                hint.className = 'small';
                hint.style.marginBottom = '4px';
                hint.textContent = 'Pilih cepat:';
                box.appendChild(hint);
            }

            const frag=df();
            GROUPS.forEach(g=>{
                const b=document.createElement('button');
                b.type='button';
                b.className='chip'+(state.test.subset===g.key?' active':'');
                b.setAttribute('aria-pressed', state.test.subset===g.key);
                b.textContent=g.label;
                b.onclick=()=>{ state.test.subset=g.key; save(); buildSubsetChips(); };
                frag.appendChild(b);
            });
            box.appendChild(frag);
        }

        function startTest(){
            wrongList=[];
            const set=qs('#testSet').value; state.test.set=set;
            const mode=qs('#answerMode').value; state.test.mode=mode;
            const qType=qs('#qType').value; state.test.qType=qType;
            const rangeMode = qs('#rangeMode').value; state.test.rangeMode = rangeMode;
            const req = Math.max(1, parseInt(qs('#testCount').value,10)||10);
            
            const labels = buildPoolLabels();
            let uniquePoolItems = labels.map(r=>({romaji:r, char: (set==='hira'?HIRA_MAP:KATA_MAP).get(r)}));

            if(!uniquePoolItems.length){ showCustomAlert('Pilih subset atau rentang yang valid.'); return; }

            testPool = [];
            let currentUniqueItems = [...uniquePoolItems];
            shuffle(currentUniqueItems);
            testPool = testPool.concat(currentUniqueItems);

            if (req > uniquePoolItems.length) {
                while (testPool.length < req) {
                    let shuffledRepeat = [...uniquePoolItems];
                    shuffle(shuffledRepeat);
                    testPool = testPool.concat(shuffledRepeat);
                }
                testPool = testPool.slice(0, req);
            }
            
            poolIdx = labels.map(r=> ALL_ROMAJI.indexOf(r)).filter(x=>x>=0);

            state.test.target = req;
            state.test.score=0; state.test.total=0; state.test.correctStreak=0; qIndex=0; save();
            qs('#testArea').hidden=false;
            qs('#testEmptyState').hidden = true;
            updateProgress();
            nextQ();
        }

        function toggleAnswerUI(){
            const typeWrap = qs('#typeWrap');
            const mcWrap = qs('#mcWrap');
            const answerModeSelect = qs('#answerMode');
            const qTypeSelect = qs('#qType');

            const mode = answerModeSelect.value;
            const qType = qTypeSelect.value;

            typeWrap.style.display = 'none';
            mcWrap.style.display = 'none';
            answerModeSelect.disabled = false;

            if (qType === 'seq') {
                typeWrap.style.display = 'block';
                answerModeSelect.value = 'type';
                answerModeSelect.disabled = true;
            } else if (qType === 'r2k') {
                mcWrap.style.display = 'grid';
                answerModeSelect.value = 'mc';
                answerModeSelect.disabled = true;
            } else {
                if (mode === 'type') {
                    typeWrap.style.display = 'block';
                } else {
                    mcWrap.style.display = 'grid';
                }
            }
        }

        // PATCH: Panggil finishTest() di endTest()
        function endTest(){
            // Tampilkan hasil dan review dulu
            finishTest();
            // Lalu sembunyikan area tes (opsional)
            qs('#testArea').hidden = true;
            qs('#testEmptyState').hidden = false;
            updateProgress();
        }

        function nextQ(){
            if(state.test.total>=state.test.target){ finishTest(); return; }
            if(!testPool.length){ qs('#qKana').textContent='Selesai!'; return; }
            currentItem = testPool[qIndex % testPool.length]; const qType=state.test.qType; const ansEl=qs('#ans'); if(ansEl) ansEl.value='';
            
            if(qType==='seq'){
                const seq = makeSequence(poolIdx, state.test.set);
                currentItem = {...currentItem, seq};
                qs('#qKana').textContent=`Romaji: ${escapeHTML(seq.romaji)}`;
                qs('#qKana').style.fontSize='28px';
            }
            else if(qType==='k2r'){
                qs('#qKana').textContent=escapeHTML(currentItem.char);
                qs('#qKana').style.fontSize='64px';
            }
            else {
                qs('#qKana').textContent=escapeHTML(currentItem.romaji);
                qs('#qKana').style.fontSize='36px';
                buildMC_r2k(currentItem);
            }

            if(qs('#answerMode').value === 'mc' && qs('#qType').value === 'k2r') {
                buildMC_k2r(currentItem);
            }

            updateTestInfo();
            toggleAnswerUI();
            setTimeout(()=>{
                const tw = qs('#typeWrap');
                if (tw && getComputedStyle(tw).display !== 'none') ansEl && ansEl.focus();
            }, 30);
        }

        function mcPick(letter){
            const qType=state.test.qType;
            const val=mcMap[letter];
            let correct=false;
            if(qType==='k2r'){
                correct = (val===currentItem.romaji);
            } else if(qType==='r2k'){
                correct = (val=== (state.test.set==='hira'? HIRA_MAP.get(currentItem.romaji): KATA_MAP.get(currentItem.romaji)));
            }
            finalizeAnswer(correct, {chosen:val});
        }

        function normalizeRomajiSequence(s){
            return (s||'').toLowerCase()
                .replace(/\s+/g,'')
                .replace(/di/g,'dji')
                .replace(/du/g,'dzu');
        }
        function romajiEquals(a,b){
            if (!a || !b) return false;
            if (a === b) return true;
            if (b==='wo' && a==='o') return true;
            const canon = (t)=> t
                .replace(/^ji$/,'dji')
                .replace(/^zu$/,'dzu');
            return canon(a) === canon(b);
        }

        function checkAns(){
            const valRaw=(qs('#ans')?.value||'').trim();
            const qType=state.test.qType;
            let correct=false;
            let normalized='';

            if(qType==='k2r'){
                const norm = normalizeRomaji(valRaw);
                normalized = norm;
                correct = romajiEquals(norm, currentItem.romaji);
            }
            else if(qType==='seq' || qType==='r2k'){
                const expectedKana = (qType==='seq')
                    ? currentItem.seq.kana
                    : (state.test.set==='hira'? HIRA_MAP.get(currentItem.romaji): KATA_MAP.get(currentItem.romaji));

                const rawSeq = normalizeRomajiSequence(valRaw);
                const userKana = hasKana(valRaw) ? rawSeq : romajiStringToKana(rawSeq, state.test.set);
                normalized = userKana;
                correct = (userKana === expectedKana);
            }
            finalizeAnswer(correct, {typed:valRaw, normalized});
        }

        function finalizeAnswer(correct, extra){
            const qKanaElement = qs('#qKana');
            const streakCounterElement = qs('#streakCounter');
            const currentKanaChar = currentItem.char;
            const currentRomaji = currentItem.romaji;
            const userInput = extra.typed || extra.chosen || extra.normalized || '-';

            state.test.total+=1;
            if(correct){
                state.test.score+=1;
                state.test.correctStreak+=1;
                state.totalPoints += 1;
                checkLevelUp();
                maybeCelebrate('streak');
                clickTone('ok');
                qKanaElement.classList.add('correct-answer');
                if (streakCounterElement) streakCounterElement.classList.add('grow');
                // PATCH: Konsistensi penerimaan jawaban dji/dzu
                let okMsg = t('feedback_correct', escapeHTML(currentKanaChar), escapeHTML(currentRomaji));
                const ui = (extra.typed || extra.normalized || '').toLowerCase();
                if ((currentRomaji === 'dji' && ['ji','di'].includes(ui)) || (currentRomaji === 'dzu' && ['zu','du'].includes(ui))) {
                    okMsg += ` (jawaban kamu "${escapeHTML(ui)}" diterima)`;
                }
                showToast(okMsg);
            } else {
                state.test.correctStreak=0;
                wrongList.push({...currentItem, ...extra});
                clickTone('bad');
                qKanaElement.classList.add('wrong-answer');
                let feedbackMsg = t('feedback_wrong', escapeHTML(currentKanaChar), escapeHTML(currentRomaji), escapeHTML(userInput));
                if ((currentRomaji === 'dji' || currentRomaji === 'dzu') && (userInput === 'ji' || userInput === 'zu' || userInput === 'di' || userInput === 'du')) {
                    feedbackMsg = t('feedback_wrong_dji_dzu', escapeHTML(currentKanaChar), escapeHTML(currentRomaji), escapeHTML(userInput));
                }
                showToast(feedbackMsg, 'warn');
            }

            setTimeout(() => {
                qKanaElement.classList.remove('correct-answer', 'wrong-answer');
                if (streakCounterElement) streakCounterElement.classList.remove('grow');
            }, 300);

            updateProgress();
            if(state.test.total>=state.test.target){ finishTest(); return; }
            qIndex=(qIndex+1)%testPool.length;
            save();
            nextQ();
        }

        function shuffleReturn(arr){ const a=[...arr]; shuffle(a); return a; }

        // PATCH: Pilihan ganda K->R kadang ngambil opsi dari luar rentang
        function buildMC_k2r(item){
            const labels = currentPoolLabels().filter(r => r !== item.romaji);
            const sameLen = labels.filter(r => r.length === item.romaji.length);
            let decoys = shuffleReturn(sameLen).slice(0,3);
            if (decoys.length < 3) {
                decoys = [...decoys, ...shuffleReturn(labels).slice(0, 3 - decoys.length)];
            }
            const pool = [item.romaji, ...decoys].slice(0,4);
            const uniq = [...new Set(pool)];
            while (uniq.length < 4) {
                const fallback = labels.find(r => !uniq.includes(r));
                if (!fallback) break;
                uniq.push(fallback);
            }
            shuffle(uniq);
            mcMap = {A:uniq[0], B:uniq[1], C:uniq[2], D:uniq[3]};
            setMCText({A:`A. ${escapeHTML(mcMap.A)}`,B:`B. ${escapeHTML(mcMap.B)}`,C:`C. ${escapeHTML(mcMap.C)}`,D:`D. ${escapeHTML(mcMap.D)}`});
        }
        function buildMC_r2k(item){
            const chars=currentPoolChars();
            const labels=currentPoolLabels();
            const idx = labels.indexOf(item.romaji);
            const correct = chars[idx];

            const pool=[correct];

            if (state.test.set==='kata'){
                const sim = similarChoicesKata(correct);
                pool.push(...sim.slice(0,2));
            }

            const other = chars.filter((c)=>c!==correct && !pool.includes(c));
            shuffle(other);
            pool.push(...other.slice(0, 4 - pool.length));
            shuffle(pool);

            mcMap={A:pool[0],B:pool[1],C:pool[2],D:pool[3]};
            setMCText({A:`A. ${escapeHTML(mcMap.A)}`,B:`B. ${escapeHTML(mcMap.B)}`,C:`C. ${escapeHTML(mcMap.C)}`,D:`D. ${escapeHTML(mcMap.D)}`});
        }
        function setMCText(map){ ['A','B','C','D'].forEach(k=>{ const el=qs('#opt'+k); if(el) el.textContent=map[k]; }); }

        function skipQ(){
            clickTone('click');
            showToast(t('feedback_skipped'));
            if(!testPool.length){ return; }
            qIndex=(qIndex+1)%testPool.length;
            nextQ();
        }

        function updateTestInfo(){
            const rangeMode = qs('#rangeMode').value;
            let rangeLabel;
            if (rangeMode === 'single') {
                const singleKey = qs('#testSingleGroup').value;
                const grp = GROUPS.find(x => x.key === singleKey);
                rangeLabel = grp ? grp.label : 'Grup Tunggal';
            } else {
                const sKey = qs('#testFrom').value;
                const eKey = qs('#testTo').value;
                const grpFrom = GROUPS.find(x => x.key === sKey);
                const grpTo = GROUPS.find(x => x.key === eKey);
                rangeLabel = (grpFrom && grpTo) ? `${grpFrom.label} - ${grpTo.label}` : 'Rentang khusus';
            }

            const tlabel = state.test.qType==='k2r'? 'Kana‚ÜíRomaji' : state.test.qType==='r2k'? 'Romaji‚ÜíKana' : 'Rangkaian';
            const testInfoTextElement = qs('#testInfoText');
            const streakCounterElement = qs('#streakCounter');

            if (testInfoTextElement) {
                testInfoTextElement.textContent = t('test_info_text', state.test.set==='hira'?'Hiragana':'Katakana', rangeLabel, tlabel, state.test.total, state.test.target);
            }
            if (streakCounterElement) streakCounterElement.textContent = t('test_streak', state.test.correctStreak);
        }

        function updateProgress(value){
            const pct = (state.test.total/state.test.target)*100;
            const bar = qs('#bar');
            if (bar) bar.style.width = pct+'%';
            const prog = qs('.progress');
            if (prog) prog.setAttribute('aria-valuenow', Math.round(pct));
        }

        function finishTest(){
            openCelebrate('finish');
            burst();
            clickTone('ok');
            renderReview();
            updatePointsAndLevelDisplay();
        }

        function renderReview(){
            const box=qs('#reviewWrap');
            const hasWrong = wrongList.length>0;
            if (qs('#btnReviewWrong')) qs('#btnReviewWrong').hidden=!hasWrong;
            if (box) box.hidden=!hasWrong;
            if (qs('#celebrateMsg')) qs('#celebrateMsg').textContent=t('done_test_sub', state.test.score, state.test.total);
            if(!hasWrong){
                if (box) box.innerHTML=`<div class="small" style="text-align: center; margin-top: 8px;">${t('empty_review')}</div>`;
                return;
            }
            const set=state.test.set;
            if (box) {
                box.innerHTML = wrongList.map((w,i)=>{
                    const expectedKana = (set==='hira'? HIRA_MAP.get(w.romaji): KATA_MAP.get(w.romaji));
                    const expectedRomaji = w.romaji;
                    const got = w.chosen||w.normalized||w.typed||'-';
                    const leftDisplay = (state.test.qType==='k2r') ? (set==='hira'? HIRA_MAP.get(w.romaji): KATA_MAP.get(w.romaji)) : w.romaji;

                    let displayExpected = expectedRomaji;
                    let displayGiven = got;

                    if ((expectedRomaji === 'dji' && (got === 'ji' || got === 'di')) || (expectedRomaji === 'dzu' && (got === 'zu' || got === 'du'))) {
                        displayExpected = `${expectedRomaji}`;
                        displayGiven = `${got}`;
                    } else if (state.test.qType === 'r2k' || state.test.qType === 'seq') {
                        displayExpected = expectedKana;
                        displayGiven = hasKana(got) ? got : romajiStringToKana(got, set);
                        if (!displayGiven) displayGiven = got;
                    }

                    const safeLeft = escapeHTML(leftDisplay);
                    const safeExpRomaji = escapeHTML(displayExpected);
                    const safeExpKana = escapeHTML(expectedKana);
                    const safeGiven = escapeHTML(w.typed ? `${w.typed} (${displayGiven})` : displayGiven);

                    return `<div style="padding:8px;border:1px solid var(--border);border-radius:12px;margin:6px 0;display:flex;justify-content:space-between;gap:8px">
                                <div>
                                    <div class="small">Soal ${i+1}</div>
                                    <div><b>${safeLeft}</b> ‚Üí <span style="color:var(--ok)">${safeExpRomaji} (${safeExpKana})</span></div>
                                    <div class="small">Jawaban kamu: ${safeGiven}</div>
                                </div>
                                <button class="btn" onclick="window._speak('${escapeHTML(expectedKana)}')" type="button" aria-label="Putar pelafalan ${escapeHTML(expectedKana)}">üéß</button>
                            </div>`;
                }).join('');
            }
        }

        bind('#btnReviewWrong', 'click', ()=>{ if(!wrongList.length) return; const set=state.test.set; const labels=[...new Set(wrongList.map(w=>w.romaji))]; testPool = labels.map(r=>({romaji:r, char: (set==='hira'?HIRA_MAP:KATA_MAP).get(r)})); poolIdx = labels.map(r=>ALL_ROMAJI.indexOf(r)).filter(x=>x>=0); state.test.total=0; state.test.score=0; state.test.correctStreak=0; state.test.target = Math.min(20, testPool.length); qIndex=0; closeCelebrate(); qs('#testArea').hidden=false; updateProgress(); nextQ(); });

        function buildPoolLabels(){
            const rangeMode = qs('#rangeMode').value;
            let labels = [];
            if (rangeMode === 'single') {
                const singleKey = qs('#testSingleGroup').value;
                const grp = GROUPS.find(x => x.key === singleKey);
                if (grp) labels = grp.idx.map(i => grp.list[i]);
            } else {
                const sKey = qs('#testFrom').value;
                const eKey = qs('#testTo').value;
                const selFrom=GROUPS.findIndex(x=>x.key===sKey);
                const selTo=GROUPS.findIndex(x=>x.key===eKey);
                if(selFrom > -1 && selTo > -1){
                    const [from,to]= selFrom<=selTo? [selFrom,selTo] : [selTo,selFrom];
                    labels = GROUPS.slice(from,to+1).flatMap(g=> g.idx.map(i=> g.list[i] ));
                }
            }
            return labels;
        }

        function rangeLabels(fromKey,toKey){ const a=GROUPS.findIndex(g=>g.key===fromKey); const b=GROUPS.findIndex(g=>g.key===toKey); if(a<0||b<0) return []; const [from,to] = a<=b? [a,b]:[b,a]; return GROUPS.slice(from,to+1).flatMap(g=> g.idx.map(i=> g.list[i]) ); }
        function currentPoolLabels(){ return testPool.map(x=>x.romaji); }
        function currentPoolChars(){ return testPool.map(x=>x.char); }

        function toggleRangeInputs() {
            const rangeMode = qs('#rangeMode').value;
            const testFrom = qs('#testFrom');
            const testToWrap = qs('#testToWrap');
            const testSingleGroup = qs('#testSingleGroup');

            if (testFrom) testFrom.hidden = (rangeMode === 'single');
            if (testToWrap) testToWrap.hidden = (rangeMode === 'single');
            if (testSingleGroup) testSingleGroup.hidden = !(rangeMode === 'single');
        }

        // ---------- THEME & AUDIO ----------
        function applyTheme(){
            document.documentElement.setAttribute('data-theme', state.theme==='hc'?'hc':'pastel');
            const isHC = state.theme==='hc';
            const bPastel = qs('#tPastel'), bHC = qs('#tHC');
            if (bPastel) {
                bPastel.classList.toggle('active', !isHC);
                bPastel.setAttribute('aria-selected', String(!isHC));
            }
            if (bHC) {
                bHC.classList.toggle('active', isHC);
                bHC.setAttribute('aria-selected', String(isHC));
            }
            if (typeof writerSetGhostChar === 'function') writerSetGhostChar();
            if (typeof writerRedrawAll === 'function') writerRedrawAll();
            // PATCH: Meta ‚Äútheme-color‚Äù tidak ikut berubah saat ganti tema
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) {
              const bg = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim() || (isHC ? '#0f1626' : '#ffffff');
              metaTheme.setAttribute('content', bg);
            }
        }
        function applyAudio(){ const ck=qs('#audToggle'); if (ck) ck.checked = !!state.audio; }

        // Reused AudioContext for performance
        let _audioCtx = null;
        function clickTone(kind){
            try{
                if(!state.audio) return;
                const C = window.AudioContext || window.webkitAudioContext;
                if(!C) return;
                _audioCtx = _audioCtx || new C();
                const ctx = _audioCtx;
                const o=ctx.createOscillator();
                const g=ctx.createGain();
                o.connect(g);
                g.connect(ctx.destination);
                o.type='sine';
                o.frequency.setValueAtTime(kind==='ok'? 960: kind==='bad'? 260: 520, ctx.currentTime);
                g.gain.setValueAtTime(0.0001, ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(kind==='bad'?0.25:0.12, ctx.currentTime+0.01);
                o.start();
                setTimeout(()=>{
                    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.2);
                    o.stop(ctx.currentTime+0.22);
                }, 150);
            }catch(e){ console.error('Error playing sound:', e); }
        }

        // TTS function to speak the kana character
        function speak(text){
            try{
                if(!state.audio) return;
                if(!('speechSynthesis' in window)) return;
                speechSynthesis.cancel();
                const u=new SpeechSynthesisUtterance(text);
                u.lang='ja-JP';
                u.rate=.9; u.pitch=1.02; u.volume=1;
                speechSynthesis.speak(u);
            }catch(error){ console.error('Error speaking text:', error); }
        }
        window._speak = speak;

        let currentToast = null;
        let toastTimeout = null;
        function showToast(message, type = 'info', duration = 2500) {
            if (currentToast) {
                currentToast.remove();
                clearTimeout(toastTimeout);
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.position = 'fixed';
            // Rely solely on CSS for left: 50vw and transform: translateX(-50%)
            toast.style.bottom = '20px';
            toast.style.padding = '10px 15px';
            toast.style.borderRadius = '8px';
            toast.style.backgroundColor = type === 'warn' ? 'var(--warnBg)' : 'var(--okBg)';
            toast.style.color = 'var(--ink)';
            toast.style.boxShadow = 'var(--shadow)';
            toast.style.zIndex = '1000';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s ease-in-out';
            toast.textContent = message; // Use textContent for safety
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'polite');

            document.body.appendChild(toast);
            currentToast = toast;
            // PATCH: Ekspor currentToast ke window agar override tidak bentrok
            window.currentToast = toast; 

            setTimeout(() => {
                if (currentToast === toast) {
                    toast.style.opacity = '1';
                }
            }, 10);

            toastTimeout = setTimeout(() => {
                if (currentToast === toast) {
                    toast.style.opacity = '0';
                }
            }, duration);

            toast.addEventListener('transitionend', function handler() {
                if (toast.style.opacity === '0') {
                    toast.remove();
                    if (currentToast === toast) {
                        currentToast = null;
                        window.currentToast = null; // Clear global reference
                    }
                    toast.removeEventListener('transitionend', handler);
                }
            });
        }


        // ---------- CELEBRATION ----------
        const modal = qs('#celebrate'); const burstBox = qs('#burst');
        let _escCloseListener = null;
        let _modalKeydownListener = null;

        function maybeCelebrate(type, level = 0){
            const isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            if(type==='streak' && state.test.correctStreak>0 && state.test.correctStreak % 10 === 0){
                openCelebrate('streak');
                if (!isReducedMotion) burst();
                clickTone('ok');
            } else if (type === 'levelUp') {
                if (qs('#celebrateTitle')) qs('#celebrateTitle').textContent = t('level_up_title', level); 
                if (qs('#celebrateMsg')) qs('#celebrateMsg').textContent = t('level_up_msg', LEVEL_NAMES[level-1] || `Level ${level}`);
                openCelebrate('levelUp');
                if (!isReducedMotion) burst();
                clickTone('ok');
            }
        }
        function openCelebrate(mode){
            const title=qs('#celebrateTitle'), msg=qs('#celebrateMsg');
            if(mode==='finish'){
                if (title) title.textContent=t('done_test_title');
                if (msg) msg.textContent=t('done_test_sub', state.test.score, state.test.total);
            } else if (mode === 'levelUp') {
                // Text already set in maybeCelebrate
            } else { // streak
                if (title) title.textContent=t('streak_title');
                if (msg) msg.textContent=t('streak_msg');
            }
            if (modal) modal.style.display='flex';
            _trapModal();
        }

        function closeCelebrate(){
            if (modal) modal.style.display='none';
            void document.body.offsetHeight;
            requestAnimationFrame(()=>{
                document.documentElement.style.transform='translateZ(0)';
                setTimeout(()=> document.documentElement.style.transform='', 0);
            });

            if (_escCloseListener) {
                document.removeEventListener('keydown', _escCloseListener);
                _escCloseListener = null;
            }
            if (_modalKeydownListener) {
                modal.removeEventListener('keydown', _modalKeydownListener);
                _modalKeydownListener = null;
            }
        }
        bind('#btnCloseModal', 'click', closeCelebrate);

        function _escClose(e){
            if(e.key==='Escape') {
                closeCelebrate();
                const ansEl = qs('#ans');
                if (ansEl && !qs('#testArea').hidden && getComputedStyle(qs('#typeWrap')).display !== 'none') {
                    ansEl.focus();
                }
            }
        }

        function _trapModal(){
            if (!modal) return; // Guard against null modal
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            const focusables = modal.querySelectorAll(focusableElements);
            const firstFocusable = focusables[0];
            const lastFocusable = focusables[focusables.length - 1];

            if (!_escCloseListener) {
                _escCloseListener = _escClose;
                document.addEventListener('keydown', _escCloseListener);
            }
            
            if (!_modalKeydownListener) {
                _modalKeydownListener = (e) => {
                    const isTabPressed = (e.key === 'Tab' || e.keyCode === 9);

                    if (!isTabPressed) {
                        return;
                    }

                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            lastFocusable.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            firstFocusable.focus();
                            e.preventDefault();
                        }
                    }
                };
                modal.addEventListener('keydown', _modalKeydownListener);
            }

            firstFocusable?.focus();
        }

        function burst(){ 
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                return;
            }
            if (!burstBox) return; // Guard against null
            burstBox.innerHTML=''; 
            const colors=['#7a6cff','#16c6a1','#ffd166','#ff7b7b','#2fb875','#8acbff']; 
            const w=window.innerWidth, h=window.innerHeight; 
            for(let i=0;i<90;i++){ 
                const p=document.createElement('div'); 
                p.className='particle'; 
                p.style.background=colors[i%colors.length]; 
                const dx=(Math.random()*w - w/2)+'px'; 
                const dy=(Math.random()*h/2)+'px'; 
                p.style.setProperty('--dx',dx); 
                p.style.setProperty('--dy',dy); 
                p.style.left=(w/2)+'px'; 
                p.style.top=(h/3)+'px'; 
                burstBox.appendChild(p);
            } 
            setTimeout(()=>{ burstBox.innerHTML=''; }, 1000); 
        }

        function showCustomAlert(message) {
            const tempModal = document.createElement('div');
            tempModal.className = 'modal';
            tempModal.setAttribute('role', 'alertdialog');
            tempModal.setAttribute('aria-modal', 'true');
            tempModal.innerHTML = `
                <div class="box">
                    <h3 id="customAlertTitle" style="margin:0 0 6px 0">${escapeHTML(message)}</h3>
                    <div class="spacer"></div>
                    <button class="btn primary" id="customAlertOk" type="button">OK</button>
                </div>
            `;
            document.body.appendChild(tempModal);
            tempModal.style.display = 'flex';
            const okBtn = tempModal.querySelector('#customAlertOk');
            if (okBtn) {
                okBtn.onclick = () => {
                    tempModal.remove();
                };
                okBtn.focus();
            }
        }

        function showCustomConfirm(message, onConfirm) {
            const tempModal = document.createElement('div');
            tempModal.className = 'modal';
            tempModal.setAttribute('role', 'dialog');
            tempModal.setAttribute('aria-modal', 'true');
            tempModal.innerHTML = `
                <div class="box">
                    <h3 id="customConfirmTitle" style="margin:0 0 6px 0">${escapeHTML(message)}</h3>
                    <div class="spacer"></div>
                    <div class="row" style="justify-content:center">
                        <button class="btn warn" id="customConfirmCancel" type="button">Batal</button>
                        <button class="btn primary" id="customConfirmOk" type="button">Ya</button>
                    </div>
                </div>
            `;
            document.body.appendChild(tempModal);
            tempModal.style.display = 'flex';
            const okBtn = tempModal.querySelector('#customConfirmOk');
            const cancelBtn = tempModal.querySelector('#customConfirmCancel');

            if (okBtn && cancelBtn) {
                okBtn.onclick = () => {
                    tempModal.remove();
                    onConfirm(true);
                };
                cancelBtn.onclick = () => {
                    tempModal.remove();
                    onConfirm(false);
                };
                okBtn.focus();
            }
        }


        // ---------- POMODORO ----------
        let pomoHandle=null;
        function upPomoLabel(){ if (qs('#pomoLabel')) qs('#pomoLabel').textContent = state.pomo.mode==='work'? t('pomo_focus'):t('pomo_break'); }
        function drawRemain(){ const m=String(Math.floor(state.pomo.remaining/60)).padStart(2,'0'); const s=String(state.pomo.remaining%60).padStart(2,'0'); if (qs('#pomoTime')) qs('#pomoTime').textContent=`${m}:${s}`; }
        const fmt = (sec)=>`${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;

        function startPomo(){
            state.pomo.work = Math.max(1, parseInt(qs('#pomoWork')?.value,10)||25);
            state.pomo.break = Math.max(1, parseInt(qs('#pomoBreak')?.value,10)||5);
            if(!state.pomo.running){
                state.pomo.running=true;
                state.pomo.last=Date.now();
                if(state.pomo.remaining<=0) state.pomo.remaining = state.pomo.work*60;
                showToast(t('pomo_start_focus', fmt(state.pomo.work * 60)), 'info', 3000);
                save();
            }
            tickPomo();
            if(!pomoHandle) pomoHandle=setInterval(tickPomo, 250);
        }
        function pausePomo(){ state.pomo.running=false; save(); if(pomoHandle){ clearInterval(pomoHandle); pomoHandle=null; } }
        function resetPomo(){ pausePomo(); state.pomo.mode='work'; state.pomo.remaining = state.pomo.work*60; upPomoLabel(); drawRemain(); save(); }
        function tickPomo(){
            if(!state.pomo.running) return;
            const now=Date.now();
            const dt=Math.floor((now - state.pomo.last)/1000);
            if(dt<=0){ return; }
            state.pomo.last = now;
            state.pomo.remaining = Math.max(0, state.pomo.remaining - dt);
            if(state.pomo.remaining===0){
                clickTone('ok');
                if(state.pomo.mode==='work'){
                    state.pomo.mode='break';
                    state.pomo.remaining=state.pomo.break*60;
                    showToast(t('pomo_time_break'), 'info', 3000);
                } else {
                    state.pomo.mode='work';
                    state.pomo.remaining=state.pomo.work*60;
                    showToast(t('pomo_start_focus', fmt(state.pomo.work * 60)), 'info', 3000);
                }
                upPomoLabel();
            }
            drawRemain();
            save();
        }

        // ---------- NORMALISASI & KONVERSI ----------
        function hasKana(s){ return /[„ÅÅ-„Çì„Ç°-„É≥]/.test(s); }
        function normalizeRomaji(v){
            v=(v||'').toLowerCase().trim();
            const alias = {
                si:'shi', ti:'chi', tu:'tsu', hu:'fu', wo:'o',
                di:'dji', du:'dzu',
            };
            return alias[v] || v;
        }

        function romajiStringToKana(str,set){
            let s=(str||'').toLowerCase().replace(/\s+/g,'');
            let out='';
            while(s.length){
                let matched=false;
                if(s[0]==='n'){
                    if(s[1]==='n'){ out += (set==='hira'? '„Çì':'„É≥'); s=s.slice(2); matched=true; continue; }
                    const next=s[1]||'';
                    if(next && !'aeiouy'.includes(next)){ out += (set==='hira'? '„Çì':'„É≥'); s=s.slice(1); matched=true; continue; }
                }
                for(const r of ROMAJI_SORTED){
                    if(s.startsWith(r)){
                        out += (set==='hira'? HIRA_MAP.get(r): KATA_MAP.get(r));
                        s=s.slice(r.length);
                        matched=true;
                        break;
                    }
                }
                if(!matched){
                    if(/^[bcdfghjklmnpqrstvwxyz]\1/.test(s)){
                        out += (set==='hira'? '„Å£':'„ÉÉ'); s=s.slice(1); matched=true; continue;
                    }
                    s=s.slice(1);
                }
            } return out;
        }

        function makeSequence(idxArr,set){
            const src = idxArr.length? idxArr.map(i=>ALL_ROMAJI[i]) : ALL_ROMAJI;
            const len = 2 + Math.floor(Math.random()*2);
            const picks=[];
            for(let i=0;i<len;i++){ const r = src[Math.floor(Math.random()*src.length)]; picks.push(r); }
            const romaji=picks.join('');
            const kana=romajiStringToKana(romaji,set);
            return {romaji,kana};
        }

        // ---------- UTILS ----------
        function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
        function attachLongPress(el, onClick, onLong){ let t=null, long=false; const down=()=>{ long=false; t=setTimeout(()=>{ long=true; onLong&&onLong(); }, 500); }; const up=()=>{ clearTimeout(t); if(!long) onClick&&onClick(); }; el.addEventListener('pointerdown', down, {passive:true}); el.addEventListener('pointerup', up, {passive:true}); el.addEventListener('pointerleave', ()=>clearTimeout(t), {passive:true}); el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); onClick&&onClick(); } }); }

        // ---------- WRITER (Latihan Menulis) ----------
        let wCanvas, wCtx, wWrap, wGhost, isDrawing=false, lastX=0, lastY=0, dpr=1;
        const wStrokes = [];
        let _writerBound = false;

        function writerInitDOMRefs() {
            wCanvas = qs('#writerCanvas');
            wWrap   = qs('#writerWrap');
            wGhost  = qs('#writerGhost');
            wCtx    = wCanvas?.getContext('2d'); // Guard against null
        }
        function writerSetupCanvasSize() {
            if (!wCanvas || !wWrap || !wCtx) return; // Guard against null
            const rect = wWrap.getBoundingClientRect();
            if (rect.width === 0) {
                requestAnimationFrame(writerSetupCanvasSize);
                return;
            }
            dpr = Math.max(1, window.devicePixelRatio || 1);
            const size = Math.floor(rect.width);
            wCanvas.style.width = size + 'px';
            wCanvas.style.height = size + 'px';
            wCanvas.width  = Math.floor(size * dpr);
            wCanvas.height = Math.floor(size * dpr);
            wCtx.setTransform(1,0,0,1,0,0);
            wCtx.scale(dpr, dpr);
            writerRedrawAll();
        }
        function writerCurrentChar() {
            const r = state.writer.kana;
            return state.writer.set==='hira' ? HIRA_MAP.get(r) : KATA_MAP.get(r);
        }
        function writerSetGhostChar() {
            if (!wGhost) return;
            const ch = writerCurrentChar() || '„ÅÇ';
            wGhost.textContent = ch;
            wGhost.style.opacity = state.writer.ghost ? state.writer.ghostOpacity : 0;
            wGhost.classList.toggle('hidden', !state.writer.ghost);
        }
        function writerSetGrid(on) { if (wWrap) wWrap.classList.toggle('grid', !!on); }
        // PATCH: Ganti fungsi writerStrokeStyle() (supaya selalu solid & nggak ‚Äúketahan‚Äù state lama)
        function writerStrokeStyle() {
            if (!wCtx) return;
            wCtx.globalAlpha = 1; // pastikan selalu terlihat
            wCtx.lineCap = 'round';
            wCtx.lineJoin = 'round';
            wCtx.strokeStyle = state.theme==='hc' ? '#e6efff' : '#132030';
            wCtx.globalCompositeOperation = state.writer.eraser ? 'destination-out' : 'source-over';
            wCtx.lineWidth = state.writer.penSize;
        }
        function writerPointerPos(e) {
            if (!wCanvas) return {x:0, y:0}; // Guard against null
            const rect = wCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            return { x: Math.max(0, Math.min(rect.width, x)), y: Math.max(0, Math.min(rect.height, y)) };
        }
        function writerStart(e) {
            if (!wCanvas) return; // Guard against null
            e.preventDefault();
            const p = writerPointerPos(e);
            isDrawing = true;
            lastX = p.x; lastY = p.y;
            wStrokes.push({ ops: state.writer.eraser ? 'destination-out' : 'source-over', size: state.writer.penSize, points: [{x:lastX, y:lastY}] });
        }

        let _raf = null, _lastMove = null;
        function writerMove(e) {
            if(!isDrawing || !wCtx) return; // Guard against null
            _lastMove = e;
            if(_raf) return;
            _raf = requestAnimationFrame(() => {
                _raf = null;
                const p = writerPointerPos(_lastMove);
                const s = wStrokes[wStrokes.length-1];
                if (s && s.points) {
                    s.points.push({x:p.x, y:p.y});
                }
                writerStrokeStyle();
                wCtx.beginPath();
                wCtx.moveTo(lastX, lastY);
                wCtx.lineTo(p.x, p.y);
                wCtx.stroke();
                lastX = p.x; lastY = p.y;
            });
        }

        function writerEnd() {
            if (!wCtx) return; // Guard against null
            isDrawing=false;
            if (_raf) {
                cancelAnimationFrame(_raf);
                _raf = null;
                if (_lastMove) {
                    const p = writerPointerPos(_lastMove);
                    const s = wStrokes[wStrokes.length-1];
                    if (s && s.points) {
                        s.points.push({x:p.x, y:p.y});
                    }
                    writerStrokeStyle();
                    wCtx.beginPath();
                    wCtx.moveTo(lastX, lastY);
                    wCtx.lineTo(p.x, p.y);
                    wCtx.stroke();
                    lastX = p.x; lastY = p.y;
                }
            }
            if (state.writer.autoSnap) {
                writerEvaluateAndSnap();
            }
        }

        function writerRedrawAll() {
            if(!wCtx || !wCanvas) return; // Guard against null
            wCtx.setTransform(1,0,0,1,0,0);
            wCtx.clearRect(0,0,wCanvas.width,wCanvas.height);
            wCtx.scale(dpr, dpr);
            wCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--soft');
            wCtx.fillRect(0, 0, wCanvas.width, wCanvas.height);

            for(const s of wStrokes){
                wCtx.globalCompositeOperation = s.ops;
                wCtx.lineWidth = s.size;
                wCtx.lineCap='round'; wCtx.lineJoin='round';
                wCtx.strokeStyle = state.theme==='hc' ? '#e6efff' : '#132030';
                wCtx.beginPath();
                if (s.points.length > 0) {
                    wCtx.moveTo(s.points[0].x, s.points[0].y);
                    for(let i=1;i<s.points.length;i++){
                        const b=s.points[i];
                        // PATCH: Perbaikan ReferenceError di writerRedrawAll()
                        wCtx.lineTo(b.x, b.y);
                    }
                }
                wCtx.stroke();
            }
        }
        function writerUndo() { if(!wStrokes.length) return; wStrokes.pop(); writerRedrawAll(); }
        function writerClear() { wStrokes.length = 0; writerRedrawAll(); }
        function writerSavePNG() {
            if (!wCanvas) return; // Guard against null
            const tmp = document.createElement('canvas');
            tmp.width = wCanvas.width; tmp.height = wCanvas.height;
            const tctx = tmp.getContext('2d');
            if (!tctx) return; // Guard against null
            const panel = getComputedStyle(document.documentElement).getPropertyValue('--panel') || '#fff';
            tctx.fillStyle = panel.trim() || '#fff';
            tctx.fillRect(0,0,tmp.width,tmp.height);
            tctx.drawImage(wCanvas, 0, 0);
            const url = tmp.toDataURL('image/png');
            const a = document.createElement('a');
            const fileName = `kana-${state.writer.kana}-${state.writer.set}.png`;
            a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(a.href);
            showToast(t('export_ok'));
        }
        function writerFillKanaOptions() {
            const sel = qs('#writeKana');
            if (!sel) return;
            sel.innerHTML = '';
            ALL_ROMAJI.forEach(r=>{
                const o = new Option(`${r.toUpperCase()} ‚Äî ${(state.writer.set==='hira'? HIRA_MAP.get(r): KATA_MAP.get(r))}`, r);
                sel.add(o);
            });
            sel.value = state.writer.kana;
        }
        function writerApplyUIFromState() {
            if (!wCanvas) return;
            // Bindings are now handled in writerBindEvents to prevent double binding
            
            if (qs('#writeSet')) qs('#writeSet').value = state.writer.set;
            if (qs('#penSize')) qs('#penSize').value = state.writer.penSize;
            if (qs('#gridToggle')) qs('#gridToggle').checked = state.writer.grid;
            if (qs('#ghostToggle')) qs('#ghostToggle').checked = state.writer.ghost;
            if (qs('#autoSnapToggle')) qs('#autoSnapToggle').checked = state.writer.autoSnap;
            
            if (state.writer.eraser) {
                qs('#eraserBtn')?.classList.add('ok');
                qs('#penBtn')?.classList.remove('ok');
            } else {
                qs('#penBtn')?.classList.add('ok');
                qs('#eraserBtn')?.classList.remove('ok');
            }

            writerSetGhostChar();
            writerFillKanaOptions();
            writerSetGrid(state.writer.grid);
            writerSetupCanvasSize();
        }
        function writerPick(offset) {
            const idx = ALL_ROMAJI.indexOf(state.writer.kana);
            const next = (idx + offset + ALL_ROMAJI.length) % ALL_ROMAJI.length;
            state.writer.kana = ALL_ROMAJI[next];
            save();
            writerFillKanaOptions();
            writerSetGhostChar();
        }
        function writerRandom() {
            state.writer.kana = ALL_ROMAJI[Math.floor(Math.random()*ALL_ROMAJI.length)];
            save();
            writerFillKanaOptions();
            writerSetGhostChar();
        }
        function writerBindEvents() {
            if (_writerBound) return; // Prevent double binding
            _writerBound = true;
            if (wCanvas) wCanvas.addEventListener('pointerdown', writerStart);
            if (wCanvas) wCanvas.addEventListener('pointermove', writerMove);
            window.addEventListener('pointerup', writerEnd);
            bind('#writeSet', 'change', (e)=>{ state.writer.set=e.target.value; save(); writerFillKanaOptions(); writerSetGhostChar(); writerClear(); });
            bind('#writeKana', 'change', (e)=>{ state.writer.kana=e.target.value; save(); writerSetGhostChar(); writerClear(); });
            bind('#writePrev', 'click', ()=>{ writerPick(-1); writerClear(); });
            bind('#writeNext', 'click', ()=>{ writerPick(1); writerClear(); });
            bind('#writeRand', 'click', ()=>{ writerRandom(); writerClear(); });
            bind('#writeSpeak', 'click', ()=>{ speak(writerCurrentChar()); clickTone('click'); });
            bind('#penSize', 'input', (e)=>{ state.writer.penSize = parseInt(e.target.value,10)||10; save(); });
            // PATCH: Perbaiki handler toggle Grid (biar redraw setelah ganti latar)
            bind('#gridToggle', 'change', (e)=>{ 
                state.writer.grid = e.target.checked; 
                save(); 
                writerSetGrid(state.writer.grid); 
                writerRedrawAll(); // penting: redraw setelah ubah grid
            });
            bind('#ghostToggle', 'change', (e)=>{ state.writer.ghost = e.target.checked; save(); writerSetGhostChar(); });
            bind('#autoSnapToggle', 'change', (e)=>{ state.writer.autoSnap = e.target.checked; save(); });
            bind('#penBtn', 'click', ()=>{ state.writer.eraser=false; save(); qs('#penBtn')?.classList.add('ok'); qs('#eraserBtn')?.classList.remove('ok'); });
            bind('#eraserBtn', 'click', ()=>{ state.writer.eraser=true; save(); qs('#eraserBtn')?.classList.add('ok'); qs('#penBtn')?.classList.remove('ok'); });
            bind('#undoStroke', 'click', writerUndo);
            bind('#clearCanvas', 'click', writerClear);
            bind('#savePNG', 'click', writerSavePNG);
            document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); writerUndo(); } });
            window.addEventListener('resize', ()=>{ writerSetupCanvasSize(); });
            // PATCH: Guard sebelum pakai ResizeObserver
            if ('ResizeObserver' in window) {
              const resizeObserver = new ResizeObserver(entries => {
                  for (let entry of entries) {
                      if (entry.target === wWrap) {
                          writerSetupCanvasSize();
                      }
                  }
              });
              if (wWrap) resizeObserver.observe(wWrap); // Guard against null
            } else {
              console.warn("ResizeObserver not supported in this browser.");
              // Fallback for older browsers if needed, e.g., using window.onresize
            }
        }
        function writerInit() {
            writerInitDOMRefs();
            writerBindEvents();
            writerApplyUIFromState();
        }

        function _makeOffscreen(w=128,h=128){ const c=document.createElement('canvas'); c.width=w; c.height=h; return c; }

        function _drawTemplateToCanvas(c, ch, theme){
            const ctx=c.getContext('2d'); if (!ctx) return; // Guard against null
            ctx.clearRect(0,0,c.width,c.height);
            ctx.fillStyle = theme==='hc' ? '#e6efff' : '#132030';
            const s = Math.min(c.width,c.height)*0.8;
            ctx.font = `bold ${s}px "Noto Serif JP", "Noto Sans JP", serif`;
            ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(ch, c.width/2, c.height/2);
        }

        function _drawUserToCanvas(c, strokes, theme){
            const ctx=c.getContext('2d'); if (!ctx) return; // Guard against null
            ctx.clearRect(0,0,c.width,c.height);
            ctx.strokeStyle = theme==='hc' ? '#e6efff' : '#132030';
            ctx.lineCap='round'; ctx.lineJoin='round';
            if (!wCanvas) return; // Guard against null
            const src = wCanvas.getBoundingClientRect();
            const sx = c.width / src.width;
            const sy = c.height / src.height;
            for(const s of wStrokes){
                if (s.ops === 'destination-out') continue; 
                ctx.globalCompositeOperation = s.ops;
                ctx.lineWidth = Math.max(2, (s.size||state.writer.penSize) * ((sx+sy)/2));
                ctx.beginPath();
                if (s.points.length > 0) {
                    ctx.moveTo(s.points[0].x*sx, s.points[0].y*sy);
                    for(let i=1;i<s.points.length;i++){
                        const b=s.points[i];
                        ctx.lineTo(b.x*sx, b.y*sy);
                    }
                }
                ctx.stroke();
            }
        }

        function _computeIoU(cA, cB){
            const a = cA.getContext('2d')?.getImageData(0,0,cA.width,cA.height).data;
            const b = cB.getContext('2d')?.getImageData(0,0,cB.width,cB.height).data;
            if (!a || !b) return 0; // Guard against null context
            let inter=0, uni=0;
            for(let i=3;i<a.length;i+=4){
                const A = a[i]>0; 
                const B = b[i]>0;
                if(A||B) uni++;
                if(A&&B) inter++;
            }
            return uni? inter/uni : 0;
        }

        function writerEvaluateAndSnap(){
            if(!wStrokes.length || wStrokes[wStrokes.length - 1].ops === 'destination-out') {
                return;
            }

            const offUser = _makeOffscreen(128,128);
            const offTemp = _makeOffscreen(128,128);

            _drawUserToCanvas(offUser, wStrokes, state.theme);
            _drawTemplateToCanvas(offTemp, writerCurrentChar(), state.theme);

            const iou = _computeIoU(offUser, offTemp);

            const THRESH = (state.writer.snapThreshold ?? 0.52);

            if(iou >= THRESH){
                if (!wCtx || !wCanvas) return; // Guard against null
                wCtx.setTransform(1,0,0,1,0,0);
                wCtx.clearRect(0,0,wCanvas.width,wCanvas.height);
                wCtx.scale(dpr,dpr);
                const s = Math.min(wCanvas.width/dpr, wCanvas.height/dpr)*0.8;
                wCtx.font = `bold ${s}px "Noto Serif JP", "Noto Sans JP", serif`;
                wCtx.textAlign='center'; wCtx.textBaseline='middle';
                wCtx.fillStyle = state.theme==='hc' ? '#e6efff' : '#132030';
                wCtx.fillText(writerCurrentChar(), (wCanvas.width/dpr)/2, (wCanvas.height/dpr)/2);
                wStrokes.length = 0;
                showToast(t('writer_snap_success'), 'ok');
            }else{
                const t0=Date.now(), dur=160; 
                const snap = ()=>{
                    const t=Date.now()-t0, k=Math.min(1,t/dur);
                    if (wCtx) wCtx.save(); // Guard against null
                    if (wCtx) wCtx.globalAlpha = 1-k;
                    writerRedrawAll();
                    if (wCtx) wCtx.restore();
                    if(k<1) requestAnimationFrame(snap); 
                    else writerClear();
                }; 
                requestAnimationFrame(snap);
                showToast(t('writer_snap_fail'), 'warn');
            }
        }

        // ---------- EXPORT / IMPORT PROGRESS ----------
        function sanitizeState(s){
            const clamp = (n,min,max)=> Math.min(max, Math.max(min, Number(n)||0));
            const onlyRomaji = arr => (Array.isArray(arr)? arr.filter(x=>ALL_ROMAJI.includes(x)) : []);

            const safe = {...s};
            safe.hiraMastered = onlyRomaji(safe.hiraMastered);
            safe.kataMastered = onlyRomaji(safe.kataMastered);
            safe.totalPoints = clamp(safe.totalPoints, 0, 1_000_000);
            safe.level = clamp(safe.level, 1, 99);
            
            if (!safe.test) safe.test = {};
            safe.test.target = clamp(safe.test.target, 1, 1000);
            
            if (!safe.pomo) safe.pomo = {};
            safe.pomo.work = clamp(safe.pomo.work, 1, 60);
            safe.pomo.break = clamp(safe.pomo.break, 1, 30);
            safe.pomo.remaining = clamp(safe.pomo.remaining, 0, (safe.pomo.work || 25) * 60);
            
            if (!safe.writer) safe.writer = {};
            safe.writer.penSize = clamp(safe.writer.penSize, 2, 28);
            safe.writer.ghostOpacity = clamp(safe.writer.ghostOpacity, 0.05, 0.40);
            safe.writer.snapThreshold = clamp(safe.writer.snapThreshold, 0.35, 0.80);

            safe.audio = !!safe.audio;
            safe.writer.eraser = !!safe.writer.eraser;
            safe.writer.grid = !!safe.writer.grid;
            safe.writer.ghost = !!safe.writer.ghost;
            safe.writer.autoSnap = !!safe.writer.autoSnap;
            safe.pomo.running = !!safe.pomo.running;
            safe.hasSeenOnboarding = !!safe.hasSeenOnboarding;

            safe.theme = ['pastel', 'hc'].includes(safe.theme) ? safe.theme : 'pastel';
            safe.test.set = ['hira', 'kata'].includes(safe.test.set) ? safe.test.set : 'hira';
            safe.test.mode = ['type', 'mc'].includes(safe.test.mode) ? safe.test.mode : 'type';
            safe.test.qType = ['k2r', 'r2k', 'seq'].includes(safe.test.qType) ? safe.test.qType : 'k2r';
            safe.test.rangeMode = ['range', 'single'].includes(safe.test.rangeMode) ? safe.test.rangeMode : 'range';
            safe.writer.set = ['hira', 'kata'].includes(safe.writer.set) ? safe.writer.set : 'hira';
            safe.writer.kana = ALL_ROMAJI.includes(safe.writer.kana) ? safe.writer.kana : 'a';
            safe.pomo.mode = ['work', 'break'].includes(safe.pomo.mode) ? safe.pomo.mode : 'work';

            return safe;
        }

        function exportProgress(){
            const blob = new Blob([localStorage.getItem(KEY)||'{}'], {type:'application/json'});
            const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
            a.download='kana-progress.json'; a.click(); URL.revokeObjectURL(a.href);
            showToast(t('export_ok'));
        }

        function importProgress(file){
            const r=new FileReader();
            r.onload=()=>{
                try{
                    const raw = JSON.parse(r.result);
                    if (raw && typeof raw === 'object') {
                        const s = sanitizeState(raw);
                        localStorage.setItem(KEY, JSON.stringify(s));
                        state = load();
                        renderAll();
                        showToast(t('import_ok'));
                    } else {
                        showToast(t('import_fail'), 'warn');
                    }
                }catch(e){
                    console.error("Error parsing imported file:", e);
                    showToast(t('import_fail'), 'warn');
                }
            };
            r.onerror = (e) => {
                console.error("FileReader error:", e);
                showToast(t('import_fail'), 'warn');
            };
            r.readAsText(file);
        }

        // ---------- ONBOARDING ----------
        function showOnboarding() {
            const onboardingModal = qs('#onboardingModal');
            const mainContent = qs('#main');

            if (state.hasSeenOnboarding) {
                if (onboardingModal) onboardingModal.style.display='none';
                if (mainContent) mainContent.style.display = 'block';
                return;
            }

            if (onboardingModal) onboardingModal.hidden = false;
            if (onboardingModal) onboardingModal.style.display = 'flex';
            _trapModalOnboarding();

            bind('#btnStartLearningOnboarding', 'click', () => {
                state.hasSeenOnboarding = true;
                save();
                if (onboardingModal) onboardingModal.style.display = 'none';
                if (onboardingModal) onboardingModal.hidden = true;
                if (mainContent) mainContent.style.display = 'block';
                // PATCH: Dukungan Escape key untuk modal onboarding
                if (_escCloseListenerOnboarding) {
                    document.removeEventListener('keydown', _escCloseListenerOnboarding);
                    _escCloseListenerOnboarding = null;
                }
            });
        }

        let _escCloseListenerOnboarding = null;
        function _trapModalOnboarding(){
            const onboardingModal = qs('#onboardingModal');
            if (!onboardingModal) return; // Guard against null
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            const focusables = onboardingModal.querySelectorAll(focusableElements);
            const firstFocusable = focusables[0];
            const lastFocusable = focusables[focusables.length - 1];

            onboardingModal.addEventListener('keydown', (e) => {
                const isTabPressed = (e.key === 'Tab' || e.keyCode === 9);
                if (!isTabPressed) return;

                if (e.shiftKey) {
                    if (document.activeElement === firstFocusable) {
                        lastFocusable.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastFocusable) {
                        firstFocusable.focus();
                        e.preventDefault();
                    }
                }
            });
            // PATCH: Dukungan Escape key untuk modal onboarding
            if (!_escCloseListenerOnboarding) {
                _escCloseListenerOnboarding = (e) => {
                    if (e.key === 'Escape') {
                        const btnStartLearning = qs('#btnStartLearningOnboarding');
                        if (btnStartLearning) {
                            btnStartLearning.click(); // Simulate click to close and mark as seen
                        }
                    }
                };
                document.addEventListener('keydown', _escCloseListenerOnboarding);
            }
            firstFocusable?.focus();
        }

        // ---------- BINDINGS ----------
        bind('#btnShowLearn', 'click', startLearn);
        bind('#btnStart', 'click', startTest);
        bind('#btnEnd', 'click', endTest); // Menggunakan fungsi endTest yang sudah diperbaiki
        bind('#btnSkip', 'click', skipQ);
        bind('#btnCheck', 'click', checkAns);

        bind('#mcWrap', 'pointerup', (e)=>{ const btn=e.target.closest('.opt'); if(!btn) return; const id=(btn.id||'').slice(-1); if(!id) return; mcPick(id); }, {passive:true});

        bind('#ans', 'keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkAns();
            }
        });

        document.addEventListener('keydown', (e)=>{
            if(e.target.matches('input,textarea') && e.target.id !== 'ans' && !e.target.closest('#testArea')) return;

            const map={a:'A',b:'B',c:'C',d:'D'}; const k=map[e.key?.toLowerCase?.()]; if(k && getComputedStyle(qs('#mcWrap') || {display:'none'}).display!=='none'){ e.preventDefault(); mcPick(k); }
            if(e.key==='ArrowRight' && !qs('#testArea')?.hidden){ e.preventDefault(); skipQ(); }

            const writerSection = qs('#writerSection');
            const isWriterSectionVisible = writerSection && getComputedStyle(writerSection).display !== 'none' && writerSection.offsetParent !== null;

            if (isWriterSectionVisible) {
                if (e.key === 'g') {
                    const el = qs('#gridToggle');
                    if (el) { el.checked = !el.checked; el.dispatchEvent(new Event('change')); save(); } // Trigger change event
                }
                if (e.key === 'p') {
                    const penBtn = qs('#penBtn');
                    const eraserBtn = qs('#eraserBtn');
                    if (penBtn && eraserBtn) {
                        if (state.writer.eraser) {
                            penBtn.click();
                        } else {
                            eraserBtn.click();
                        }
                    }
                }
                if (e.key === ']') {
                    const penSizeInput = qs('#penSize');
                    if (penSizeInput) {
                        state.writer.penSize = Math.min(28, state.writer.penSize + 1);
                        penSizeInput.value = state.writer.penSize;
                        penSizeInput.dispatchEvent(new Event('input')); // Trigger input event
                        save();
                    }
                }
                if (e.key === '[') {
                    const penSizeInput = qs('#penSize');
                    if (penSizeInput) {
                        state.writer.penSize = Math.max(2, state.writer.penSize - 1);
                        penSizeInput.value = state.writer.penSize;
                        penSizeInput.dispatchEvent(new Event('input')); // Trigger input event
                        save();
                    }
                }
            }
        });

        bind('#tPastel', 'click', ()=>{ state.theme='pastel'; save(); applyTheme(); });
        bind('#tHC', 'click', ()=>{ state.theme='hc'; save(); applyTheme(); });
        bind('#audToggle', 'change', (e)=>{ state.audio = e.target.checked; save(); });

        bind('#resetBtn', 'click', ()=>{
            showCustomConfirm(t('confirm_reset_title'), (confirmed) => {
                if(confirmed){
                    localStorage.removeItem(KEY);
                    state=initState();
                    applyTheme();
                    applyAudio();
                    renderAll();
                    if (typeof writerClear==='function') writerClear();
                    save();
                    showToast('Semua progres telah direset.');
                }
            });
        });

        bind('#countChips', 'click', (e)=>{ const b=e.target.closest('.chip'); if(!b) return; const c=parseInt(b.dataset.count,10)||10; if (qs('#testCount')) qs('#testCount').value=c; clickTone('click'); save(); });

        bind('#pStart', 'click', startPomo);
        bind('#pPause', 'click', pausePomo);
        bind('#pReset', 'click', resetPomo);

        bind('#rangeMode', 'change', (e) => { state.test.rangeMode = e.target.value; save(); toggleRangeInputs(); });
        bind('#answerMode', 'change', (e) => { state.test.mode = e.target.value; save(); toggleAnswerUI(); });
        bind('#qType', 'change', (e) => { state.test.qType = e.target.value; save(); toggleAnswerUI(); });

        bind('#exportBtn', 'click', exportProgress);
        bind('#importBtn', 'click', () => { qs('#importFile')?.click(); });
        bind('#importFile', 'change', (e) => {
            if (e.target.files && e.target.files.length > 0) {
                importProgress(e.target.files[0]);
                e.target.value = null;
            }
        });


        // ---------- RENDER ----------
        function renderAll(){
            buildKana('hiraBox','hira');
            buildKana('kataBox','kata');
            buildSubsetChips();
            fillLearnRange();
            fillTestRange();
            renderStats();
            applyTheme();
            applyAudio();
            upPomoLabel();
            if(!state.pomo.remaining) state.pomo.remaining=state.pomo.work*60;
            drawRemain();
            if (qs('#pomoWork')) qs('#pomoWork').value=state.pomo.work;
            if (qs('#pomoBreak')) qs('#pomoBreak').value=state.pomo.break;
            if (qs('#testCount')) qs('#testCount').value=state.test.target||10;
            toggleAnswerUI();
            updatePointsAndLevelDisplay();
            writerInit();
            writerRedrawAll(); 
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            renderAll();
            if(state.pomo.running){ startPomo(); }
            showOnboarding();
        });

        // ==== Hardening anti-overflow saat runtime (debug + fix cepat) ====
        // PATCH: Menghapus seluruh IIFE ini karena override window.showToast bentrok dan tidak diperlukan
        /*
        (function fixRuntimeOverflow(){
            document.documentElement.style.overflowX = 'hidden';
            document.body.style.overflowX = 'hidden';
            document.documentElement.style.maxWidth = '100%';
            document.body.style.maxWidth = '100%';

            document.querySelectorAll('img,canvas,video,svg').forEach(el=>{
                el.style.maxWidth = '100%';
                el.style.height = 'auto';
            });

            const origShowToast = window.showToast;
            if (typeof origShowToast === 'function') {
                window.showToast = function(message, type='info', duration=2500){
                    const n = origShowToast(message, type, duration);
                    if (window.currentToast) {
                        const toast = window.currentToast;
                        toast.style.position = 'fixed';
                        toast.style.left = '50vw';
                        toast.style.transform = 'translateX(-50%)';
                        toast.style.maxWidth = 'calc(100vw - 24px)';
                    }
                    return n;
                }
            }
        })();
        */
    </script>
</body>
</html>
