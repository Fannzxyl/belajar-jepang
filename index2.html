<!DOCTYPE html>
<html lang="id" data-theme="pastel">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Flashcard Kana Jepang — Latihan AI</title>
    <meta name="description" content="Latih Hiragana & Katakana dengan flashcard interaktif yang didukung AI untuk pelafalan dan contoh kalimat." />
    <meta name="theme-color" content="#7a6cff">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Menggunakan style yang sama dari index.html untuk konsistensi */
        :root{
            --bg:#f8fbff; --panel:#ffffff; --soft:#f2f6ff; --ink:#132030; --muted:#76849c;
            --pri:#7a6cff; --sec:#16c6a1; --warn:#ff7b7b; --ok:#2fb875; --accent:#ffd166;
            --btn:#e9eefc; --btnText:#0b101a; --border:rgba(19,32,48,.10);
            --radius:18px; --shadow:0 6px 18px rgba(15,23,34,.08);
            --ring: 0 0 0 3px rgba(122,108,255,.28);
            --okBg:#dff4ea;
            --warnBg:#ffe5e5;
            --iconColor: var(--muted);
            --transition-duration: 0.2s;
        }
        [data-theme="hc"]{
            --bg:#0a0f1a; --panel:#0f1626; --soft:#0c1220; --ink:#e6efff; --muted:#9fb0cc;
            --pri:#8fa8ff; --sec:#3dd8b5; --warn:#ff8c8c; --ok:#7be0b3; --accent:#ffd98a;
            --btn:#18243a;
            --btnText:#e6efff;
            --border:rgba(230,239,255,.12);
            --ring: 0 0 0 3px rgba(143,168,255,.35);
            --okBg:#1a3a2e;
            --warnBg:#3a1a1a;
            --iconColor: var(--ink);
        }
        *{box-sizing:border-box}
        html, body { max-width: 100%; overflow-x: hidden; }
        body {
            min-height: 100svh;
            margin:0;font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:
            radial-gradient(900px 420px at -10% -20%, rgba(122,108,255,.10), transparent),
            radial-gradient(900px 420px at 110% -30%, rgba(22,198,161,.12), transparent),
            var(--bg);color:var(--ink);
            transition: background-color var(--transition-duration) ease-out, color var(--transition-duration) ease-out;
        }
        .wrap{
            max-width: 720px;
            margin: auto;
            padding: 16px;
            padding-left: calc(16px + env(safe-area-inset-left));
            padding-right: calc(16px + env(safe-area-inset-right));
        }
        header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));backdrop-filter: blur(8px);border-bottom:1px solid var(--border); padding-top:env(safe-area-inset-top);
        transition: background var(--transition-duration) ease-out, backdrop-filter var(--transition-duration) ease-out, border-bottom-color var(--transition-duration) ease-out;}
        [data-theme="hc"] header{background:linear-gradient(180deg, rgba(15,22,38,.86), rgba(15,22,38,.66))}
        
        .brand{ display:flex; align-items:center; gap:12px; justify-content: space-between; flex-wrap: wrap; }
        .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--sec));box-shadow:var(--shadow);
        transition: box-shadow var(--transition-duration) ease-out, background var(--transition-duration) ease-out;}
        h1{font-size:20px;margin:0}
        .small{font-size:12px;color:var(--muted)}
        .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;border:1px solid var(--border);
        transition: background-color var(--transition-duration) ease-out, border-color var(--transition-duration) ease-out, box-shadow var(--transition-duration) ease-out;}
        .card h2{font-size:16px;margin:0 0 10px 0; display: flex; align-items: center; gap: 8px;}
        .card h2 .icon { color: var(--iconColor); transition: color var(--transition-duration) ease-out;}
        .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
        .btn{ min-height:52px; padding: 0 16px; border-radius: 12px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all var(--transition-duration) ease-out; color: var(--ink); background: var(--btn); display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
        .btn:active{transform:translateY(1px)}
        .btn.primary{ background:linear-gradient(135deg, var(--pri), var(--sec)); color:white; }
        .btn.ghost{background:transparent;outline:1px solid var(--border); color: var(--ink);}
        .btn.ok   { background: var(--okBg);  color: var(--ok); }
        .btn.warn { background: var(--warnBg); color: var(--warn); }
        .btn:focus-visible{outline:none; box-shadow:var(--ring); outline-offset: 3px;}
        /* Animasi denyut untuk tombol mikrofon saat mendengarkan */
        .btn.primary.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(122, 108, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(122, 108, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(122, 108, 255, 0); }
        }

        select{ width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--soft);color:var(--ink); transition: border-color var(--transition-duration) ease-out, background-color var(--transition-duration) ease-out, box-shadow var(--transition-duration) ease-out; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2376849c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 36px; }
        select:focus { border-color: var(--pri); outline: none; box-shadow: var(--ring); }
        .spacer{height:10px}
        .main-nav{ display:none !important; } /* Sembunyiin main-nav lama */

        /* Style khusus untuk Flashcard */
        .flashcard-container {
            perspective: 1000px;
            min-height: 300px;
            cursor: pointer;
        }
        .flashcard {
            width: 100%;
            height: 300px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Sans JP', 'Noto Serif JP', sans-serif;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .flashcard-front {
            background: var(--panel);
            font-size: clamp(80px, 25vw, 150px);
        }
        .flashcard-back {
            background: var(--soft);
            transform: rotateY(180deg);
            font-size: clamp(40px, 15vw, 80px);
            color: var(--muted);
        }
        .flashcard-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }
        #cardCounter {
            font-size: 14px;
            color: var(--muted);
        }

        /* Area feedback AI */
        #aiFeedbackArea {
            margin-top: 16px;
            padding: 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--soft);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--ink);
            font-size: 14px;
            transition: background-color var(--transition-duration) ease-out, border-color var(--transition-duration) ease-out;
        }
        #aiFeedbackArea.correct {
            background-color: var(--okBg);
            border-color: var(--ok);
            color: var(--ok);
            font-weight: 600;
        }
        #aiFeedbackArea.wrong {
            background-color: var(--warnBg);
            border-color: var(--warn);
            color: var(--warn);
            font-weight: 600;
        }
        #aiFeedbackArea .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--pri);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Contoh AI */
        .ai-examples-section {
            margin-top: 16px;
            padding: 12px;
            background: var(--soft);
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            line-height: 1.5;
            display: none; /* Default hidden */
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity var(--transition-duration) ease-out, max-height var(--transition-duration) ease-out;
        }
        .ai-examples-section.show {
            display: block; /* Tampilkan block saat show */
            opacity: 1;
            max-height: 500px; /* Nilai max-height yang cukup besar untuk transisi */
        }
        .ai-examples-section p {
            margin: 0 0 8px 0;
        }
        .ai-examples-section p:last-child {
            margin-bottom: 0;
        }
        .ai-examples-section .loading-spinner {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            justify-content: center;
        }
        .ai-examples-section .loading-spinner .fa-spinner {
            animation: spin 1s linear infinite;
        }

        /* === Sidebar === */
        .sidebar{
            position:fixed; top:0; left:-300px; width:280px; height:100%;
            background:var(--panel); box-shadow:var(--shadow); z-index:1000;
            transition:left .3s ease-in-out; padding:20px; padding-top:calc(20px + env(safe-area-inset-top));
            display:flex; flex-direction:column; gap:10px; overflow-y:auto; border-right:1px solid var(--border);
        }
        .sidebar.is-open{ left:0; }
        .sidebar .menu{ list-style:none; margin:0; padding:0; }
        .sidebar .menu li a{ display:flex; gap:.5rem; align-items:center; padding:.75rem 1rem; border-radius:12px; color:var(--ink); text-decoration:none; }
        .sidebar .menu li a:hover{ background:var(--soft); }
        .sidebar .menu li a.active{ background:rgba(122,108,255,.12); font-weight:600; }
        .sidebar-toggle-btn{
            position:fixed; top:16px; left:16px; z-index:1001; background:var(--btn); border:1px solid var(--border);
            border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow);
        }
        .sidebar-toggle-btn i{ color:var(--ink); font-size:20px; }
        @media (min-width:768px){
            body.sidebar-open{ padding-left:280px; }
            .sidebar-toggle-btn{ left:16px; }
        }
        @media (max-width:640px){ .sidebar{ width:84vw; max-width:320px; } }

        /* Header padding biar gak ketutup tombol (opsional, rapi di HP) */
        header .brand{ position:relative; z-index:1002; padding-left:60px; }
        @media (max-width:767px){ header .brand{ padding-left:0; } .sidebar-toggle-btn{ top:calc(16px + env(safe-area-inset-top)); } }

        /* Form control responsivity */
        input, select{ width:100%; min-width:0; }
        /* Pastikan select bisa ditap & tidak ketutup */
        #rangeMode, #testFrom, #testTo, #testSingleGroup{
            width:100%; min-width:0; pointer-events:auto; position:relative; z-index:1;
        }

    </style>
</head>
<body>
    <!-- Sidebar Toggle Button -->
    <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle Sidebar">
        <i class="fa-solid fa-bars"></i>
    </button>

    <!-- Sidebar Content -->
    <nav id="sidebar" class="sidebar">
        <div class="row" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">Navigasi</h3>
            <button class="btn ghost" id="closeSidebar" aria-label="Tutup Sidebar">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <hr style="border:none;border-top:1px solid var(--border);width:100%;">
        <ul class="menu">
            <li><a href="index.html">📘 Latihan</a></li>
            <li><a href="index2.html" class="active">🗂️ Flashcard</a></li>
            <li><a href="index3.html">🧮 Tabel Kana</a></li>
            <li><a href="index4.html">🗒️ Kosakata</a></li>
            <li><a href="index5.html">💬 Ungkapan</a></li>
            <li><a href="index7.html">🧠 Tebak Arti</a></li>
            <li><a href="index6.html">✍️ Menulis</a></li>
        </ul>
    </nav>

    <header>
        <div class="wrap">
            <div class="brand">
                <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="36" height="36">
                    <defs>
                        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                            <stop stop-color="#7a6cff"/><stop offset="1" stop-color="#16c6a1"/>
                        </linearGradient>
                    </defs>
                    <rect width="64" height="64" rx="14" fill="url(#g)"/>
                    <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
                          font-family="Noto Sans JP, 'Noto Serif JP', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"
                          font-size="38" fill="white" dy="-2">あ</text>
                </svg>
                <div>
                    <h1>Pelatih Kana Jepang</h1>
                    <div class="small">Flashcard dengan dukungan AI</div>
                </div>
            </div>
        </div>
    </header>

    <main class="wrap">
        <div class="card">
            <h2><i class="fa-solid fa-clone icon"></i> Mode Flashcard</h2>
            <div class="small">Pilih set kana, lalu ketuk kartu untuk melihat romaji. Gunakan tombol panah untuk navigasi.</div>
            <div class="spacer"></div>
            <div class="row">
                <select id="setSelection" aria-label="Pilih set kana">
                    <option value="hira">Hiragana (Semua)</option>
                    <option value="kata">Katakana (Semua)</option>
                    <option value="hira_base">Hiragana (Dasar)</option>
                    <option value="kata_base">Katakana (Dasar)</option>
                    <option value="hira_daku">Hiragana (Dakuon/Handakuon)</option>
                    <option value="kata_daku">Katakana (Dakuon/Handakuon)</option>
                    <option value="hira_you">Hiragana (Youon)</option>
                    <option value="kata_you">Katakana (Youon)</option>
                </select>
                <button id="shuffleBtn" class="btn"><i class="fa-solid fa-shuffle"></i> Acak Kartu</button>
            </div>
        </div>

        <div class="spacer"></div>

        <div id="flashcardContainer" class="flashcard-container">
            <div class="flashcard" id="flashcard">
                <div class="flashcard-face flashcard-front" id="cardFront">あ</div>
                <div class="flashcard-face flashcard-back" id="cardBack">a</div>
            </div>
        </div>

        <div class="flashcard-nav">
            <button id="prevBtn" class="btn ghost"><i class="fa-solid fa-arrow-left"></i> Sebelumnya</button>
            <div id="cardCounter">1 / 46</div>
            <button id="nextBtn" class="btn ghost">Berikutnya <i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div class="spacer"></div>

        <div class="row" style="justify-content: center; gap: 8px;">
            <button id="speakAndCheckBtn" class="btn primary"><i class="fa-solid fa-microphone"></i> Ucapkan & Cek</button>
            <button id="aiExamplesBtn" class="btn"><i class="fa-solid fa-lightbulb"></i> Contoh AI</button>
        </div>
        
        <div id="aiFeedbackArea" aria-live="polite" style="margin-top: 10px;">
            <!-- Umpan balik AI untuk pelafalan akan muncul di sini -->
        </div>

        <div class="ai-examples-section" id="aiExamplesSection" aria-live="polite">
            <!-- Contoh kalimat AI akan dimuat di sini -->
        </div>

        <div class="spacer"></div>

        <div class="row" style="justify-content: center; gap: 8px;">
            <button id="markCorrectBtn" class="btn ok"><i class="fa-solid fa-check"></i> Benar</button>
            <button id="markIncorrectBtn" class="btn warn"><i class="fa-solid fa-times"></i> Salah</button>
        </div>

        <div class="spacer"></div>

        <!-- Penambahan: CTA card "Tebak Arti" -->
        <div class="card" id="cta-tebak-arti">
          <h2><i class="fa-solid fa-brain icon"></i> Tebak Arti (JP→ID)</h2>
          <div class="small">Kuis arti Jepang → Indonesia (A–D). Pilih kategori & jumlah soal.</div>
          <div class="spacer"></div>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <a class="btn primary" href="index7.html"><i class="fa-solid fa-play"></i> Mulai Tebak Arti</a>
            <a class="btn ghost" href="index7.html#kategori"><i class="fa-solid fa-list"></i> Pilih Kategori</a>
          </div>
        </div>
    </main>

    <script>
        // DATA KANA (Sama seperti di index.html)
        const BASE = ['a','i','u','e','o','ka','ki','ku','ke','ko','sa','shi','su','se','so','ta','chi','tsu','te','to','na','ni','nu','ne','no','ha','hi','fu','he','ho','ma','mi','mu','me','mo','ya','yu','yo','ra','ri','ru','re','ro','wa','wo','n'];
        const DAKUON = ['ga','gi','gu','ge','go','za','ji','zu','ze','zo','da','dji','dzu','de','do','ba','bi','bu','be','bo','pa','pi','pu','pe','po'];
        const YOUON = ['kya','kyu','kyo','sha','shu','sho','cha','chu','cho','nya','nyu','nyo','hya','hyu','hyo','mya','myu','myo','rya','ryu','ryo','gya','gyu','gyo','ja','ju','jo','bya','byu','byo','pya','pyu','pyo'];
        const HIRA_BASE = ['あ','い','う','え','お','か','き','く','け','こ','さ','し','す','せ','そ','た','ち','つ','て','と','な','に','ぬ','ね','の','は','ひ','ふ','へ','ほ','ま','み','む','め','も','や','ゆ','よ','ら','り','る','れ','ろ','わ','を','ん'];
        const KATA_BASE = ['ア','イ','ウ','エ','オ','カ','キ','ク','ケ','コ','サ','シ','ス','セ','ソ','タ','チ','ツ','テ','ト','ナ','ニ','ヌ','ネ','ノ','ハ','ヒ','フ','ヘ','ホ','マ','ミ','ム','メ','モ','ヤ','ユ','ヨ','ラ','リ','ル','レ','ロ','ワ','ヲ','ン'];
        const HIRA_DAKU = ['が','ぎ','ぐ','げ','ご','ざ','じ','ず','ぜ','ぞ','だ','ぢ','づ','で','ど','ば','び','ぶ','べ','ぼ','ぱ','ぴ','ぷ','ぺ','ぽ'];
        const KATA_DAKU = ['ガ','ギ','グ','ゲ','ゴ','ザ','ジ','ズ','ゼ','ゾ','ダ','ヂ','ヅ','デ','ド','バ','ビ','ブ','ベ','ボ','パ','ピ','プ','ペ','ポ'];
        const HIRA_YOU = ['きゃ','きゅ','きょ','しゃ','しゅ','しょ','ちゃ','ちゅ','ちょ','にゃ','にゅ','にょ','ひゃ','ひゅ','ひょ','みゃ','みゅ','みょ','りゃ','りゅ','りょ','ぎゃ','ぎゅ','ぎょ','じゃ','じゅ','じょ','びゃ','びゅ','びょ','ぴゃ','ぴゅ','ぴょ'];
        const KATA_YOU = ['キャ','キュ','キョ','シャ','シュ','ショ','チャ','チュ','チョ','ニャ','ニュ','ニョ','ヒャ','ヒュ','ヒョ','ミャ','ミュ','ミョ','リャ','リュ','リョ','ギャ','ギュ','ギョ','ジャ','ジュ','ジョ','ビャ','ビュ','ビョ','ピャ','ピュ','ピョ'];
        
        const HIRA_MAP = new Map();
        const KATA_MAP = new Map();
        BASE.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_BASE[i]);KATA_MAP.set(r,KATA_BASE[i])});
        DAKUON.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_DAKU[i]);KATA_MAP.set(r,KATA_DAKU[i])});
        YOUON.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_YOU[i]);KATA_MAP.set(r,KATA_YOU[i])});

        // State Aplikasi Flashcard
        let deck = [];
        let currentIndex = 0;
        let currentSet = 'hira';
        let incorrectCards = new Map(); // Untuk SRS sederhana

        // Elemen DOM
        const flashcard = document.getElementById('flashcard');
        const cardFront = document.getElementById('cardFront');
        const cardBack = document.getElementById('cardBack');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const cardCounter = document.getElementById('cardCounter');
        const setSelection = document.getElementById('setSelection');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const speakAndCheckBtn = document.getElementById('speakAndCheckBtn');
        const aiExamplesBtn = document.getElementById('aiExamplesBtn');
        const aiFeedbackArea = document.getElementById('aiFeedbackArea');
        const aiExamplesSection = document.getElementById('aiExamplesSection');
        const markCorrectBtn = document.getElementById('markCorrectBtn');
        const markIncorrectBtn = document.getElementById('markIncorrectBtn');

        // --- INTEGRASI API GEMINI ---
        const GEMINI_API_KEY = "AIzaSyCZVyGLZrlJW-bQFSYfIgVgWhVWQ6icaeE"; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const geminiCache = new Map(); // Cache untuk contoh AI

        // Fungsi untuk menangani percobaan ulang dengan exponential backoff
        async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) { // Too Many Requests
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Gandakan delay
                        continue;
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }
                    throw error;
                }
            }
            throw new Error('Gagal melakukan fetch setelah beberapa percobaan.');
        }

        // Fungsi untuk memperbarui area umpan balik AI
        function updateAiFeedback(message, type = 'info') {
            aiFeedbackArea.classList.remove('correct', 'wrong');
            aiFeedbackArea.innerHTML = ''; 

            if (message === 'loading') {
                aiFeedbackArea.innerHTML = '<div class="spinner"></div><span style="margin-left: 8px;">Mendengarkan...</span>';
            } else if (message) {
                aiFeedbackArea.textContent = message;
                if (type === 'correct') {
                    aiFeedbackArea.classList.add('correct');
                } else if (type === 'wrong') {
                    aiFeedbackArea.classList.add('wrong');
                }
            }
        }

        // --- FITUR 1: Pengenalan Suara (Speech Recognition) ---
        let recognition;
        let isRecognizing = false;
        let hasSpoken = false; // Flag untuk melacak apakah ada suara terdeteksi

        function initializeSpeechRecognition() {
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                showCustomAlert('Maaf, browser Anda tidak mendukung Speech Recognition. Pastikan Anda menggunakan Chrome atau browser modern lainnya.');
                speakAndCheckBtn.disabled = true;
                return;
            }

            // Periksa izin mikrofon secara lebih proaktif
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showCustomAlert('Akses mikrofon tidak tersedia. Pastikan browser Anda memiliki izin untuk mengakses mikrofon di pengaturan sistem Anda.');
                speakAndCheckBtn.disabled = true;
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP'; // Mengatur bahasa ke Jepang
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecognizing = true;
                hasSpoken = false; // Reset flag
                speakAndCheckBtn.innerHTML = '<i class="fa-solid fa-microphone-alt-slash"></i> Berhenti';
                speakAndCheckBtn.classList.add('listening'); // Tambahkan kelas untuk animasi
                updateAiFeedback('loading');
            };

            recognition.onresult = async (event) => {
                hasSpoken = true; // Suara terdeteksi
                const transcript = event.results[0][0].transcript;
                const currentRomaji = deck[currentIndex].romaji;
                console.log(`Anda mengucapkan: ${transcript}, yang seharusnya: ${currentRomaji}`);

                // Kirim transkrip ke Gemini untuk verifikasi
                await verifyPronunciationWithGemini(transcript, currentRomaji);
            };

            recognition.onerror = (event) => {
                isRecognizing = false;
                speakAndCheckBtn.innerHTML = '<i class="fa-solid fa-microphone"></i> Ucapkan & Cek';
                speakAndCheckBtn.classList.remove('listening'); // Hapus animasi
                console.error('Speech recognition error:', event.error);
                // Pesan error spesifik jika izin ditolak atau masalah jaringan
                if (event.error === 'not-allowed') {
                    updateAiFeedback('Akses mikrofon ditolak. Izinkan browser menggunakan mikrofon di pengaturan situs.', 'wrong');
                } else if (event.error === 'network') {
                    updateAiFeedback('Terjadi masalah jaringan saat pengenalan suara. Periksa koneksi internet Anda.', 'wrong');
                } else {
                    updateAiFeedback(`Error pengenalan suara: ${event.error}`, 'wrong');
                }
            };

            recognition.onend = () => {
                isRecognizing = false;
                speakAndCheckBtn.innerHTML = '<i class="fa-solid fa-microphone"></i> Ucapkan & Cek';
                speakAndCheckBtn.classList.remove('listening'); // Hapus animasi

                // Hanya tampilkan pesan 'tidak ada suara' jika onresult belum pernah dipanggil
                if (!hasSpoken && aiFeedbackArea.innerHTML.includes('Mendengarkan...')) {
                    updateAiFeedback('Tidak ada suara terdeteksi atau mikrofon terlalu sunyi. Pastikan izin mikrofon sudah diberikan dan Anda berbicara dengan jelas.', 'wrong');
                }
            };
        }

        async function verifyPronunciationWithGemini(userTranscript, expectedRomaji) {
            // Ubah userTranscript menjadi lowercase untuk perbandingan yang lebih baik
            const cleanUserTranscript = userTranscript.toLowerCase().trim();
            const cleanExpectedRomaji = expectedRomaji.toLowerCase().trim();

            // Verifikasi langsung di klien jika transkrip sama persis dengan romaji yang diharapkan
            if (cleanUserTranscript === cleanExpectedRomaji) {
                updateAiFeedback(`Benar! Pelafalan Anda tepat untuk '${expectedRomaji}'.`, 'correct');
                return; // Tidak perlu memanggil Gemini jika sudah jelas benar
            }
            
            // Jika tidak sama persis, baru kirim ke Gemini untuk analisis lebih lanjut
            const prompt = `Pengguna mencoba mengucapkan karakter Jepang dengan romaji '${expectedRomaji}'. Transkripsi yang dideteksi adalah '${userTranscript}'. Bandingkan transkripsi ini secara ketat dengan romaji yang diharapkan. Jawab 'YA' jika pelafalan **sangat akurat dan mirip persis** dengan romaji yang diharapkan. Jawab 'TIDAK' jika tidak, dan berikan saran singkat dalam bahasa Indonesia mengapa tidak akurat atau cara memperbaikinya (jika 'TIDAK').`;

            try {
                const response = await fetchWithExponentialBackoff(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        ],
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || 'Terjadi kesalahan saat menghubungi API.');
                }

                const result = await response.json();
                let geminiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Tidak dapat memverifikasi pelafalan.';

                if (geminiResponse.toUpperCase().includes('YA')) {
                    updateAiFeedback(`Benar! Pelafalan Anda tepat untuk '${expectedRomaji}'.`, 'correct');
                } else if (geminiResponse.toUpperCase().includes('TIDAK')) {
                    const feedbackMatch = geminiResponse.match(/TIDAK\s*(.*)/i);
                    const feedback = feedbackMatch && feedbackMatch[1].trim() ? feedbackMatch[1].trim() : 'Coba lagi, perhatikan bunyi vokal dan konsonan.';
                    updateAiFeedback(`Salah. ${feedback}`, 'wrong');
                } else {
                    // Fallback jika Gemini tidak mengikuti format YA/TIDAK
                    updateAiFeedback(`Umpan balik AI: ${geminiResponse}`, 'info');
                }

            } catch (error) {
                console.error('Error verifying pronunciation with Gemini:', error);
                updateAiFeedback(`Error verifikasi AI: ${error.message}`, 'wrong');
            }
        }

        // --- FITUR 2: Pembuatan Contoh Kalimat Dinamis ---
        let isFetchingExamples = false;

        async function fetchAIExamples(kana) {
            if (isFetchingExamples) return;

            // Toggle visibility
            const isShowing = aiExamplesSection.classList.contains('show');
            if (isShowing) {
                aiExamplesSection.classList.remove('show');
                aiExamplesBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i> Contoh AI';
                return;
            }

            isFetchingExamples = true;
            aiExamplesSection.innerHTML = `<div class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i> Memuat contoh...</div>`;
            aiExamplesSection.classList.add('show');
            aiExamplesBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i> Sembunyikan Contoh';

            // Cek cache
            if (geminiCache.has(kana)) {
                aiExamplesSection.innerHTML = geminiCache.get(kana);
                isFetchingExamples = false;
                return;
            }

            const prompt = `Berikan 2 contoh kata atau kalimat pendek dalam bahasa Jepang menggunakan karakter '${kana}'. Sertakan juga terjemahan bahasa Indonesianya untuk setiap contoh. Format output sebagai berikut:
[Kalimat Jepang 1]
[Terjemahan Indonesia 1]

[Kalimat Jepang 2]
[Terjemahan Indonesia 2]

Jangan sertakan teks lain, salam, atau penjelasan.`;

            try {
                const response = await fetchWithExponentialBackoff(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        ],
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || 'Terjadi kesalahan saat menghubungi API.');
                }

                const result = await response.json();
                let generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || '';

                if (!generatedText.trim()) {
                    generatedText = 'Tidak dapat menghasilkan contoh. Respons API kosong atau tidak valid.';
                }

                const lines = generatedText.split('\n').filter(line => line.trim() !== '');
                let formattedHtml = '';
                if (lines.length >= 2) {
                    for (let i = 0; i < lines.length; i += 2) {
                        const jpLine = lines[i];
                        const idLine = lines[i+1] || '';
                        if (jpLine) {
                            formattedHtml += `<p style="font-family: 'Noto Sans JP', sans-serif; font-size: 16px; margin-bottom: 4px;">${jpLine}</p>`;
                            if (idLine) {
                                formattedHtml += `<p class="small" style="color: var(--ink); margin-bottom: 12px;">${idLine}</p>`;
                            }
                        }
                    }
                } else {
                    formattedHtml = `<p>Tidak dapat menghasilkan contoh. Format respons tidak sesuai: ${generatedText}</p>`;
                }

                aiExamplesSection.innerHTML = formattedHtml;
                geminiCache.set(kana, formattedHtml); // Simpan ke cache

            } catch (error) {
                console.error('Fetch Error (AI Examples):', error);
                aiExamplesSection.innerHTML = `<p style="color:var(--warn);">Error: ${error.message}. Coba lagi nanti.</p>`;
            } finally {
                isFetchingExamples = false;
            }
        }

        // --- FITUR 3: Sistem Pengulangan Berjarak Sederhana ---
        function markCard(isCorrect) {
            const currentCardIdentifier = deck[currentIndex].kana + deck[currentIndex].romaji;
            if (isCorrect) {
                // Jika benar, hapus dari daftar kartu salah
                if (incorrectCards.has(currentCardIdentifier)) {
                    incorrectCards.delete(currentCardIdentifier);
                }
            } else {
                // Jika salah, tambahkan ke daftar kartu salah (atau perbarui jumlah kesalahan)
                incorrectCards.set(currentCardIdentifier, (incorrectCards.get(currentCardIdentifier) || 0) + 1);
            }
            // Lanjutkan ke kartu berikutnya
            nextCard();
        }

        function createDeck() {
            deck = [];
            currentIndex = 0;
            currentSet = setSelection.value;

            let romajiSet, kanaMap;

            switch(currentSet) {
                case 'hira':
                    romajiSet = [...BASE, ...DAKUON, ...YOUON];
                    kanaMap = HIRA_MAP;
                    break;
                case 'kata':
                    romajiSet = [...BASE, ...DAKUON, ...YOUON];
                    kanaMap = KATA_MAP;
                    break;
                case 'hira_base':
                    romajiSet = BASE;
                    kanaMap = HIRA_MAP;
                    break;
                case 'kata_base':
                    romajiSet = BASE;
                    kanaMap = KATA_MAP;
                    break;
                case 'hira_daku':
                    romajiSet = DAKUON;
                    kanaMap = HIRA_MAP;
                    break;
                case 'kata_daku':
                    romajiSet = DAKUON;
                    kanaMap = KATA_MAP;
                    break;
                case 'hira_you':
                    romajiSet = YOUON;
                    kanaMap = HIRA_MAP;
                    break;
                case 'kata_you':
                    romajiSet = YOUON;
                    kanaMap = KATA_MAP;
                    break;
            }

            romajiSet.forEach(romaji => {
                deck.push({ kana: kanaMap.get(romaji), romaji: romaji });
            });

            shuffleDeck(); // Acak saat deck dibuat atau diubah
        }

        function updateCard() {
            if (deck.length === 0) {
                cardFront.textContent = 'N/A';
                cardBack.textContent = 'N/A';
                cardCounter.textContent = '0 / 0';
                return;
            }

            const card = deck[currentIndex];
            cardFront.textContent = card.kana;
            cardBack.textContent = card.romaji;
            cardCounter.textContent = `${currentIndex + 1} / ${deck.length}`;
            
            // Reset flip state
            flashcard.classList.remove('is-flipped');
            // Sembunyikan contoh AI saat kartu berubah
            if (aiExamplesSection.classList.contains('show')) {
                aiExamplesSection.classList.remove('show');
                aiExamplesBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i> Contoh AI';
            }
            updateAiFeedback(''); // Bersihkan feedback pelafalan
        }

        function nextCard() {
            currentIndex = (currentIndex + 1) % deck.length;
            updateCard();
        }

        function prevCard() {
            currentIndex = (currentIndex - 1 + deck.length) % deck.length;
            updateCard();
        }

        function shuffleDeck() {
            // Gabungkan kartu yang salah kembali ke deck utama untuk dipelajari lagi, dengan prioritas lebih tinggi (sederhana)
            let tempDeck = [...deck]; // Buat salinan deck asli

            Array.from(incorrectCards.keys()).forEach(identifier => {
                const originalCard = deck.find(card => (card.kana + card.romaji) === identifier);
                if (originalCard) {
                    // Tambahkan kartu yang salah ke bagian awal tempDeck agar muncul lebih cepat
                    for(let i=0; i < incorrectCards.get(identifier); i++) { // Lebih sering jika salah berkali-kali
                        tempDeck.unshift(originalCard);
                    }
                }
            });

            // Acak tempDeck
            for (let i = tempDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tempDeck[i], tempDeck[j]] = [tempDeck[j], tempDeck[i]];
            }
            deck = tempDeck; // Perbarui deck utama dengan deck yang sudah diacak (termasuk kartu salah)

            currentIndex = 0;
            updateCard();
        }

        // Fungsi alert kustom (menggantikan window.alert)
        function showCustomAlert(message) {
            const alertBox = document.createElement('div');
            alertBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: var(--panel);
                color: var(--ink);
                padding: 20px;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                z-index: 1000;
                text-align: center;
                border: 1px solid var(--border);
                max-width: 80%;
            `;
            alertBox.innerHTML = `
                <p>${message}</p>
                <button style="
                    background-color: var(--pri);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    margin-top: 15px;
                    font-weight: 500;
                ">OK</button>
            `;
            document.body.appendChild(alertBox);

            alertBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(alertBox);
            });
        }


        // Event Listeners
        flashcard.addEventListener('click', () => {
            flashcard.classList.toggle('is-flipped');
        });

        nextBtn.addEventListener('click', nextCard);
        prevBtn.addEventListener('click', prevCard);
        
        setSelection.addEventListener('change', createDeck);
        shuffleBtn.addEventListener('click', shuffleDeck);

        speakAndCheckBtn.addEventListener('click', () => {
            if (isRecognizing) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        aiExamplesBtn.addEventListener('click', () => {
            if (deck.length > 0) {
                fetchAIExamples(deck[currentIndex].kana);
            } else {
                showCustomAlert('Tidak ada kartu di dek untuk menghasilkan contoh.');
            }
        });

        markCorrectBtn.addEventListener('click', () => markCard(true));
        markIncorrectBtn.addEventListener('click', () => markCard(false));

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') {
                nextCard();
            } else if (e.key === 'ArrowLeft') {
                prevCard();
            } else if (e.key === ' ') { // Spasi untuk membalik kartu
                e.preventDefault();
                flashcard.click();
            }
        });

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', () => {
            createDeck();
            initializeSpeechRecognition();
            
            // Sidebar wiring
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            const closeBtn  = document.getElementById('closeSidebar');

            function openSidebar(){ sidebar.classList.add('is-open'); document.body.classList.add('sidebar-open'); }
            function closeSidebar(){ sidebar.classList.remove('is-open'); document.body.classList.remove('sidebar-open'); }

            toggleBtn?.addEventListener('click', openSidebar);
            closeBtn?.addEventListener('click', closeSidebar);
            // Tutup jika klik di luar (mobile)
            document.addEventListener('click', (e)=>{
                if(!sidebar.classList.contains('is-open')) return;
                // Check if the click is outside the sidebar AND outside the toggle button
                const isClickInsideSidebar = sidebar.contains(e.target);
                const isClickInsideToggleBtn = toggleBtn.contains(e.target);
                if(!isClickInsideSidebar && !isClickInsideToggleBtn) {
                    closeSidebar();
                }
            });

            // Set active link sesuai file saat ini
            document.querySelectorAll('#sidebar a').forEach(a=>{
                const href = a.getAttribute('href');
                if(href && location.pathname.endsWith(href)) a.classList.add('active');
            });

            // Aksesibilitas: ESC untuk tutup
            document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSidebar(); });
        });
    </script>
</body>
</html>
