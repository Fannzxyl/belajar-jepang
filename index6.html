<!DOCTYPE html>
<html lang="id" data-theme="pastel">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Latihan Menulis Kana — Pelatih Jepang</title>
    <meta name="description" content="Latih goresan Hiragana dan Katakana Anda dengan kanvas menulis interaktif. Gunakan panduan untuk meniru bentuk dan simpan hasil karya Anda." />
    <meta name="theme-color" content="#7a6cff">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Menggunakan style yang sama dari file lain untuk konsistensi */
        :root{
            --bg:#f8fbff; --panel:#ffffff; --soft:#f2f6ff; --ink:#132030; --muted:#76849c;
            --pri:#7a6cff; --sec:#16c6a1; --warn:#ff7b7b; --ok:#2fb875; --accent:#ffd166;
            --btn:#e9eefc; --btnText:#0b101a; --border:rgba(19,32,48,.10);
            --radius:18px; --shadow:0 6px 18px rgba(15,23,34,.08);
            --ring: 0 0 0 3px rgba(122,108,255,.28);
            --iconColor: var(--muted);
            --transition-duration: 0.2s;
        }
        [data-theme="hc"]{
            --bg:#0a0f1a; --panel:#0f1626; --soft:#0c1220; --ink:#e6efff; --muted:#9fb0cc;
            --pri:#8fa8ff; --sec:#3dd8b5; --warn:#ff8c8c; --ok:#7be0b3; --accent:#ffd98a;
            --btn:#18243a;
            --btnText:#e6efff;
            --border:rgba(230,239,255,.12);
            --ring: 0 0 0 3px rgba(143,168,255,.35);
            --iconColor: var(--ink);
        }
        *{box-sizing:border-box}
        html, body { max-width: 100%; overflow-x: hidden; }
        body {
            min-height: 100svh;
            margin:0;font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:
            radial-gradient(900px 420px at -10% -20%, rgba(122,108,255,.10), transparent),
            radial-gradient(900px 420px at 110% -30%, rgba(22,198,161,.12), transparent),
            var(--bg);color:var(--ink);
            transition: background-color var(--transition-duration) ease-out, color var(--transition-duration) ease-out;
        }
        .wrap{
            max-width: 960px;
            margin: auto;
            padding: 16px;
            padding-left: calc(16px + env(safe-area-inset-left));
            padding-right: calc(16px + env(safe-area-inset-right));
        }
        header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));backdrop-filter: blur(8px);border-bottom:1px solid var(--border); padding-top:env(safe-area-inset-top);
        transition: background var(--transition-duration) ease-out, backdrop-filter var(--transition-duration) ease-out, border-bottom-color var(--transition-duration) ease-out;}
        [data-theme="hc"] header{background:linear-gradient(180deg, rgba(15,22,38,.86), rgba(15,22,38,.66))}
        
        .brand{ display:flex; align-items:center; gap:12px; justify-content: space-between; flex-wrap: wrap; }
        .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--sec));box-shadow:var(--shadow);
        transition: box-shadow var(--transition-duration) ease-out, background var(--transition-duration) ease-out;}
        h1{font-size:20px;margin:0}
        .small{font-size:12px;color:var(--muted)}
        .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;border:1px solid var(--border);
        transition: background-color var(--transition-duration) ease-out, border-color var(--transition-duration) ease-out, box-shadow var(--transition-duration) ease-out;}
        .card h2{font-size:16px;margin:0 0 10px 0; display: flex; align-items: center; gap: 8px;}
        .card h2 .icon { color: var(--iconColor); transition: color var(--transition-duration) ease-out;}
        .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
        .btn{ min-height:52px; padding: 0 16px; border-radius: 12px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all var(--transition-duration) ease-out; color: var(--ink); background: var(--btn); display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
        .btn:active{transform:translateY(1px)}
        .btn.primary{ background:linear-gradient(135deg, var(--pri), var(--sec)); color:white; }
        .btn.ghost{background:transparent;outline:1px solid var(--border); color: var(--ink);}
        .btn.ok{ background:var(--okBg); color:var(--ink); }
        .btn.warn{ background:var(--warnBg); color:var(--ink); }
        .btn:focus-visible{outline:none; box-shadow:var(--ring); outline-offset: 3px;}
        .spacer{height:16px}
        /* Sembunyikan nav/header lama kalau ada */
        .main-nav{ display:none !important; }

        select{ width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--soft);color:var(--ink); transition: border-color var(--transition-duration) ease-out, background-color var(--transition-duration) ease-out, box-shadow var(--transition-duration) ease-out; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2376849c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 36px; }
        select:focus { border-color: var(--pri); outline: none; box-shadow: var(--ring); }

        /* Style khusus untuk Latihan Menulis */
        .writer-toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
        .writer-toolbar .slider { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted) }
        .writer-wrap { position: relative; width: 100%; border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); background: var(--soft); overflow: hidden; }
        #writerCanvas { position: relative; z-index: 1; background: transparent; width: 100%; height: auto; display:block; touch-action: none; }
        .writer-wrap.grid {
            background-image:
                repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent 24px),
                repeating-linear-gradient(90deg, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 1px, transparent 24px);
        }
        [data-theme="hc"] .writer-wrap.grid {
            background-image:
                repeating-linear-gradient(0deg, rgba(230,239,255,.15) 0, rgba(230,239,255,.15) 1px, transparent 1px, transparent 24px),
                repeating-linear-gradient(90deg, rgba(230,239,255,.15) 0, rgba(230,239,255,.15) 1px, transparent 1px, transparent 24px);
        }
        .writer-ghost {
            position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center;
            font-size: clamp(200px, 55vw, 380px);
            line-height:1; user-select:none;
            color: var(--muted);
            opacity: .12;
            filter: saturate(70%);
            z-index: 0; 
            pointer-events: none;
            transition: opacity var(--transition-duration) ease-out;
        }
        .writer-ghost.hidden { display:none; }

        /* === Sidebar === */
        .sidebar{
            position:fixed; top:0; left:-300px; width:280px; height:100%;
            background:var(--panel); box-shadow:var(--shadow); z-index:1000;
            transition:left .3s ease-in-out; padding:20px; padding-top:calc(20px + env(safe-area-inset-top));
            display:flex; flex-direction:column; gap:10px; overflow-y:auto; border-right:1px solid var(--border);
        }
        .sidebar.is-open{ left:0; }
        .sidebar .menu{ list-style:none; margin:0; padding:0; }
        .sidebar .menu li a{
            display:flex; gap:.5rem; align-items:center; padding:.75rem 1rem;
            border-radius:12px; color:var(--ink); text-decoration:none;
        }
        .sidebar .menu li a:hover{ background:var(--soft); }
        .sidebar .menu li a.active{ background:rgba(122,108,255,.12); font-weight:600; }

        /* Toggle button */
        .sidebar-toggle-btn{
            position:fixed; top:16px; left:16px; z-index:1001; background:var(--btn);
            border:1px solid var(--border); border-radius:50%; width:44px; height:44px;
            display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow);
            transition: all 0.3s ease-in-out; /* Added transition for smooth movement */
        }
        .sidebar-toggle-btn i{ color:var(--ink); font-size:20px; }

        @media (min-width:768px){ 
            body.sidebar-open{ padding-left:280px; } 
            .sidebar-toggle-btn { left: 16px; } /* Stays on the left */
            .sidebar.is-open + .sidebar-toggle-btn { left: 296px; } /* Moves with the sidebar */
        }
        @media (max-width:640px){ .sidebar{ width:84vw; max-width:320px; } }

        /* Amanin layout */
        header .brand{ position:relative; z-index:1002; padding-left:60px; }
        @media (max-width:767px){
            header .brand{ padding-left:0; }
            .sidebar-toggle-btn{ top:calc(16px + env(safe-area-inset-top)); }
        }
    </style>
</head>
<body>
    <!-- Toggle Button (burger) -->
    <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle Sidebar">
        <i class="fa-solid fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
        <div class="row" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">Navigasi</h3>
            <button class="btn ghost" id="closeSidebar" aria-label="Tutup Sidebar">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <hr style="border:none;border-top:1px solid var(--border);width:100%;">
        <ul class="menu">
            <li><a href="index.html">📘 Latihan</a></li>
            <li><a href="index2.html">🗂️ Flashcard</a></li>
            <li><a href="index3.html">🧮 Tabel Kana</a></li>
            <li><a href="index4.html">🗒️ Kosakata</a></li>
            <li><a href="index5.html">💬 Ungkapan</a></li>
            <li><a href="index6.html">✍️ Menulis</a></li>
        </ul>
    </nav>

    <header>
        <div class="wrap">
            <div class="brand">
                <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="36" height="36">
                    <defs>
                        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                            <stop stop-color="#7a6cff"/><stop offset="1" stop-color="#16c6a1"/>
                        </linearGradient>
                    </defs>
                    <rect width="64" height="64" rx="14" fill="url(#g)"/>
                    <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle"
                          font-family="Noto Sans JP, 'Noto Serif JP', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"
                          font-size="38" fill="white" dy="-2">あ</text>
                </svg>
                <div>
                    <h1>Pelatih Kana Jepang</h1>
                    <div class="small">Latihan Menulis</div>
                </div>
            </div>
             <!-- NAVIGASI UTAMA (LAMA - TERSEMBUNYI) -->
             <nav class="main-nav">
                <div class="row">
                    <a href="index.html" class="btn ghost"><i class="fa-solid fa-home"></i> Latihan</a>
                    <a href="index2.html" class="btn ghost"><i class="fa-solid fa-clone"></i> Flashcard</a>
                    <a href="index3.html" class="btn ghost"><i class="fa-solid fa-table"></i> Tabel Kana</a>
                    <a href="index4.html" class="btn ghost"><i class="fa-solid fa-book-open"></i> Kosakata</a>
                    <a href="index5.html" class="btn ghost"><i class="fa-solid fa-comments"></i> Ungkapan</a>
                    <a href="index6.html" class="btn primary"><i class="fa-solid fa-pen-fancy"></i> Menulis</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="wrap">
        <div class="card">
            <h2 id="writerTitle"><i class="fa-solid fa-pen-fancy icon"></i> Latihan Menulis (Hiragana/Katakana)</h2>
            <div class="small">Gambar huruf dengan jari/mouse. Nyalakan <b>Panduan</b> untuk meniru bentuk.</div>
            <div class="spacer"></div>

            <div class="row" style="align-items:flex-end">
                <select id="writeSet" aria-label="Pilih set tulis">
                    <option value="hira">Hiragana</option>
                    <option value="kata">Katakana</option>
                </select>
                <select id="writeKana" aria-label="Pilih kana"></select>
                <button class="btn" id="writePrev" type="button" title="Sebelumnya"><i class="fa-solid fa-chevron-left"></i></button>
                <button class="btn" id="writeNext" type="button" title="Berikutnya"><i class="fa-solid fa-chevron-right"></i></button>
                <button class="btn" id="writeRand" type="button" title="Acak"><i class="fa-solid fa-shuffle"></i></button>
                <button class="btn" id="writeSpeak" type="button" title="Dengar pelafalan kana"><i class="fa-solid fa-volume-up"></i></button>
            </div>

            <div class="spacer"></div>

            <div class="writer-toolbar">
                <button class="btn ok" id="penBtn" type="button"><i class="fa-solid fa-pen"></i> Pena</button>
                <button class="btn" id="eraserBtn" type="button"><i class="fa-solid fa-eraser"></i> Penghapus</button>
                <div class="slider">
                    <label for="penSize">Ukuran</label>
                    <input id="penSize" type="range" min="2" max="28" value="10" style="width:140px">
                </div >
                <label class="btn ghost" style="gap:8px">
                    <input id="gridToggle" type="checkbox"> Grid
                </label>
                <label class="btn ghost" style="gap:8px">
                    <input id="ghostToggle" type="checkbox"> Panduan
                </label>
                <div style="flex:1"></div>
                <button class="btn" id="undoStroke" type="button" title="Undo (Ctrl+Z)"><i class="fa-solid fa-undo"></i></button>
                <button class="btn warn" id="clearCanvas" type="button"><i class="fa-solid fa-redo"></i></button>
                <button class="btn primary" id="savePNG" type="button"><i class="fa-solid fa-download"></i> Simpan PNG</button>
            </div>

            <div class="spacer"></div>

            <div id="writerWrap" class="writer-wrap grid">
                <canvas id="writerCanvas" width="900" height="900" aria-label="Kanvas menulis"></canvas>
                <div id="writerGhost" class="writer-ghost" aria-hidden="true">あ</div>
            </div>
            <div class="small center" style="margin-top: 8px;">Tips: Tarik cepat untuk garis tipis, pelan untuk lebih tebal.</div>
        </div>
    </main>

    <script>
        // DATA KANA
        const BASE = ['a','i','u','e','o','ka','ki','ku','ke','ko','sa','shi','su','se','so','ta','chi','tsu','te','to','na','ni','nu','ne','no','ha','hi','fu','he','ho','ma','mi','mu','me','mo','ya','yu','yo','ra','ri','ru','re','ro','wa','wo','n'];
        const DAKUON = ['ga','gi','gu','ge','go','za','ji','zu','ze','zo','da','dji','dzu','de','do','ba','bi','bu','be','bo','pa','pi','pu','pe','po'];
        const YOUON = ['kya','kyu','kyo','sha','shu','sho','cha','chu','cho','nya','nyu','nyo','hya','hyu','hyo','mya','myu','myo','rya','ryu','ryo','gya','gyu','gyo','ja','ju','jo','bya','byu','byo','pya','pyu','pyo'];
        const HIRA_BASE = ['あ','い','う','え','お','か','き','く','け','こ','さ','し','す','せ','そ','た','ち','つ','て','と','な','に','ぬ','ね','の','は','ひ','ふ','へ','ほ','ま','み','む','め','も','や','ゆ','よ','ら','り','る','れ','ろ','わ','を','ん'];
        const KATA_BASE = ['ア','イ','ウ','エ','オ','カ','キ','ク','ケ','コ','サ','シ','ス','セ','ソ','タ','チ','ツ','テ','ト','ナ','ニ','ヌ','ネ','ノ','ハ','ヒ','フ','ヘ','ホ','マ','ミ','ム','メ','モ','ヤ','ユ','ヨ','ラ','リ','ル','レ','ロ','ワ','ヲ','ン'];
        const HIRA_DAKU = ['が','ぎ','ぐ','げ','ご','ざ','じ','ず','ぜ','ぞ','だ','ぢ','づ','で','ど','ば','び','ぶ','べ','ぼ','ぱ','ぴ','ぷ','ぺ','ぽ'];
        const KATA_DAKU = ['ガ','ギ','グ','ゲ','ゴ','ザ','ジ','ズ','ゼ','ゾ','ダ','ヂ','ヅ','デ','ド','バ','ビ','ブ','ベ','ボ','パ','ピ','プ','ペ','ポ'];
        const HIRA_YOU = ['きゃ','きゅ','きょ','しゃ','しゅ','しょ','ちゃ','ちゅ','ちょ','にゃ','にゅ','にょ','ひゃ','ひゅ','ひょ','みゃ','みゅ','みょ','りゃ','りゅ','りょ','ぎゃ','ぎゅ','ぎょ','じゃ','じゅ','じょ','びゃ','びゅ','びょ','ぴゃ','ぴゅ','ぴょ'];
        const KATA_YOU = ['キャ','キュ','キョ','シャ','シュ','ショ','チャ','チュ','チョ','ニャ','ニュ','ニョ','ヒャ','ヒュ','ヒョ','ミャ','ミュ','ミョ','リャ','リュ','リョ','ギャ','ギュ','ギョ','ジャ','ジュ','ジョ','ビャ','ビュ','ビョ','ピャ','ピュ','ピョ'];
        const HIRA_MAP = new Map();
        const KATA_MAP = new Map();
        BASE.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_BASE[i]);KATA_MAP.set(r,KATA_BASE[i])});
        DAKUON.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_DAKU[i]);KATA_MAP.set(r,KATA_DAKU[i])});
        YOUON.forEach((r,i)=>{HIRA_MAP.set(r,HIRA_YOU[i]);KATA_MAP.set(r,KATA_YOU[i])});
        const ALL_ROMAJI = [...new Set([...BASE,...DAKUON,...YOUON])];

        // UI HELPERS
        const qs = (s,el=document)=>el.querySelector(s);
        function bind(selector, eventType, handler, options) {
            const element = qs(selector);
            if (element) {
                element.addEventListener(eventType, handler, options);
            }
        }

        // STATE (simplified for this page)
        const KEY = 'kanaTrainer_v9';
        let state = {
            theme: 'pastel',
            writer: {
                set: 'hira',
                kana: 'a',
                penSize: 10,
                eraser: false,
                grid: true,
                ghost: true,
                ghostOpacity: 0.12,
            }
        };

        function loadState() {
            try {
                const raw = localStorage.getItem(KEY);
                if (raw) {
                    const loaded = JSON.parse(raw);
                    // Hanya ambil state yang relevan
                    if (loaded.theme) state.theme = loaded.theme;
                    if (loaded.writer) state.writer = { ...state.writer, ...loaded.writer };
                }
            } catch(e) {
                console.error("Gagal memuat state:", e);
            }
        }
        function saveState() {
             try {
                const raw = localStorage.getItem(KEY);
                const fullState = raw ? JSON.parse(raw) : {};
                fullState.theme = state.theme;
                fullState.writer = state.writer;
                localStorage.setItem(KEY, JSON.stringify(fullState));
            } catch(e) {
                console.error("Gagal menyimpan state:", e);
            }
        }
        
        // THEME
        function applyTheme(){
            document.documentElement.setAttribute('data-theme', state.theme==='hc'?'hc':'pastel');
            if (typeof writerSetGhostChar === 'function') writerSetGhostChar();
            if (typeof writerRedrawAll === 'function') writerRedrawAll();
        }

        // AUDIO
        function speak(text){
            try{
                if(!('speechSynthesis' in window)) return;
                speechSynthesis.cancel();
                const u=new SpeechSynthesisUtterance(text);
                u.lang='ja-JP';
                u.rate=.9;
                speechSynthesis.speak(u);
            }catch(error){ console.error('Gagal memutar audio:', error); }
        }

        // WRITER LOGIC
        let wCanvas, wCtx, wWrap, wGhost, isDrawing=false, lastX=0, lastY=0, dpr=1;
        const wStrokes = [];
        let _writerBound = false;

        function writerInitDOMRefs() {
            wCanvas = qs('#writerCanvas');
            wWrap   = qs('#writerWrap');
            wGhost  = qs('#writerGhost');
            wCtx    = wCanvas?.getContext('2d'); 
        }
        function writerSetupCanvasSize() {
            if (!wCanvas || !wWrap || !wCtx) return;
            const rect = wWrap.getBoundingClientRect();
            if (rect.width === 0) {
                requestAnimationFrame(writerSetupCanvasSize);
                return;
            }
            dpr = window.devicePixelRatio || 1;
            const size = Math.floor(rect.width);
            wCanvas.style.width = size + 'px';
            wCanvas.style.height = size + 'px';
            wCanvas.width  = Math.floor(size * dpr);
            wCanvas.height = Math.floor(size * dpr);
            wCtx.setTransform(1,0,0,1,0,0);
            wCtx.scale(dpr, dpr);
            writerRedrawAll();
        }
        function writerCurrentChar() {
            const r = state.writer.kana;
            return state.writer.set==='hira' ? HIRA_MAP.get(r) : KATA_MAP.get(r);
        }
        function writerSetGhostChar() {
            if (!wGhost) return;
            const ch = writerCurrentChar() || 'あ';
            wGhost.textContent = ch;
            wGhost.style.opacity = state.writer.ghost ? state.writer.ghostOpacity : 0;
            wGhost.classList.toggle('hidden', !state.writer.ghost);
        }
        function writerSetGrid(on) { if (wWrap) wWrap.classList.toggle('grid', !!on); }
        function writerStrokeStyle() {
            if (!wCtx) return;
            wCtx.globalAlpha = 1;
            wCtx.lineCap = 'round';
            wCtx.lineJoin = 'round';
            wCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim();
            wCtx.globalCompositeOperation = state.writer.eraser ? 'destination-out' : 'source-over';
            wCtx.lineWidth = state.writer.penSize;
        }
        function writerPointerPos(e) {
            if (!wCanvas) return {x:0, y:0};
            const rect = wCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            return { x: Math.max(0, Math.min(rect.width, x)), y: Math.max(0, Math.min(rect.height, y)) };
        }
        function writerStart(e) {
            if (!wCanvas) return;
            e.preventDefault();
            const p = writerPointerPos(e);
            isDrawing = true;
            lastX = p.x; lastY = p.y;
            wStrokes.push({ ops: state.writer.eraser ? 'destination-out' : 'source-over', size: state.writer.penSize, points: [{x:lastX, y:lastY}] });
        }
        function writerMove(e) {
            if(!isDrawing || !wCtx) return;
            const p = writerPointerPos(e);
            writerStrokeStyle();
            wCtx.beginPath();
            wCtx.moveTo(lastX, lastY);
            wCtx.lineTo(p.x, p.y);
            wCtx.stroke();
            lastX = p.x; lastY = p.y;
            const s = wStrokes[wStrokes.length-1];
            if (s && s.points) s.points.push({x:p.x, y:p.y});
        }
        function writerEnd() {
            isDrawing=false;
        }
        function writerRedrawAll() {
            if(!wCtx || !wCanvas) return;
            wCtx.setTransform(1,0,0,1,0,0);
            wCtx.clearRect(0,0,wCanvas.width,wCanvas.height);
            wCtx.scale(dpr, dpr);
            wCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--soft').trim();
            wCtx.fillRect(0, 0, wCanvas.width, wCanvas.height);
            for(const s of wStrokes){
                wCtx.globalCompositeOperation = s.ops;
                wCtx.lineWidth = s.size;
                wCtx.lineCap='round'; wCtx.lineJoin='round';
                wCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim();
                wCtx.beginPath();
                if (s.points.length > 0) {
                    wCtx.moveTo(s.points[0].x, s.points[0].y);
                    for(let i=1;i<s.points.length;i++) wCtx.lineTo(s.points[i].x, s.points[i].y);
                }
                wCtx.stroke();
            }
        }
        function writerUndo() { if(!wStrokes.length) return; wStrokes.pop(); writerRedrawAll(); }
        function writerClear() { wStrokes.length = 0; writerRedrawAll(); }
        function writerSavePNG() {
            if (!wCanvas) return;
            const tmp = document.createElement('canvas');
            tmp.width = wCanvas.width; tmp.height = wCanvas.height;
            const tctx = tmp.getContext('2d');
            if (!tctx) return;
            tctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim();
            tctx.fillRect(0,0,tmp.width,tmp.height);
            tctx.drawImage(wCanvas, 0, 0);
            const url = tmp.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url; a.download = `kana-${state.writer.kana}-${state.writer.set}.png`; a.click(); URL.revokeObjectURL(a.href);
        }
        function writerFillKanaOptions() {
            const sel = qs('#writeKana');
            if (!sel) return;
            sel.innerHTML = '';
            ALL_ROMAJI.forEach(r=>{
                const map = state.writer.set==='hira' ? HIRA_MAP : KATA_MAP;
                const o = new Option(`${r.toUpperCase()} — ${map.get(r)}`, r);
                sel.add(o);
            });
            sel.value = state.writer.kana;
        }
        function writerApplyUIFromState() {
            if (!wCanvas) return;
            if (qs('#writeSet')) qs('#writeSet').value = state.writer.set;
            if (qs('#penSize')) qs('#penSize').value = state.writer.penSize;
            if (qs('#gridToggle')) qs('#gridToggle').checked = state.writer.grid;
            if (qs('#ghostToggle')) qs('#ghostToggle').checked = state.writer.ghost;
            if (state.writer.eraser) {
                qs('#eraserBtn')?.classList.add('ok');
                qs('#penBtn')?.classList.remove('ok');
            } else {
                qs('#penBtn')?.classList.add('ok');
                qs('#eraserBtn')?.classList.remove('ok');
            }
            writerSetGhostChar();
            writerFillKanaOptions();
            writerSetGrid(state.writer.grid);
            writerSetupCanvasSize();
            writerRedrawAll();
        }
        function writerPick(offset) {
            const idx = ALL_ROMAJI.indexOf(state.writer.kana);
            const next = (idx + offset + ALL_ROMAJI.length) % ALL_ROMAJI.length;
            state.writer.kana = ALL_ROMAJI[next];
            saveState();
            writerFillKanaOptions();
            writerSetGhostChar();
        }
        function writerRandom() {
            state.writer.kana = ALL_ROMAJI[Math.floor(Math.random()*ALL_ROMAJI.length)];
            saveState();
            writerFillKanaOptions();
            writerSetGhostChar();
        }
        function writerBindEvents() {
            if (_writerBound) return;
            _writerBound = true;
            if (wCanvas) {
                wCanvas.addEventListener('pointerdown', writerStart);
                wCanvas.addEventListener('pointermove', writerMove);
                window.addEventListener('pointerup', writerEnd);
            }
            bind('#writeSet', 'change', (e)=>{ state.writer.set=e.target.value; saveState(); writerFillKanaOptions(); writerSetGhostChar(); writerClear(); });
            bind('#writeKana', 'change', (e)=>{ state.writer.kana=e.target.value; saveState(); writerSetGhostChar(); writerClear(); });
            bind('#writePrev', 'click', ()=>{ writerPick(-1); writerClear(); });
            bind('#writeNext', 'click', ()=>{ writerPick(1); writerClear(); });
            bind('#writeRand', 'click', ()=>{ writerRandom(); writerClear(); });
            bind('#writeSpeak', 'click', ()=>{ speak(writerCurrentChar()); });
            bind('#penSize', 'input', (e)=>{ state.writer.penSize = parseInt(e.target.value,10)||10; saveState(); });
            bind('#gridToggle', 'change', (e)=>{ state.writer.grid = e.target.checked; saveState(); writerSetGrid(state.writer.grid); writerRedrawAll(); });
            bind('#ghostToggle', 'change', (e)=>{ state.writer.ghost = e.target.checked; saveState(); writerSetGhostChar(); });
            bind('#penBtn', 'click', ()=>{ state.writer.eraser=false; saveState(); qs('#penBtn')?.classList.add('ok'); qs('#eraserBtn')?.classList.remove('ok'); });
            bind('#eraserBtn', 'click', ()=>{ state.writer.eraser=true; saveState(); qs('#eraserBtn')?.classList.add('ok'); qs('#penBtn')?.classList.remove('ok'); });
            bind('#undoStroke', 'click', writerUndo);
            bind('#clearCanvas', 'click', writerClear);
            bind('#savePNG', 'click', writerSavePNG);
            document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); writerUndo(); } });
            window.addEventListener('resize', writerSetupCanvasSize);
        }
        function writerInit() {
            writerInitDOMRefs();
            writerBindEvents();
            writerApplyUIFromState();
        }

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            applyTheme();
            writerInit();
        });

        // --- SIDEBAR JS ---
        (() => {
            const sidebar  = document.getElementById('sidebar');
            const toggle   = document.getElementById('sidebarToggle');
            const closeBtn = document.getElementById('closeSidebar');

            function open(){ sidebar.classList.add('is-open'); document.body.classList.add('sidebar-open'); }
            function close(){ sidebar.classList.remove('is-open'); document.body.classList.remove('sidebar-open'); }

            toggle?.addEventListener('click', open);
            closeBtn?.addEventListener('click', close);

            // Klik luar = tutup (mobile)
            document.addEventListener('click', (e)=>{
                if(!sidebar.classList.contains('is-open')) return;
                const hit = sidebar.contains(e.target) || toggle.contains(e.target);
                if(!hit) close();
            });
            // ESC = tutup
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

            // Tandai link aktif sesuai pathname
            document.querySelectorAll('#sidebar a').forEach(a=>{
                const href = a.getAttribute('href');
                // Use endsWith for robustness with different base paths
                if(href && location.pathname.endsWith(href)) {
                    a.classList.add('active');
                } else {
                    a.classList.remove('active'); // Ensure other links are not active
                }
            });
        })();
    </script>
</body>
</html>
